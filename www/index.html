<!DOCTYPE html>
<html ng-app="jassa.demo.map.ol.basic" ng-controller="gemCtrl">

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="format-detection" content="telephone=no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="css/gem.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />

    <link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="bower_components/angular-snap/angular-snap.css" />

    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/ng-grid/ng-grid.css" />
    <link rel="stylesheet" href="bower_components/jassa-ui-angular/jassa-ui-angular.css" />
    <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
    <!-- endbower -->


    <script src="bower_components/jscache/cache.js"></script>


    <!-- bower:js -->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/jassa/jassa.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/angular-ui-bootstrap-bower/ui-bootstrap-tpls.js"></script>
    <script src="bower_components/ng-grid/build/ng-grid.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="bower_components/jquery-ui/ui/jquery-ui.js"></script>
    <script src="bower_components/angular-ui-sortable/sortable.js"></script>
    <script src="bower_components/angular-ui-utils/ui-utils.js"></script>
    <script src="bower_components/jassa-ui-angular/jassa-ui-angular-tpls.js"></script>
    <script src="bower_components/leaflet/dist/leaflet.js"></script>
    <script src="bower_components/leaflet/dist/leaflet-src.js"></script>
    <script src="bower_components/snapjs/snap.js"></script>
    <script src="bower_components/angular-snap/angular-snap.js"></script>
    <script src="bower_components/bluebird/js/browser/bluebird.js"></script>
    <script src="bower_components/jquery-cookie/jquery.cookie.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <!-- endbower -->

    <script src="bower_components/underscore.string/lib/underscore.string.js"></script>


    <script src="lib/angular-snap/angular-snap.js"></script>
    <script src="lib/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

    <script src="lib/angular-ui/0.10.0/ui-bootstrap-tpls-0.10.0.js"></script>
    <script src="lib/wicket/wicket.js"></script>
    <script src="lib/wicket/wicket-leaflet.js"></script>


    <script src="js/jassa-ui-angular-leaflet-tpls.js"></script>
    <script src="js/sourcemanager/sourcemanager.js"></script>

    <script src="js/jassa-list/jassa-list.js"></script>
    <script src="js/facet-list/facet-list.js"></script>


    <title>GEM - {{bar.value}}</title>
	<script type="text/javascript">
	$(function(){ 
		$("#bottom-drawer").hide();
		$("#bottom-drawer p").css("width",window.innerWidth-80);
	});
	$(window).resize(function () {
		$("#bottom-drawer p").css("width",window.innerWidth-80);	
	});	
	</script>
    <script type="text/javascript">
    _.mixin(_.str.exports());

    $ = jQuery || $;
    jQuery = $;

    jassa = new Jassa(Promise, $.ajax);

    var rdf = jassa.rdf;
    var sparql = jassa.sparql;
    var service = jassa.service;
    var sponate = jassa.sponate;
    var facete = jassa.facete;

    var geo = jassa.geo;

    var vocab = jassa.vocab;

    angular.module('jassa.demo.map.ol.basic', ['ngSanitize', 'ui.bootstrap', 'ui.jassa', 'ui.jassa.leaflet', 'snap', 'ui.jassa.facet-list', 'ui.jassa.jassa-list'])

    .controller('gemCtrl', ['$scope', function($scope) {
        $scope.bar = {"value" : "Filter text here"};

		// Different factories
        var geoMapFactoryVirt = geo.GeoMapFactoryUtils.createWktMapFactory('http://www.w3.org/2003/01/geo/wgs84_pos#geometry', 'bif:st_intersects', 'bif:st_geomFromText');
        var geoMapFactoryAsWktVirt = geo.GeoMapFactoryUtils.createWktMapFactory('http://www.opengis.net/ont/geosparql#asWKT', 'bif:st_intersects', 'bif:st_geomFromText');
        var geoMapFactoryWgs =  geo.GeoMapFactoryUtils.wgs84MapFactory;

        var createSparqlService = function(url, graphUris) {
            var result = service.SparqlServiceBuilder.http(url, graphUris, {type: 'POST'})
                .cache().virtFix().paginate(1000).pageExpand(100).create();

            return result;
        };

        var createMapDataSource = function(sparqlService, geoMapFactory, concept, fillColor) {

            var attrs = {
                fillColor: fillColor,
                fontColor: fillColor,
                strokeColor: fillColor,

                stroke: true,
                strokeLinecap: 'round',
                strokeWidth: 100,
                pointRadius: 12,
                labelAlign: 'cm'
            };

            var result = geo.GeoDataSourceUtils.createGeoDataSourceLabels(sparqlService, geoMapFactory, concept, attrs);
            return result;
        }

        var bounds = new geo.Bounds(7.0, 49.0, 9, 51.0);

		
		// Example with three different factories (should take into consideration for source manager implementation)
        /*
		var sparqlServiceA = createSparqlService('http://akswnc3.informatik.uni-leipzig.de/data/dbpedia/sparql', ['http://dbpedia.org']);
        var sparqlServiceB = createSparqlService('http://linkedgeodata.org/sparql', ['http://linkedgeodata.org']);
        var sparqlServiceC = createSparqlService('http://localhost/data/geolink/sparql', ['http://geolink.aksw.org/']);

        var conceptA = sparql.ConceptUtils.createTypeConcept('http://dbpedia.org/ontology/University');
        var conceptB = sparql.ConceptUtils.createTypeConcept('http://linkedgeodata.org/ontology/Airport');
        var conceptC = sparql.ConceptUtils.createTypeConcept('http://www.linklion.org/ontology#Link');
		
        $scope.dataSources = [
            createMapDataSource(sparqlServiceA, geoMapFactoryVirt, conceptA, '#CC0020'),
            //createMapDataSource(sparqlServiceB, geoMapFactoryWgs, conceptB, '#2000CC')
            //createMapDataSource(sparqlServiceC, geoMapFactoryAsWktVirt, conceptC, '#663300'),
        ];
        */

        $scope.selectGeom = function(data) {
            alert(JSON.stringify(data));
            //console.log('Status', data);
        };

        $scope.mapConfig = {
            center: { lon: 8, lat: 50 },
            zoom: 8
        };

        $scope.setCenter = function() {
            $scope.mapConfig.center = { lon: 20, lat: 20 };
            $scope.mapConfig.zoom = 4;
        };

        $scope.$watch('mapConfig', function(v) {
            console.log('Config changed: ' + JSON.stringify(v));
        }, true);
		
		$scope.dataSources = [];
		var defaultConcept, defaultService;

		$scope.updateDataSources = function(){
			var sources = $.parseJSON(localStorage.sources);
			$scope.dataSources = [];
			$.each(sources, function(key, source){
				var concept = sparql.ConceptUtils.createTypeConcept(source.type);
				if(!defaultConcept) defaultConcept = concept;
				var sparqlService = createSparqlService(source.endpoint, source.graph);
				if(!defaultService) defaultService = sparqlService;
				var dataSource = createMapDataSource(sparqlService, geoMapFactoryWgs, concept, '#CC0020');
				$scope.dataSources.push(dataSource);
			});
		}
		
		$scope.updateDataSources();
        $scope.sparqlService = defaultService;
        $scope.facetTreeConfig = new facete.FacetTreeConfig();

        $scope.facetTreeConfig.getFacetConfig().setBaseConcept(defaultConcept);
        $scope.selectedPath = new facete.Path();
        $scope.selectPath = function(path) {
            $scope.selectedPath = path;
        };

        $scope.facetTreeConfig.getFacetTreeState().getPathExpansions().add(new facete.Path());


        $scope.$watch('facetTreeConfig.getFacetConfig().getConstraintManager();', function() {
            $scope.facetValueConceptService = new facete.FacetValueConceptServiceExact($scope.facetTreeConfig.getFacetConfig());

            $scope.facetValueConceptService.prepareConcept(new facete.Path()).then(function(concept) {
                $scope.dataSources = [ createMapDataSource($scope.sparqlService, geoMapFactoryWgs, concept, '#CC0020') ];
            });
        }, true);

        $scope.path = null;


        var concept = sparql.ConceptUtils.createTypeConcept(defaultConcept);
        var query = new sparql.Query();
        query.setQueryPattern(concept.getElement());
        query.getProject().add(concept.getVar());

        //alert(query);
        $scope.listService = new service.ListServiceSparqlQuery($scope.sparqlService, query, concept.getVar());

        $scope.paginationOptions = {cssClass: 'pagination-sm', maxSize: 3 };
    }]);
    </script>

</head>

<body>
    <div snap-drawer="left">
<!--         <jassa-list list-service="listService" pagination-options="{cssClass: 'pagination-sm', maxSize: 5 }"> -->
<!--             <li ng-repeat="item in items"> -->
<!--             {{item.id}} -->
<!--             </li> -->
<!--         </jassa-list> -->

        <facet-list
            sparql-service="sparqlService"
            facet-tree-config="facetTreeConfig"
            path="path"
            select="selectPath(path)"
            pagination-options="paginationOptions"
        ></facet-list>

        <facet-value-list
            sparql-service="sparqlService"
            facet-tree-config="facetTreeConfig"
            path="selectedPath"
        ></facet-value-list>

        <constraint-list
            sparql-service="sparqlService"
            facet-tree-config="facetTreeConfig"
        ></constraint-list>
    </div>
    <div snap-drawer="right">
      <div id="sources">
          <h2>Sources</h2>
          <ul></ul>
		  <div id="editor"></div>
      </div>
    </div>
    <div id="bottom-drawer">
        <div id="resource-info">
            <p></p>
        </div>
    </div>
    <!-- <div class="app"></div>
    <div id="header">
        <input ng-model="query"> {{query}}
    </div>-->
    <div snap-content snap-options="opts">
        <div id="search-box" class="ui-element">
            <div class="ui-element-content">
                <input ng-model="bar.value" />
            </div>
        </div>
        <snap-dragger="left">
        <div id="drawer-left" class="drawer ui-element" snap-toggle="left">
            <div class="ui-element-content">
                <img src="img/slider_left_icon.png" />
            </div>
        </div>
        </snap-dragger>
        <snap-dragger="right">
        <div id="drawer-right" class="drawer ui-element" snap-toggle="right">
            <div class="ui-element-content">
                <img src="img/slider_right_icon.png" />
            </div>
        </div>
        </snap-dragger>
        <div jassa-map-leaflet="map" style="position: absolute; width: 100%; height: 100%" config="mapConfig" data-sources="dataSources" select="selectGeom(data)" id="map"></div>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
        app.initialize();
    </script>
    <script type="text/javascript" src="js/snap.js"></script>
    <script type="text/javascript">
    var snapper = new Snap({
        element: document.getElementById('content')
    });
    </script>
</body>

</html>

