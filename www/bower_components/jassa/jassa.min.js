var JSONCanonical;(function(){function g(f){return f<10?"0"+f:f}var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,i=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,c,l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;function b(f){i.lastIndex=0;return i.test(f)?'"'+f.replace(i,function(m){var n=l[m];return typeof n==="string"?n:"\\u"+("0000"+m.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function h(u,q){var o,n,w,f,s=j,p,t=q[u];if(t&&typeof t==="object"&&typeof t.toJSON==="function"){t=t.toJSON(u)}if(typeof k==="function"){t=k.call(q,u,t)}switch(typeof t){case"string":return b(t);case"number":return isFinite(t)?String(t):"null";case"boolean":case"null":return String(t);case"object":if(!t){return"null"}j+=c;p=[];if(Object.prototype.toString.apply(t)==="[object Array]"){f=t.length;for(o=0;o<f;o+=1){p[o]=h(o,t)||"null"}w=p.length===0?"[]":j?"[\n"+j+p.join(",\n"+j)+"\n"+s+"]":"["+p.join(",")+"]";j=s;return w}if(k&&typeof k==="object"){f=k.length;for(o=0;o<f;o+=1){if(typeof k[o]==="string"){n=k[o];w=h(n,t);if(w){p.push(b(n)+(j?": ":":")+w)}}}}else{var m=Object.keys(t).sort();for(o in m){n=m[o];if(Object.prototype.hasOwnProperty.call(t,n)){w=h(n,t);if(w){p.push(b(n)+(j?": ":":")+w)}}}}w=p.length===0?"{}":j?"{\n"+j+p.join(",\n"+j)+"\n"+s+"}":"{"+p.join(",")+"}";j=s;return w}}var e=function(o,m,n){var f;j="";c="";if(typeof n==="number"){for(f=0;f<n;f+=1){c+=" "}}else{if(typeof n==="string"){c=n}}k=m;if(m&&typeof m!=="function"&&(typeof m!=="object"||typeof m.length!=="number")){throw new Error("JSON.stringify")}return h("",{"":o})};JSONCanonical={stringify:e}})();var Class=(function(){function m(p){if(!p){return[]}if("toArray" in Object(p)){return p.toArray()}var o=p.length||0,n=new Array(o);while(o--){n[o]=p[o]}return n}var g=function(){};var c="[object Function]";var h=Object.prototype.toString;function f(n){return h.call(n)===c}function l(n){var o=n.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return o.length==1&&!o[0]?[]:o}function j(q,n){var p=q.length,o=n.length;while(o--){q[p+o]=n[o]}return q}function e(n,o){return function(){var p=j([n.bind(this)],arguments);return o.apply(this,p)}}var d=(function(){for(var n in {toString:1}){if(n==="toString"){return false}}return true})();function i(){}function k(){var q=null,p=m(arguments);if(f(p[0])){q=p.shift()}function n(){this.initialize.apply(this,arguments)}_.extend(n,Class.Methods);n.superclass=q;n.subclasses=[];if(q){i.prototype=q.prototype;n.prototype=new i;q.subclasses.push(n)}for(var o=0,s=p.length;o<s;o++){n.addMethods(p[o])}if(!n.prototype.initialize){n.prototype.initialize=g}n.prototype.constructor=n;return n}function b(u){var p=this.superclass&&this.superclass.prototype,o=Object.keys(u);if(d){if(u.toString!=Object.prototype.toString){o.push("toString")}if(u.valueOf!=Object.prototype.valueOf){o.push("valueOf")}}for(var n=0,q=o.length;n<q;n++){var t=o[n],s=u[t];if(p&&f(s)&&l(s)[0]=="$super"){var v=s;s=e((function(w){return function(){return p[w].apply(this,arguments)}})(t),v);s.valueOf=(function(w){return function(){return w.valueOf.call(w)}})(v);s.toString=(function(w){return function(){return w.toString.call(w)}})(v)}this.prototype[t]=s}return this}return{create:k,Methods:{addMethods:b}}})();"use strict";var jassa={vocab:{util:{},xsd:{},rdf:{},rdfs:{},owl:{},wgs84:{}},rdf:{},sparql:{},service:{},i18n:{},sponate:{},facete:{},util:{},client:{},geo:{openlayers:{},leaflet:{}}};var Jassa=jassa;var module;if(!module){module={}}module.exports=jassa;(function(){var b=Jassa.util;b.MapUtils={indexBy:function(d,e,c){c=c||new b.HashMap();var f;if(_(e).isString()){f=function(g){return g[e]}}else{f=e}_(d).each(function(h){var g=f(h);c.put(g,h)});return c}};b.MultiMapUtils={get:function(d,c){return(c in d)?d[c]:[]},put:function(e,d,f){var c;if(d in e){c=e[d]}else{c=[];e[d]=c}c.push(f)},clear:function(d){var c=_(d).keys();_(c).each(function(e){delete d[e]})}};b.MultiMapObjectArray=Class.create({initialize:function(){this.entries={}},clone:function(){var c=new b.MultiMapObjectArray();c.addMultiMap(this);return c},clear:function(){var c=_(this.entries).keys();_(c).each(function(d){delete this.entries[d]})},addMultiMap:function(c){for(var f in c.entries){var d=c.entries[f];for(var e=0;e<d.length;++e){var g=d[e];this.put(f,g)}}},get:function(c){return(c in this.entries)?this.entries[c]:[]},put:function(d,e){var c;if(d in this.entries){c=this.entries[d]}else{c=[];this.entries[d]=c}c.push(e)},removeKey:function(c){delete this.entries[c]}});b.ArrayUtils={addAll:function(c,d){return c.push.apply(c,d)},chunk:function(d,g){var c=[];for(var f=0;f<d.length;f+=g){var e=d.slice(f,f+g);c.push(e)}return c},clear:function(c){while(c.length>0){c.pop()}},replace:function(d,c){this.clear(d);if(c){d.push.apply(d,c)}},filter:function(c,e){var d=_(c).filter(e);this.replace(c,d);return c},indexesOf:function(d,f,e){e=e||b.defaultEquals;var c=[];_(d).each(function(h,g){var i=e(f,h);if(i){c.push(g)}});return c},grep:function(d,e){var c=[];_(d).each(function(h,g){var f=e(h,g);if(f){c.push(g)}});return c},copyWithoutIndexes:function(d,e){var h={};_(e).each(function(i){h[i]=true});var c=[];for(var f=0;f<d.length;++f){var g=h[f];if(!g){c.push(d[f])}}return c},removeIndexes:function(c,d){var e=this.copyWithoutIndexes(c,d);this.replace(c,e);return c},removeByGrep:function(c,e){var d=this.grep(c,e);this.removeIndexes(c,d)}};b.Iterator=Class.create({next:function(){throw"Not overridden"},hasNext:function(){throw"Not overridden"}});b.IteratorAbstract=Class.create(b.Iterator,{initialize:function(){this.current=null;this.advance=true;this.finished=false},finish:function(){this.finished=true;this.close();return null},$prefetch:function(){this.current=this.prefetch()},hasNext:function(){if(this.advance){this.$prefetch();this.advance=false}return this.finished==false},next:function(){if(this.finished){throw"No more elments"}if(this.advance){this.$prefetch()}this.advance=true;return this.current},prefetch:function(){throw"Not overridden"}});b.Entry=Class.create({initialize:function(c,d){this.key=c;this.value=d},getKey:function(){return this.key},getValue:function(){return this.value},toString:function(){return this.key+"->"+this.value}});b.IteratorArray=Class.create(b.Iterator,{initialize:function(d,c){this.array=d;this.offset=c?c:0},getArray:function(){return this.array},hasNext:function(){var c=this.offset<this.array.length;return c},next:function(){var d=this.hasNext();var c;if(d){c=this.array[this.offset];++this.offset}else{c=null}return c}});b.ObjectMap=Class.create({initialize:function(c){this.data=c?c:{}},get:function(c){return this.data[c]},put:function(c,d){this.data[c]=d},remove:function(c){delete this.data[c]},entries:function(){throw"Not implemented"},toString:function(){return JSON.stringify(this.data)}});b.defaultEquals=function(e,d){var c;if(e&&e.equals){c=e.equals(d)}else{if(d&&d.equals){c=d.equals(e)}else{c=_.isEqual(e,d)}}return c};b.defaultHashCode=function(d){var c;if(d&&d.hashCode){c=d.hashCode()}else{c=""+d}return c};b.ListMap=Class.create({initialize:function(c,d){this.map=new b.HashMap(c,d);this.keys=[]},put:function(d,e){var c=this.map.get(d);if(c){throw"Key "+c+" already inserted"}this.keys.push(d);this.map.put(d,e)},get:function(d){var c=this.map.get(d);return c},getByIndex:function(d){var e=this.keys[d];var c=this.map.get(e);return c},entries:function(){var d=this;var c=this.keys.map(function(e){var g=d.map.get(e);var f={key:e,val:g};return f});return c},remove:function(c){throw"Implement me"},removeByIndex:function(c){var d=this.keys[c];this.remove(d)},keyList:function(){return this.keys},size:function(){return this.keys.length}});b.HashMap=Class.create({initialize:function(c,d){this.fnEquals=c?c:b.defaultEquals;this.fnHash=d?d:b.defaultHashCode;this.hashToBucket={}},putAll:function(d){var c=this;_(d.entries()).each(function(e){c.put(e.key,e.val)});return this},put:function(d,g){var f=this.fnHash(d);var h=this.hashToBucket[f];if(h==null){h=[];this.hashToBucket[f]=h}var c=this._indexOfKey(h,d);if(c>=0){h[c].val=g;return}var e={key:d,val:g};h.push(e)},_indexOfKey:function(g,e){if(g!=null){for(var d=0;d<g.length;++d){var f=g[d];var c=f.key;if(this.fnEquals(c,e)){return d}}}return -1},get:function(e){var f=this.fnHash(e);var g=this.hashToBucket[f];var d=this._indexOfKey(g,e);var c=d>=0?g[d].val:null;return c},remove:function(e){var f=this.fnHash(e);var g=this.hashToBucket[f];var d=this._indexOfKey(g,e);var c=d>=0;if(c){g.splice(d,1)}return c},containsKey:function(d){var e=this.fnHash(d);var f=this.hashToBucket[e];var c=this._indexOfKey(f,d)>=0;return c},keyList:function(){var c=[];_.each(this.hashToBucket,function(e){var d=_(e).pluck("key");c.push.apply(c,d)});return c},entries:function(){var c=[];_(this.hashToBucket).each(function(d){c.push.apply(c,d)});return c},toString:function(){var d=this.entries();var e=d.map(function(f){return f.key+": "+f.val});var c="{"+e.join(", ")+"}";return c}});b.HashBidiMap=Class.create({initialize:function(d,e,c){this.forward=new b.HashMap(d,e);this.inverse=c?c:new b.HashBidiMap(d,e,this)},getInverse:function(){return this.inverse},put:function(c,d){this.remove(c);this.forward.put(c,d);this.inverse.forward.put(d,c)},remove:function(d){var c=this.get(d);this.inverse.forward.remove(c);this.forward.remove(d)},getMap:function(){return this.forward},get:function(d){var c=this.forward.get(d);return c},keyList:function(){var c=this.forward.keyList();return c}});b.HashSet=Class.create({initialize:function(c,d){this.map=new b.HashMap(c,d)},add:function(c){this.map.put(c,true)},contains:function(d){var c=this.map.containsKey(d);return c},remove:function(c){this.map.remove(c)},entries:function(){var c=_(this.map.entries()).map(function(d){return d.key});return c},toString:function(){var d=this.entries();var c="{"+d.join(", ")+"}";return c}});b.NestedList=Class.create({classLabel:"jassa.util.NestedList",initialize:function(){this.subLists=[]},getArray:function(){var d=_(this.subLists).each(function(e){return e.getArray()});var c=_(d).flatten(true);return c},contains:function(d){var e=_(this.subLists).find(function(f){var g=f.contains(d);return g});var c=!!e;return c}});b.ArrayList=Class.create({initialize:function(c){this.items=[];this.fnEquals=c||b.defaultEquals},setItems:function(c){this.items=c},getArray:function(){return this.items},get:function(d){var c=this.items[d];return c},add:function(c){this.items.push(c)},indexesOf:function(f){var e=this.items;var d=this.fnEquals;var c=[];_(e).each(function(h,g){var i=d(f,h);if(i){c.push(g)}});return c},contains:function(e){var d=this.indexesOf(e);var c=d.length>0;return c},firstIndexOf:function(e){var d=this.indexesOf(e);var c=(d.length>0)?d[0]:-1;return c},lastIndexOf:function(e){var d=this.indexesOf(e);var c=(d.length>0)?d[d.length-1]:-1;return c},remove:function(d){var c=this.firstIndexOf(d);if(c>=0){this.removeByIndex(c)}},removeByIndex:function(c){this.items.splice(c,1)},size:function(){return this.items.length}});b.CollectionUtils={toggleItem:function(e,d){var c;if(e.contains(d)){e.remove(d);c=false}else{e.add(d);c=true}return c}}})();(function(){var b=Jassa.util;b.TreeUtils={visitDepthFirst:function(e,c,g){var f=g(e);if(f){var d=c(e);_(d).each(function(h){b.TreeUtils.visitDepthFirst(h,c,g)})}},flattenTree:function(f,g,c){if(c==null){c=[]}if(f){c.push(f)}var e=f[g];var d=this;if(e){_(e).each(function(h){d.flattenTree(h,g,c)})}return c}}})();(function(){var b=Jassa.util;b.JsonUtils={stringifyCyclic:function(f,e){var d=[];var c=JSONCanonical.stringify(f,function(g,h){if(_(h).isObject()){if(d.indexOf(h)>=0){return}d.push(h);if(e){h=e(g,h)}}return h});return c}};b.ObjectUtils={hashCode:function(e,d){var c=b.JsonUtils.stringifyCyclic(e,function(h,j){var i=null;if(!d&&_(j).isObject()){var g=_(b.ObjectUtils.defaultHashFnNames).find(function(k){return _(j[k]).isFunction()});var f=j[g];if(f){i=f.apply(j)}else{i=j}}else{i=j}if(d){d=false}return i});return c}};b.ObjectUtils.defaultHashFnNames=["hashCode"]})();(function(){var b=Jassa.util;b.SerializationContext=Class.create({initialize:function(){this._nextId=1;this.objToId=new b.HashMap(function(d,c){return d==c},function(c){return b.ObjectUtils.hashCode(c)});this.idToState={}},nextId:function(){var c=""+this._nextId++;return c},getIdToState:function(){return this.idToState},getObjToId:function(){return this.objToId}});b.Serializer=Class.create({initialize:function(){this.classNameToClass={};this.classNameToFnSerialize={};this.classNameToFnDeserialize={};this.classNameToPrototype={}},registerOverride:function(d,e,c){this.classNameToFnSerialize[d]=e;this.classNameToFnDeserialize[d]=c},indexClasses:function(d){var c=this.findClasses(d);_(this.classNameToClass).extend(c);return c},findClasses:function(d){var c={};_(d).each(function(e){var f=e.classLabel||(e.prototype?e.prototype.classLabel:null);if(f){c[f]=e}});return c},getLabelForClass:function(e){var d=Object.getPrototypeOf(e);var c;_(this.classNameToClass).find(function(g,f){if(d==g.prototype){c=f;return true}});return c},getClassForLabel:function(d){var c;_(this.classNameToClass).find(function(f,e){if(e===d){c=f;return true}});return c},serialize:function(f,d){d=d||new b.SerializationContext();var e=this.serializeRec(f,d);var c={root:e,idToState:d.getIdToState()};return c},serializeRec:function(k,h){var t;var o=h.getObjToId();var g=o.get(k);if(!g){g=h.nextId();o.put(k,g)}var d=h.getIdToState();var c=d[g];if(c){t={ref:g}}else{if(_(k).isFunction()){t=undefined}else{if(_(k).isObject()){t={};var i=this.getLabelForClass(k);var f=function(u){var e=_(u).isUndefined()||_(u).isNull()||_(u).isBoolean()||_(u).isNumber()||_(u).isDate()||_(u).isString()||_(u).isRegExp();return e};var q=function(w){var v=w.prototype||w.__proto__;var u=_(w).isObject&&!f(w);var e=u&&(v==null||v==Object.__proto__.__proto__);return e};var p=f(k)||q(k)||_(k).isArray();if(i==null&&!p){console.log("Failed to serialize instance without class label",k);throw"Failed to serialize instance without class label"}var l;if(i){l=this.classNameToPrototype[i];if(!l){var m=this.getClassForLabel(i);if(m){try{l=new m();this.classNameToPrototype[i]=l}catch(n){console.log("[WARN] Failed to create a prototype instance of class "+i,n)}}}}if(!l){l={}}var j=this.serializeAttrs(k,h,l);var s={};if(i){s.classLabel=i}if(_(j).keys().length>0){s.attrs=j.attrs;if(j.parent!=null){s.parent=j.parent}}if(_(k).isArray()){s.length=k.length}d[g]=s;t={ref:g}}else{t={value:k}}}}return t},serializeAttrs:function(d,c,f){var g=d;var k={};var h=k;var e=h.attrs={};var j=this;var i=_(d).keys();_(i).each(function(m){var l=d[m];var o=j.serializeRec(l,c);var p=f[m];var n=_(o).isEqual(p)||(o==null&&p==null);if(n){return}if(!_(o).isUndefined()){e[m]=o}});return k},deserialize:function(g,e){var f=g.root;var d=g.idToState;var h={};var c=this.deserializeRef(f,d,h);return c},deserializeRef:function(e,d,i){var f=e.ref;var h=e.value;var c;if(f!=null){var g=f in i;if(g){c=i[f]}else{c=this.deserializeState(f,d,i)}}else{c=h}return c},deserializeState:function(e,d,i){var m;var c=d[e];if(c==null||!_(c).isObject()){console.log("State must be an object, was: ",c);throw"Deserialization error"}var j=c.attrs;var f=c.classLabel;var g=c.length;if(f){var h=this.getClassForLabel(f);if(!h){throw"Unknown class label encountered in deserialization: "+f}m=new h()}else{if(g!=null){m=[]}else{m={}}}i[e]=m;var l=this;if(j!=null){var k=_(j).keys();_(k).each(function(n){var o=j[n];var p=l.deserializeRef(o,d,i);m[n]=p})}if(g!=null){m.length=g}return m}});b.Serializer.singleton=new b.Serializer()})();(function(){var b=Jassa.rdf;b.Node=Class.create({classLabel:"Node",getUri:function(){throw"not a URI node"},getName:function(){throw" is not a variable node"},getBlankNodeId:function(){throw" is not a blank node"},getBlankNodeLabel:function(){return this.getBlankNodeId().getLabelString()},getLiteral:function(){throw" is not a literal node"},getLiteralValue:function(){throw" is not a literal node"},getLiteralLexicalForm:function(){throw" is not a literal node"},getLiteralDatatype:function(){throw" is not a literal node"},getLiteralDatatypeUri:function(){throw" is not a literal node"},isBlank:function(){return false},isUri:function(){return false},isLiteral:function(){return false},isVariable:function(){return false},equals:function(e){var c=false;if(e==null){c=false}else{if(this.isLiteral()){if(e.isLiteral()){var g=this.getLiteralLexicalForm()===e.getLiteralLexicalForm();var d=this.getLiteralDatatypeUri()===e.getLiteralDatatypeUri();var f=this.getLiteralLanguage()===e.getLiteralLanguage();c=g&&d&&f}}else{if(this.isUri()){if(e.isUri()){c=this.getUri()===e.getUri()}}else{if(this.isVariable()){if(e.isVariable()){c=this.getName()===e.getName()}}else{if(this.isBlank()){if(e.isBlank()){c=this.getBlankNodeLabel()===e.getBlankNodeLabel()}}else{throw"not implemented yet"}}}}}return c}});b.Node_Concrete=Class.create(b.Node,{classLabel:"Node_Concrete",isConcrete:function(){return true}});b.Node_Uri=Class.create(b.Node_Concrete,{classLabel:"Node_Uri",initialize:function(c){this.uri=c},isUri:function(){return true},getUri:function(){return this.uri},toString:function(){return"<"+this.uri+">"}});b.Node_Blank=Class.create(b.Node_Concrete,{classLabel:"Node_Blank",initialize:function(c){this.anonId=c},isBlank:function(){return true},getBlankNodeId:function(){return this.anonId},toString:function(){return"_:"+this.anonId}});b.Node_Fluid=Class.create(b.Node,{isConcrete:function(){return false}});b.Node_Variable=Class.create(b.Node_Fluid,{classLabel:"Node_Variable",isVariable:function(){return true}});b.Var=Class.create(b.Node_Variable,{classLabel:"Var",initialize:function(c){this.name=c},getName:function(){return this.name},toString:function(){return"?"+this.name}});b.Node_Literal=Class.create(b.Node_Concrete,{classLabel:"Node_Literal",initialize:function(c){this.literalLabel=c},isLiteral:function(){return true},getLiteral:function(){return this.literalLabel},getLiteralValue:function(){return this.literalLabel.getValue()},getLiteralLexicalForm:function(){return this.literalLabel.getLexicalForm()},getLiteralDatatype:function(){return this.literalLabel.getDatatype()},getLiteralDatatypeUri:function(){var d=this.getLiteralDatatype();var c=d?d.getUri():null;return c},getLiteralLanguage:function(){return this.literalLabel.getLanguage()},toString:function(){return this.literalLabel.toString()}});b.escapeLiteralString=function(c){return c};b.LiteralLabel=Class.create({classLabel:"LiteralLabel",initialize:function(f,d,e,c){this.val=f;this.lex=d;this.lang=e;this.dtype=c},getValue:function(){return this.val},getLexicalForm:function(){return this.lex},getLanguage:function(){return this.lang},getDatatype:function(){return this.dtype},toString:function(){var d=this.dtype?this.dtype.getUri():null;var e=b.escapeLiteralString(this.lex);var c;if(d){c='"'+e+'"^^<'+d+">"}else{c='"'+e+'"'+(this.lang?"@"+this.lang:"")}return c}});b.AnonId=Class.create({getLabelString:function(){throw"not implemented"}});b.AnonIdStr=Class.create(b.AnonId,{classLabel:"AnonIdStr",initialize:function(c){this.label=c},getLabelString:function(){return this.label},toString:function(){return this.label}});b.DatatypeLabel=Class.create({parse:function(c){throw"Not implemented"},unparse:function(c){throw"Not implemented"}});b.DatatypeLabelInteger=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelInteger",parse:function(c){return parseInt(c,10)},unparse:function(c){return""+c}});b.DatatypeLabelFloat=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelFloat",parse:function(c){return parseFloat(c)},unparse:function(c){return""+c}});b.DatatypeLabelString=Class.create(b.DatatypeLabel,{classLabel:"DatatypeLabelString",parse:function(c){return c},unparse:function(c){return c}});b.RdfDatatype=Class.create({classLabel:"RdfDatatype",getUri:function(){throw"Not implemented"},unparse:function(c){throw"Not implemented"},parse:function(c){throw"Not implemented"}});b.RdfDatatypeBase=Class.create(b.RdfDatatype,{classLabel:"RdfDatatypeBase",initialize:function(c){this.uri=c},getUri:function(){return this.uri}});b.RdfDatatype_Label=Class.create(b.RdfDatatypeBase,{classLabel:"RdfDatatype_Label",initialize:function($super,d,c){$super(d);this.datatypeLabel=c},parse:function(c){return this.datatypeLabel.parse(c)},unparse:function(c){return this.datatypeLabel.unparse(c)}});b.strRegex=/"([^"\\]*(\\.[^"\\]*)*)"/;b.parseUri=function(e,d){var c;if(e.charAt(0)==="<"){c=e.slice(1,-1)}else{console.log("[ERROR] Cannot deal with "+e);throw"Not implemented"}return c};b.JenaParameters={enableSilentAcceptanceOfUnknownDatatypes:true};b.TypedValue=Class.create({initialize:function(c,d){this.lexicalValue=c;this.datatypeUri=d},getLexicalValue:function(){return this.lexicalValue},getDatatypeUri:function(){return this.datatypeUri}});b.BaseDatatype=Class.create(b.RdfDatatype,{initialize:function(c){this.datatypeUri=c},getUri:function(){return this.datatypeUri},unparse:function(d){var c;if(d instanceof b.TypedValue){c=d.getLexicalValue()}else{c=""+d}return c},parse:function(c){return new b.TypedValue(c,this.datatypeUri)},toString:function(){return"Datatype ["+this.datatypeUri+"]"}});b.TypeMapper=Class.create({initialize:function(c){this.uriToDt=c},getSafeTypeByName:function(e){var d=this.uriToDt;var c=d[e];if(c==null){if(e==null){return null}else{if(b.JenaParameters.enableSilentAcceptanceOfUnknownDatatypes){c=new b.BaseDatatype(e);this.registerDatatype(c)}else{console.log("Attempted to created typed literal using an unknown datatype - "+e);throw"Bailing out"}}}return c},registerDatatype:function(c){var d=c.getUri();this.uriToDt[d]=c}});b.TypeMapper.staticInstance=null;b.TypeMapper.getInstance=function(){var c=b.TypeMapper;if(c.staticInstance==null){c.staticInstance=new b.TypeMapper(b.RdfDatatypes)}return c.staticInstance};b.NodeFactory={createAnon:function(c){return new b.Node_Blank(c)},createUri:function(c){return new b.Node_Uri(c)},createVar:function(c){return new b.Var(c)},createPlainLiteral:function(d,e){if(e==null){e=""}var c=new b.LiteralLabel(d,d,e);return new b.Node_Literal(c)},createTypedLiteralFromValue:function(h,e){var c=b.RdfDatatypes[e];if(!c){var i=b.TypeMapper.getInstance();c=i.getSafeTypeByName(e)}var d=c.unparse(h);var g=null;var f=new b.LiteralLabel(h,d,g,c);return new b.Node_Literal(f)},createTypedLiteralFromString:function(i,e){var c=b.RdfDatatypes[e];if(!c){var j=b.TypeMapper.getInstance();c=j.getSafeTypeByName(e)}var h=c.parse(i);var d=i;var g="";var f=new b.LiteralLabel(h,d,g,c);return new b.Node_Literal(f)},createFromTalisRdfJson:function(e){if(!e||typeof(e.type)==="undefined"){throw"Invalid node: "+JSON.stringify(e)}var c;switch(e.type){case"bnode":var d=new b.AnonIdStr(e.value);c=new b.NodeFactory.createAnon(d);break;case"uri":c=b.NodeFactory.createUri(e.value);break;case"literal":var f=e.lang||e["xml:lang"];c=b.NodeFactory.createPlainLiteral(e.value,f);break;case"typed-literal":c=b.NodeFactory.createTypedLiteralFromString(e.value,e.datatype);break;default:console.log("Unknown type: '"+e.type+"'");throw"Bailing out"}return c},parseRdfTerm:function(q,h){if(!q){console.log("[ERROR] Null Pointer Exception");throw"Bailing out"}q=q.trim();if(q.length===0){console.log("[ERROR] Empty string");throw"Bailing out"}var p=q.charAt(0);var t;switch(p){case"<":var g=q.slice(1,-1);t=b.NodeFactory.createUri(g);break;case"_":var i=new b.AnonIdStr(p);t=b.NodeFactory.createAnon(i);break;case'"':var j=b.strRegex.exec(q);var k=j[0];var e=k.slice(1,-1);var f=k.length;var m=q.charAt(f);if(!m){t=b.NodeFactory.createTypedLiteralFromString(e,"http://www.w3.org/2001/XMLSchema#string")}switch(m){case"":case"@":var s=q.substr(f+1);t=b.NodeFactory.createPlainLiteral(e,s);break;case"^":var o=q.substr(f+2);var n=b.parseUri(o);t=b.NodeFactory.createTypedLiteralFromString(e,n);break;default:console.log("[ERROR] Excepted @ or ^^");throw"Bailing out"}break;default:console.log("Could not parse "+q);throw"Not implemented"}return t}};_.extend(b.Node,{uri:b.NodeFactory.createUri,v:b.NodeFactory.createVar});b.getSubstitute=function(e,d){var c=d(e);if(!c){c=e}return c};b.Triple=Class.create({classLabel:"jassa.rdf.Triple",initialize:function(e,c,d){this.subject=e;this.predicate=c;this.object=d},toString:function(){return this.subject+" "+this.predicate+" "+this.object},copySubstitute:function(d){var c=new b.Triple(b.getSubstitute(this.subject,d),b.getSubstitute(this.predicate,d),b.getSubstitute(this.object,d));return c},getSubject:function(){return this.subject},getPredicate:function(){return this.predicate},getObject:function(){return this.object},getVarsMentioned:function(){var c=[];b.Triple.pushVar(c,this.subject);b.Triple.pushVar(c,this.predicate);b.Triple.pushVar(c,this.object);return c}});b.Triple.pushVar=function(f,d){if(d.isVariable()){var e=_(f).some(function(c){return d.equals(c)});if(!e){f.push(d)}}return f}})();(function(){var b=Jassa.rdf;var c=Jassa.vocab.util;c.initNodes=function(e,d){if(d==null){d=e.str;if(d==null){console.log("No source from where to init nodes");throw"Bailing out"}}_.each(d,function(g,f){e[f]=b.Node.uri(g)})}})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.xsd;var d="http://www.w3.org/2001/XMLSchema#";c.str={xboolean:d+"boolean",xint:d+"int",xinteger:d+"integer",xlong:d+"long",decimal:d+"decimal",xfloat:d+"float",xdouble:d+"double",xstring:d+"string",date:d+"date",dateTime:d+"dateTime"};b.initNodes(c)})();(function(){var b=Jassa.vocab.xsd;var d=b.str;var c=Jassa.rdf;c.DatatypeLabels={xinteger:new c.DatatypeLabelInteger(),xfloat:new c.DatatypeLabelFloat(),xdouble:new c.DatatypeLabelFloat(),xstring:new c.DatatypeLabelString(),decimal:new c.DatatypeLabelFloat()};c.RdfDatatypes={};c.registerRdfDatype=function(f,e){c.RdfDatatypes[f]=new c.RdfDatatype_Label(f,e)};c.registerRdfDatype(b.str.xint,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xlong,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xinteger,c.DatatypeLabels.xinteger);c.registerRdfDatype(b.str.xstring,c.DatatypeLabels.xstring);c.registerRdfDatype(b.str.xfloat,c.DatatypeLabels.xfloat);c.registerRdfDatype(b.str.xdouble,c.DatatypeLabels.xdouble);c.registerRdfDatype(b.str.decimal,c.DatatypeLabels.xfloat)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.rdf;var d="http://www.w3.org/1999/02/22-rdf-syntax-ns#";c.str={type:d+"type",Property:d+"Property"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.rdfs;var d="http://www.w3.org/2000/01/rdf-schema#";c.str={label:d+"label",subClassOf:d+"subClassOf"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.owl;var d="http://www.w3.org/2002/07/owl#";c.str={Class:d+"Class",DatatypeProperty:d+"DatatypeProperty",ObjectProperty:d+"ObjectProperty",AnnotationProperty:d+"AnnotationProperty"};b.initNodes(c)})();(function(){var b=Jassa.vocab.util;var c=Jassa.vocab.wgs84;var d="http://www.w3.org/2003/01/geo/wgs84_pos#";c.str={lon:d+"long",lat:d+"lat"};b.initNodes(c)})();(function(){var b=Jassa.sparql;b.Node=Jassa.rdf.Node;b.PrefixMappingImpl=Class.create({initialize:function(c){this.prefixes=c?c:{}},expandPrefix:function(c){throw"Not implemented yet - sorry"},getNsPrefixMap:function(){return this.prefixes},getNsPrefixURI:function(c){return this.prefixes[c]},getNsURIPrefix:function(e){var c=null;var d=null;_(this.prefixes).each(function(f,g){if(_(e).startsWith(f)){if(!d||(f.length>d.length)){c=g;d=f}}});return c},qnameFor:function(c){},removeNsPrefix:function(c){delete this.prefixes[c]},samePrefixMappingAs:function(c){throw"Not implemented yet - Sorry"},setNsPrefix:function(d,c){this.prefixes[d]=c;return this},setNsPrefixes:function(e){var d=_(e.getNsPrefixMap).isFunction()?e.getNsPrefixMap():e;var c=this;_(d).each(function(f,g){c.setNsPrefix(g,f)});return this},shortForm:function(e){var f=this.getNsPrefixURI(e);var c;if(f){var d=this.prefixes[e];var g=e.substring(d.length);c=f+":"+g}else{c=e}return c},addPrefix:function(d,c){this.prefixes[d]=c},getPrefix:function(d){var c=this.prefixes[d];return c},addJson:function(c){_.extend(this.prefixes,c)},getJson:function(){return this.prefixes}})})();(function(){var rdf=Jassa.rdf;var xsd=Jassa.vocab.xsd;var ns=Jassa.sparql;ns.SparqlString=Class.create({classLabel:"jassa.sparql.SparqlString",initialize:function(value,varsMentioned){this.value=value;this.varsMentioned=varsMentioned?varsMentioned:[]},toString:function(){return this.value},getString:function(){return this.value},copySubstitute:function(fnNodeMap){var str=this.value;var newVarsMentioned=[];var placeholder="@@@@";var reAllPlaceholders=new RegExp(placeholder,"g");_(this.varsMentioned).each(function(v){var reStr="\\?"+v.getName()+"([^\\w])?";var re=new RegExp(reStr,"g");var node=fnNodeMap(v);if(node){var replacement;if(node.isVariable()){replacement=placeholder+node.getName();newVarsMentioned.push(node)}else{replacement=node.toString()}str=str.replace(re,replacement+"$1")}else{newVarsMentioned.push(v)}});str=str.replace(reAllPlaceholders,"?");return new ns.SparqlString(str,newVarsMentioned)},getVarsMentioned:function(){return this.varsMentioned}});ns.SparqlString.classLabel="SparqlString";ns.SparqlString.create=function(str,varNames){var vars;if(varNames!=null){vars=varNames.map(function(varName){return rdf.NodeFactory.createVar(varName)})}else{vars=ns.extractSparqlVars(str)}var result=new ns.SparqlString(str,vars);return result};ns.Expr=Class.create({isFunction:function(){return false},isVar:function(){return false},isConstant:function(){return false},getFunction:function(){console.log("Override me");throw"Override me"},getExprVar:function(){console.log("Override me");throw"Override me"},getConstant:function(){console.log("Override me");throw"Override me"},copySubstitute:function(fnNodeMap){console.log("Override me");throw"Override me"},copy:function(newArgs){console.log("Override me");throw"Override me"}});ns.ExprVar=Class.create(ns.Expr,{classLabel:"ExprVar",initialize:function(v){this.v=v},copySubstitute:function(fnNodeMap){var node=fnNodeMap(this.v);var result;if(node==null){result=this}else{if(node.isVariable()){result=new ns.ExprVar(node)}else{result=ns.NodeValue.makeNode(node)}}return result},getArgs:function(){return[]},copy:function(args){if(args&&args.length>0){throw"Invalid argument"}var result=new ns.ExprVar(this.v);return result},isVar:function(){return true},getExprVar:function(){return this},asVar:function(){return this.v},getVarsMentioned:function(){return[this.v]},toString:function(){return""+this.v}});ns.ExprFunction=Class.create(ns.Expr,{getName:function(){console.log("Implement me");throw"Implement me"},isFunction:function(){return true},getFunction:function(){return this}});ns.ExprFunctionBase=Class.create(ns.ExprFunction,{initialize:function(name){this.name=name},copySubstitute:function(fnNodeMap){var args=this.getArgs();var newArgs=_(args).map(function(arg){var r=arg.copySubstitute(fnNodeMap);return r});var result=this.copy(newArgs);return result},getVarsMentioned:function(){var result=ns.PatternUtils.getVarsMentioned(this.getArgs());return result},toString:function(){var result=this.name+"("+this.getArgs().join(", ")+")";return result}});ns.ExprFunction0=Class.create(ns.ExprFunctionBase,{initialize:function($super,name){$super(name)},getArgs:function(){return[]},copy:function(args){if(args&&args.length>0){throw"Invalid argument"}var result=this.$copy(args);return result}});ns.ExprFunction1=Class.create(ns.ExprFunctionBase,{initialize:function($super,name,subExpr){$super(name);this.subExpr=subExpr},getArgs:function(){return[this.subExpr]},copy:function(args){if(args.length!=1){throw"Invalid argument"}var result=this.$copy(args);return result},getSubExpr:function(){return this.subExpr}});ns.ExprFunction2=Class.create(ns.ExprFunctionBase,{initialize:function($super,name,left,right){$super(name);this.left=left;this.right=right},getArgs:function(){return[this.left,this.right]},copy:function(args){if(args.length!=2){throw"Invalid argument"}var result=this.$copy(args[0],args[1]);return result},getLeft:function(){return this.left},getRight:function(){return this.right}});ns.ExprFunctionN=Class.create(ns.ExprFunctionBase,{initialize:function($super,name,args){$super(name);this.args=args},getArgs:function(){return this.args}});ns.E_Function=Class.create(ns.ExprFunctionN,{initialize:function($super,name,args){$super(name,args)},copy:function(newArgs){var result=new ns.E_Function(this.name,newArgs);return result}});ns.E_OneOf=Class.create(ns.Expr,{initialize:function(lhsExpr,nodes){this.lhsExpr=lhsExpr;this.nodes=nodes},getVarsMentioned:function(){var result=this.lhsExpr.getVarsMentioned();return result},copySubstitute:function(fnNodeMap){var newElements=_.map(this.nodes,function(x){return rdf.getSubstitute(x,fnNodeMap)});return new ns.E_OneOf(this.lhsExpr.copySubstitute(fnNodeMap),newElements)},toString:function(){if(!this.nodes||this.nodes.length===0){return"FALSE"}else{return"("+this.lhsExpr+" In ("+this.nodes.join(", ")+"))"}}});ns.E_NotExists=Class.create(ns.ExprFunction0,{initialize:function($super,element){$super("jassa.sparql.E_NotExists");this.element=element},getVarsMentioned:function(){return this.element.getVarsMentioned()},$copy:function(){return new ns.E_NotExists(this.element)},toString:function(){return"Not Exists ("+this.element+") "}});ns.E_Str=Class.create(ns.ExprFunction1,{initialize:function($super,subExpr){$super("str",subExpr)},getVarsMentioned:function(){return this.subExpr.getVarsMentioned()},$copy:function(args){return new ns.E_Str(args[0])},toString:function(){return"str("+this.subExpr+")"}});ns.E_Regex=function(expr,pattern,flags){this.expr=expr;this.pattern=pattern;this.flags=flags};ns.E_Regex.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Regex(this.expr.copySubstitute(fnNodeMap),this.pattern,this.flags)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},getArgs:function(){return[this.expr]},copy:function(args){if(args.length!=1){throw"Invalid argument"}var newExpr=args[0];var result=new ns.E_Regex(newExpr,this.pattern,this.flags);return result},toString:function(){var patternStr=this.pattern.replace("'","\\'");var flagsStr=this.flags?", '"+this.flags.replace("'","\\'")+"'":"";return"Regex("+this.expr+", '"+patternStr+"'"+flagsStr+")"}};ns.E_Like=function(expr,pattern){this.expr=expr;this.pattern=pattern};ns.E_Like.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Like(this.expr.copySubstitute(fnNodeMap),this.pattern)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},getArgs:function(){return[this.expr]},copy:function(args){var result=ns.newUnaryExpr(ns.E_Like,args);return result},toString:function(){var patternStr=this.pattern.replace("'","\\'");return"("+this.expr+" Like '"+patternStr+"')"}};ns.E_Equals=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super("=",left,right)},copySubstitute:function(fnNodeMap){return new ns.E_Equals(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},$copy:function(left,right){return new ns.E_Equals(left,right)},toString:function(){return"("+this.left+" = "+this.right+")"},eval:function(binding){}});ns.E_LangMatches=function(left,right){this.left=left;this.right=right};ns.E_LangMatches.prototype={copySubstitute:function(fnNodeMap){return new ns.E_LangMatches(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LangMatches,args)},toString:function(){return"langMatches("+this.left+", "+this.right+")"},getVarsMentioned:function(){var result=ns.PatternUtils.getVarsMentioned(this.getArgs());return result}};ns.E_Lang=function(expr){this.expr=expr};ns.E_Lang.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Lang(this.expr.copySubstitute(fnNodeMap))},getArgs:function(){return[this.expr]},copy:function(args){var result=ns.newUnaryExpr(ns.E_Lang,args);return result},toString:function(){return"lang("+this.expr+")"},getVarsMentioned:function(){return this.expr.getVarsMentioned()}};ns.E_Bound=function(expr){this.expr=expr};ns.E_Bound.prototype={copySubstitute:function(fnNodeMap){return new ns.E_Bound(fnNodeMap(this.expr))},getArgs:function(){return[this.expr]},copy:function(args){var result=ns.newUnaryExpr(ns.E_Bound,args);return result},toString:function(){return"bound("+this.expr+")"}};ns.E_GreaterThan=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super(">",left,right)},copySubstitute:function(fnNodeMap){return new ns.E_GreaterThan(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_GreaterThan,args)},toString:function(){return"("+this.left+" > "+this.right+")"}});ns.E_LessThan=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super("<",left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LessThan(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_LessThan,args)},toString:function(){return"("+this.left+" < "+this.right+")"}});ns.E_LogicalAnd=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super("&&",left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LogicalAnd(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalAnd,args)},toString:function(){return"("+this.left+" && "+this.right+")"}});ns.E_LogicalOr=Class.create(ns.ExprFunction2,{initialize:function($super,left,right){$super("||",left,right)},copySubstitute:function(fnNodeMap){return new ns.E_LogicalOr(this.left.copySubstitute(fnNodeMap),this.right.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalOr,args)},toString:function(){return"("+this.left+" || "+this.right+")"}});ns.E_LogicalNot=function(expr){this.expr=expr};ns.E_LogicalNot.prototype={copySubstitute:function(fnNodeMap){return new ns.E_LogicalNot(this.expr.copySubstitute(fnNodeMap))},getArgs:function(){return[this.left,this.right]},copy:function(args){return ns.newBinaryExpr(ns.E_LogicalOr,args)},toString:function(){return"(!"+this.expr+")"}};ns.E_Count=function(subExpr,isDistinct){this.subExpr=subExpr;this.isDistinct=isDistinct?isDistinct:false};ns.E_Count.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Count(subExprCopy,this.isDistinct)};ns.E_Count.prototype.toString=function(){return"Count("+(this.isDistinct?"Distinct ":"")+(this.subExpr?this.subExpr:"*")+")"};ns.E_Min=function(subExpr){this.subExpr=subExpr};ns.E_Min.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Min(subExprCopy)};ns.E_Min.prototype.getArgs=function(){return[this.subExpr]};ns.E_Min.prototype.copy=function(args){if(args.length!=1){throw"Invalid argument"}var newSubExpr=args[0];var result=new ns.E_Min(newSubExpr)};ns.E_Min.prototype.toString=function(){return"Min("+this.subExpr+")"};ns.E_Max=function(subExpr){this.subExpr=subExpr};ns.E_Max.prototype.copySubstitute=function(fnNodeMap){var subExprCopy=this.subExpr?this.subExpr.copySubstitute(fnNodeMap):null;return new ns.E_Min(subExprCopy)};ns.E_Max.prototype.getArgs=function(){return[this.subExpr]};ns.E_Max.prototype.copy=function(args){if(args.length!=1){throw"Invalid argument"}var newSubExpr=args[0];var result=new ns.E_Max(newSubExpr)};ns.E_Max.prototype.toString=function(){return"Max("+this.subExpr+")"};ns.ExprString=Class.create(ns.Expr,{classLabel:"jassa.sparql.ExprString",initialize:function(sparqlString){this.sparqlString=sparqlString},copySubstitute:function(fnNodeMap){var newSparqlString=this.sparqlString.copySubstitute(fnNodeMap);return new ns.ExprString(newSparqlString)},getVarsMentioned:function(){return this.sparqlString.getVarsMentioned()},getArgs:function(){return[]},copy:function(args){if(args.length!=0){throw"Invalid argument"}return this},toString:function(){return"(!"+this.expr+")"}});ns.ExprString.create=function(str,varNames){var result=new ns.ExprString(ns.SparqlString.create(str,varNames));return result};ns.NodeValue=Class.create(ns.Expr,{initialize:function(node){this.node=node},isConstant:function(){return true},getConstant:function(){return this},getArgs:function(){return[]},getVarsMentioned:function(){return[]},asNode:function(){throw"makeNode is not overridden"},copySubstitute:function(fnNodeMap){return this},toString:function(){var node=this.node;var result;if(node.isLiteral()){if(node.getLiteralDatatypeUri()===xsd.xstring.getUri()){result='"'+node.getLiteralLexicalForm()+'"'}else{if(node.dataType===xsd.xdouble.value){return parseFloat(this.node.value)}}}else{result=node.toString()}return result}});_.extend(ns.NodeValue,{createLiteral:function(val,typeUri){var node=rdf.NodeFactory.createTypedLiteralFromValue(val,typeUri);var result=new ns.NodeValueNode(node);return result},makeString:function(str){return ns.NodeValue.createLiteral(str,xsd.str.xstring)},makeInteger:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.xint)},makeDecimal:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.decimal)},makeFloat:function(val){return new ns.NodeValue.createLiteral(val,xsd.str.xfloat)},makeNode:function(node){var result=new ns.NodeValueNode(node);return result}});ns.NodeValueNode=Class.create(ns.NodeValue,{initialize:function(node){this.node=node},asNode:function(){return this.node},toString:function(){var node=this.node;var result=null;if(node.isLiteral()){if(node.getLiteralDatatypeUri()===xsd.xstring.getUri()){result='"'+node.getLiteralLexicalForm()+'"'}}if(result==null){result=node.toString()}return result}});ns.NodeValue.nvNothing=ns.NodeValue.makeNode(rdf.NodeFactory.createAnon(new rdf.AnonIdStr("node value nothing")));ns.valueFragment=function(node){return'"'+node.value.toString().replace('"','\\"')+'"'};ns.languageFragment=function(node){return node.language?"@"+node.language:""};ns.datatypeFragment=function(node){return node.dataType?"^^<"+node.dataType+">":""}})();(function(){var d=Jassa.rdf;var c=Jassa.vocab.xsd;var b=Jassa.util;var e=Jassa.sparql;e.Binding=function(f){this.varNameToEntry=f?f:{}};e.Binding.create=function(g){var h={};_.map(g,function(j,i){h[i]={v:e.Node.v(i),node:j}});var f=new e.Binding(h);return f};e.Binding.fromTalisJson=function(g){var h={};_.each(g,function(l,i){var j=d.NodeFactory.createFromTalisRdfJson(l);h[i]=j});var f=e.Binding.create(h);return f};e.Binding.prototype={put:function(f,g){this.varNameToEntry[f.getName()]={v:f,node:g}},get:function(g){if(!(g instanceof d.Var)){throw"var not an instance of Var"}var i=g.getName();var h=this.varNameToEntry[i];var f=h?h.node:null;return f},entries:function(){var g=_.values(this.varNameToEntry);var f=_.sortBy(g,function(h){return h.v.getName()});return f},toString:function(){var h=this.entries();var g=_.map(h,function(i){return'"'+i.v.getName()+'": "'+i.node+'"'});var f="{"+g.join(", ")+"}";return f},getVars:function(){var f=[];_(this.varNameToEntry).each(function(g){f.push(g.v)});return f}};e.orify=function(g){var f=e.opify(g,e.E_LogicalOr);return f};e.andify=function(g){var f=e.opify(g,e.E_LogicalAnd);return f};e.opify=function(l,o){var k=l;var j=[];while(k.length>1){for(var h=0;h<k.length;h+=2){var n=k[h];if(h+1==k.length){j.push(n);break}var m=k[h+1];var f=o(n,m);j.push(f)}var g=k;k=j;j=[]}return k};e.uniqTriples=function(g){var f=_.uniq(g,false,function(h){return h.toString()});return f};e.mergeTriples=function(h,g){var i=h.concat(g);var f=e.uniqTriples(i);return f};e.varPattern=/\?(\w+)/g;e.prefixPattern=/((\w|-)+):(\w|-)+/g;e.extractVarNames=function(j){var f=[];for(var h=0;h<j.length;++h){var g=j[h];f.push(g.getName())}return f};e.extractSparqlVars=function(k){var g=e.extractAll(e.varPattern,k,1);var f=[];for(var j=0;j<g.length;++j){var l=g[j];var h=e.Node.v(l);f.push(h)}return f};e.extractPrefixes=function(f){return e.extractAll(e.prefixPattern,f,1)};e.expandPrefixes=function(m,n){var k=e.extractPrefixes(n);var f=n;for(var h=0;h<k.length;++h){var l=k[h];var g=m[l];if(!g){continue}var j=new RegExp(l+":(\\w+)","g");f=f.replace(j,"<"+g+"$1>")}return f};e.extractAll=function(i,j,h){var g;var f=[];while(g=i.exec(j)){f.push(g[h])}f=_.uniq(f);return f};e.BasicPattern=function(f){this.triples=f?f:[]};e.BasicPattern.prototype.copySubstitute=function(g){var f=_.map(this.triples,function(h){return h.copySubstitute(g)});return new e.BasicPattern(f)};e.BasicPattern.prototype.toString=function(){return this.triples.join(" . ")};e.Template=function(f){this.bgp=f};e.Template.prototype.copySubstitute=function(f){return new e.Template(this.bgp.copySubstitute(f))};e.Template.prototype.toString=function(){return"{ "+this.bgp+" }"};e.Element=Class.create({});e.ElementNamedGraph=Class.create(e.Element,{classLabel:"jassa.sparql.ElementNamedGraph",initialize:function(g,f){this.element=g;this.namedGraphNode=f},getArgs:function(){return[this.element]},copy:function(g){if(g.length!=1){throw"Invalid argument"}var h=g[0];var f=new e.ElementNamedGraph(h,this.namedGraphNode);return f},toString:function(){return"Graph "+this.namedGraphNode+" { "+this.element+" }"},copySubstitute:function(f){return new e.ElementNamedGraph(this.element.copySubstitute(f),this.namedGraphNode.copySubstitute(f))},getVarsMentioned:function(){var f=this.element.getVarsMentioned();if(this.namedGraphNode.isVar()){_.union(f,[this.namedGraphNode])}return f},flatten:function(){return new e.ElementNamedGraph(this.element.flatten(),this.namedGraphNode)}});e.ElementString=Class.create(e.Element,{classLabel:"jassa.sparql.ElementString",initialize:function(f){this.sparqlString=f},getArgs:function(){return[]},copy:function(f){if(f.length!=0){throw"Invalid argument"}return this},toString:function(){return this.sparqlString.getString()},copySubstitute:function(f){var g=this.sparqlString.copySubstitute(f);return new e.ElementString(g)},getVarsMentioned:function(){return this.sparqlString.getVarsMentioned()},flatten:function(){return this}});e.ElementString.create=function(h,g){var f=new e.ElementString(e.SparqlString.create(h,g));return f};e.ElementSubQuery=Class.create(e.Element,{classLabel:"jassa.sparql.ElementSubQuery",initialize:function(f){this.query=f},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElementSubQuery(this.query);return f},toString:function(){return"{ "+this.query+" }"},copySubstitute:function(f){return new e.ElementSubQuery(this.query.copySubstitute(f))},flatten:function(){return new e.ElementSubQuery(this.query.flatten())},getVarsMentioned:function(){return this.query.getVarsMentioned()}});e.ElementBind=Class.create(e.Element,{classLabel:"jassa.sparql.ElementBind",initialize:function(f,g){this.expr=g;this.variable=f},getArgs:function(){return[]},getExpr:function(){return this.expr},getVar:function(){return this.variable},getVarsMentioned:function(){return _(this.expr.getVarsMentioned()).union(this.variable)},copy:function(){return new e.ElementBind(this.variable,this.expr)},copySubstitute:function(f){return new e.ElementBind(d.getSubstitute(this.variable,f),this.expr.copySubstitute(f))},flatten:function(){return this},toString:function(){return"bind("+this.expr+" as "+this.variable+")"}});e.ElementFilter=Class.create(e.Element,{classLabel:"jassa.sparql.ElementFilter",initialize:function(f){if(_(f).isArray()){console.log("[WARN] Array argument for filter is deprecated");f=e.andify(f)}this.expr=f},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElementFilter(this.expr);return f},copySubstitute:function(f){var g=this.expr.copySubstitute(f);return new e.ElementFilter(g)},getVarsMentioned:function(){return this.expr.getVarsMentioned()},flatten:function(){return this},toString:function(){return"Filter("+this.expr+")"}});e.ElementOptional=Class.create(e.Element,{classLabel:"jassa.sparql.ElementOptional",initialize:function(f){this.optionalPart=f},getArgs:function(){return[this.optionalPart]},copy:function(g){if(g.length!=1){throw"Invalid argument"}var f=new e.ElementOptional(this.expr);return f},getVarsMentioned:function(){return this.optionalPart.getVarsMentioned()},copySubstitute:function(f){return new e.ElementOptional(this.optionalPart.copySubstitute(f))},flatten:function(){return new e.ElementOptional(this.optionalPart.flatten())},toString:function(){return"Optional {"+this.optionalPart+"}"}});e.ElementUnion=Class.create(e.Element,{classLabel:"jassa.sparql.ElementUnion",initialize:function(f){this.elements=f?f:[]},getArgs:function(){return this.elements},copy:function(g){var f=new e.ElementUnion(g);return f},getVarsMentioned:function(){var f=[];for(var g in this.elements){f=_.union(f,this.elements[g].getVarsMentioned())}return f},copySubstitute:function(g){var f=_.map(this.elements,function(h){return h.copySubstitute(g)});return new e.ElementUnion(f)},flatten:function(){var f=_.map(this.elements,function(g){return g.flatten()});return new e.ElementUnion(f)},toString:function(){return"{"+this.elements.join("} Union {")+"}"}});e.ElementTriplesBlock=Class.create(e.Element,{classLabel:"jassa.sparql.ElementTriplesBlock",initialize:function(f){this.triples=f?f:[]},getArgs:function(){return[]},copy:function(g){if(g.length!=0){throw"Invalid argument"}var f=new e.ElementTriplesBlock(this.triples);return f},getTriples:function(){return this.triples},addTriples:function(f){this.triples=this.triples.concat(f)},uniq:function(){this.triples=e.uniqTriples(this.triples)},copySubstitute:function(g){var f=_.map(this.triples,function(h){return h.copySubstitute(g)});return new e.ElementTriplesBlock(f)},getVarsMentioned:function(){var f=[];_.each(this.triples,function(g){f=_.union(f,g.getVarsMentioned())});return f},flatten:function(){return this},toString:function(){return this.triples.join(" . ")}});e.ElementGroup=Class.create(e.Element,{classLabel:"jassa.sparql.ElementGroup",initialize:function(f){this.elements=f?f:[]},addElement:function(f){this.elements.push(f)},getArgs:function(){return this.elements},copy:function(g){var f=new e.ElementTriplesBlock(g);return f},copySubstitute:function(g){var f=_.map(this.elements,function(h){return h.copySubstitute(g)});return new e.ElementGroup(f)},getVarsMentioned:function(){var f=e.PatternUtils.getVarsMentioned(this.elements);return f},toString:function(){return e.joinElements(" . ",this.elements)},flatten:function(){var f=e.ElementUtils.flatten(this.elements);if(f.length===1){return f[0]}else{return new e.ElementGroup(e.ElementUtils.flattenElements(f))}}});e.joinElements=function(i,h){var g=_.map(h,function(j){return""+j});var f=_.filter(g,function(j){return j.length!=0});return f.join(i)};e.newUnaryExpr=function(i,g){if(g.length!=1){throw"Invalid argument"}var h=g[0];var f=new i(h);return f};e.newBinaryExpr=function(j,g){if(g.length!=2){throw"Invalid argument"}var i=g[0];var h=g[1];var f=new j(i,h);return f};e.QueryType={};e.QueryType.Unknown=-1;e.QueryType.Select=0;e.QueryType.Construct=1;e.QueryType.Ask=2;e.QueryType.Describe=3;e.VarExprList=Class.create({classLabel:"jassa.sparql.VarExprList",initialize:function(){this.vars=[];this.varToExpr={}},getVarList:function(){return this.vars},getVars:function(){return this.vars},getExprMap:function(){return this.varToExpr},add:function(f,g){if(this.contains(f)){console.log("VarExprList already contained "+f);throw"Bailing out"}this.vars.push(f);if(g){this.varToExpr[f.getName()]=g}},contains:function(g){var f=_(this.vars).some(function(i){var h=g.equals(i);return h});return f},getExpr:function(g){var h=g.getName();var f=this.varToExpr[h];return f},addAll:function(g){var h=g.getVars();var f=this;_(h).each(function(i){var j=g.getExpr(i);f.add(i,j)})},entries:function(){var g=this;var f=_(this.vars).map(function(h){var i=g.varToExpr[h.getName()];return{v:h,expr:i}});return f},copySubstitute:function(j){var g=new e.VarExprList();var f=this.entries();for(var h=0;h<f.length;++h){var l=f[h];var m=j(l.v);var k=l.expr?l.expr.copySubstitute(j):null;g.add(m,k)}return g},toString:function(){var g=[];var l=this.entries();for(var j=0;j<l.length;++j){var k=l[j];var h=k.v;var m=k.expr;if(m){g.push("("+m+" As "+h+")")}else{g.push(""+h)}}var f=g.join(" ");return f}});e.SortCondition=Class.create({classLabel:"jassa.sparql.SortCondition",initialize:function(g,f){this.expr=g;this.direction=f},getExpr:function(){return this.expr},getDirection:function(){return this.direction},toString:function(){var f;if(this.direction>=0){f="Asc("+this.expr+")"}else{if(this.direction<0){f="Desc("+this.expr+")"}}return f},copySubstitute:function(h){var g=this.expr.copySubstitute(h);var f=new e.SortCondition(g,this.direction);return f}});e.Query=Class.create({classLabel:"jassa.sparql.Query",initialize:function(){this.type=0;this.distinct=false;this.reduced=false;this.resultStar=false;this.projectVars=new e.VarExprList();this.groupBy=[];this.orderBy=[];this.elements=[];this.constructTemplate=null;this.limit=null;this.offset=null},isResultStar:function(){return this.resultStar},setResultStar:function(f){this.resultStar=(f===true)},getQueryPattern:function(){return this.elements[0]},setQueryPattern:function(f){b.ArrayUtils.clear(this.elements);this.elements.push(f)},getElements:function(){return this.elements},getProjectVars:function(){var f=this.projectVars?this.projectVars.getVars():null;return f},setProjectVars:function(f){this.projectVars=f},getProject:function(){return this.projectVars},getGroupBy:function(){return this.groupBy},getOrderBy:function(){return this.orderBy},getLimit:function(){return this.limit},getOffset:function(){return this.offset},toStringOrderBy:function(){var f=(this.orderBy&&this.orderBy.length>0)?"Order By "+this.orderBy.join(" ")+" ":"";return f},toStringGroupBy:function(){var f=(this.groupBy&&this.groupBy.length>0)?"Group By "+this.groupBy.join(" ")+" ":"";return f},clone:function(){return this.copySubstitute(e.fnIdentity)},flatten:function(){var f=this.clone();var h=_.map(f.elements,function(i){return i.flatten()});var g=e.ElementUtils.flattenElements(h);f.elements=g;return f},getVarsMentioned:function(){console.log("sparql.Query.getVarsMentioned(): Not implemented properly yet. Things may break!");var f=_(this.elements).reduce(function(h,i){var g=i.getVarsMentioned();var j=_(h).union(g);return j},[]);return f},copySubstitute:function(g){var f=new e.Query();f.type=this.type;f.distinct=this.distinct;f.reduced=this.reduced;f.resultStar=this.resultStar;f.limit=this.limit;f.offset=this.offset;f.projectVars=this.projectVars.copySubstitute(g);if(this.constructTemplate){f.constructTemplate=this.constructTemplate.copySubstitute(g)}f.orderBy=this.orderBy==null?null:_.map(this.orderBy,function(h){return h.copySubstitute(g)});f.groupBy=this.groupBy==null?null:_.map(this.groupBy,function(h){return h.copySubstitute(g)});f.elements=_(this.elements).map(function(h){var i=h.copySubstitute(g);return i});return f},setOptions:function(f){if(typeof f==="undefined"){return}if(typeof f.limit!=="undefined"){this.setLimit(f.limit)}if(typeof(f.offset)!=="undefined"){this.setOffset(f.offset)}if(typeof(f.distinct)!=="undefined"){this.setDistinct(f.distinct)}},setOffset:function(f){this.offset=f?f:null},setLimit:function(f){if(f===0){this.limit=0}else{this.limit=f?f:null}},isDistinct:function(){return this.distinct},setDistinct:function(f){this.distinct=(f===true)},isReduced:function(){return this.reduced},setReduced:function(f){this.reduced=(f===true)},toString:function(){switch(this.type){case e.QueryType.Select:return this.toStringSelect();case e.QueryType.Construct:return this.toStringConstruct()}},toStringProjection:function(){if(this.resultStar){return"*"}return""+this.projectVars},toStringLimitOffset:function(){var f="";if(this.limit!=null){f+=" Limit "+this.limit}if(this.offset!=null){f+=" Offset "+this.offset}return f},toStringSelect:function(){var g=this.distinct?"Distinct ":"";var f="Select "+g+this.toStringProjection()+" {"+e.joinElements(" . ",this.elements)+"} "+this.toStringGroupBy()+this.toStringOrderBy()+this.toStringLimitOffset();return f},toStringConstruct:function(){var f="Construct "+this.constructTemplate+" {"+e.joinElements(" . ",this.elements)+"}"+this.toStringOrderBy()+this.toStringLimitOffset();return f}});e.fnIdentity=function(f){return f};e.opifyBalanced=function(n,l){if(n.length===0){return null}var h=n;while(h.length>1){var k=[];for(var j=0;j<h.length;j+=2){var m=j+1<h.length;var g=h[j];if(m){var f=h[j+1];k.push(new l(g,f))}else{k.push(g)}}h=k}return h[0]};e.opify=e.opifyBalanced})();(function(){var c=Jassa.rdf;var b=Jassa.util;var d=Jassa.sparql;d.VarGenerator=Class.create({initialize:function(e){this.generator=e},next:function(){var f=this.generator.next();var e=c.NodeFactory.createVar(f);return e}});d.VarUtils={createVars:function(f){var e=f.map(function(g){return c.NodeFactory.createVar(g)});return e},getVarNames:function(f){var e=f.map(function(g){return g.getName()});return e},createVarGen:function(i,g){if(!i){i="v"}var h=this.getVarNames(g);var j=d.GenSym.create(i);var f=new d.GeneratorBlacklist(j,h);var e=new d.VarGenerator(f);return e}};d.Generator=Class.create({next:function(){throw"Override me"}});d.GenSym=Class.create(d.Generator,{initialize:function(e,f){this.prefix=e?e:"v";this.nextValue=f?f:0},next:function(){++this.nextValue;var e=this.prefix+"_"+this.nextValue;return e}});d.GenSym.create=function(f){var e=new d.GenSym(f,0);return e};d.GeneratorBlacklist=Class.create(d.Generator,{initialize:function(f,e){this.generator=f;this.blacklist=e},next:function(){var e;do{e=this.generator.next()}while(_.contains(this.blacklist,e));return e}});d.fnToString=function(e){return e.toString()};d.fnGetVarName=function(e){return e.getName()};d.PatternUtils={getVarsMentioned:function(f){var e=_(f).reduce(function(g,h){var i=h.getVarsMentioned;if(!i||!_(i).isFunction()){console.log("[ERROR] .getVarsMentioned not found on object ",h)}var k=h.getVarsMentioned();var j=_(g).union(k);return j},[]);return e}};d.ElementFactory=Class.create({createElement:function(){throw"Not overridden"}});d.ElementFactoryConst=Class.create(d.ElementFactory,{initialize:function(e){this.element=e},createElement:function(){return this.element}});d.ElementFactoryCombine=Class.create(d.ElementFactory,{initialize:function(e,g,f){this.simplify=e;this.elementFactories=g;this.forceGroup=f},isSimplify:function(){return this.simplify},getElementFactories:function(){return this.elementFactories},isForceGroup:function(){return this.forceGroup},createElement:function(){var g=_(this.elementFactories).chain().map(function(h){var i=h.createElement();return i}).filter(function(h){return h!=null}).value();var e=new d.ElementGroup(g);if(this.simplify){e=e.flatten()}if(!this.forceGroup){var f=e.getArgs();if(f.length===1){e=f[0]}}return e}});d.ElementFactoryJoin=Class.create(d.ElementFactory,{initialize:function(i,g,f,e,h){this.elementFactoryA=i;this.elementFactoryB=g;this.joinVarsA=f;this.joinVarsB=e;this.joinType=h?h:d.JoinType.INNER_JOIN},createElement:function(){var g=this.elementFactoryA.createElement();var f=this.elementFactoryB.createElement();var i=g.getVarsMentioned();var h=f.getVarsMentioned();var j=d.ElementUtils.createJoinVarMap(h,i,this.joinVarsB,this.joinVarsA);g=d.ElementUtils.createRenamedElement(g,j);if(this.joinType==d.JoinType.LEFT_JOIN){f=new d.ElementOptional(f)}var e=new d.ElementGroup([g,f]);return e}});d.ElementFactoryJoinConcept=Class.create(d.ElementFactory,{initialize:function(f,e,g){this.conceptFactoryA=f;this.conceptFactoryB=e;this.joinType=g||d.JoinType.INNER_JOIN},createElement:function(){var i=this.conceptFactoryA.createConcept();var h=this.conceptFactoryB.createConcept();var g=i.getElement();var f=h.getElement();if(h.isSubjectConcept()){return g}var m=[i.getVar()];var l=[h.getVar()];var n=d.JoinBuilderElement.create(g);var k=n.joinAny(this.joinType,m,f,l);var j=k.getJoinBuilder();var e=j.getElements();var o=new d.ElementGroup(e);return o}});d.ElementUtils={createFilterElements:function(f){var e=_(f).map(function(h){var g=new d.ElementFilter(h);return g});return e},createElementsTriplesBlock:function(g){var e=[];if(g.length>0){var f=new d.ElementTriplesBlock(g);e.push(f)}return e},flatten:function(f){var e=_(f).map(function(g){var h=g.flatten();return h});return e},flattenElements:function(k){var e=[];var j=[];_(k).each(function(m){if(m instanceof d.ElementGroup){j.push.apply(j,m.elements)}else{j.push(m)}});var l=[];var i=[];var g=[];_(j).each(function(m){if(m instanceof d.ElementTriplesBlock){l.push.apply(l,m.getTriples())}else{if(m instanceof d.ElementFilter){i.push(m)}else{g.push(m)}}});if(l.length>0){var h=d.uniqTriples(l);e.push(new d.ElementTriplesBlock(h))}e.push.apply(e,g);var f=_(i).uniq(false,function(m){return""+m});e.push.apply(e,f);return e},createDistinctVarMap:function(h,i,l){var f=h.map(d.fnGetVarName);var k=i.map(d.fnGetVarName);if(l==null){var j=new d.GenSym("v");l=new d.GeneratorBlacklist(j,f)}var e=new b.HashBidiMap(d.fnNodeEquals);_(i).each(function(m){var o=m.getName();var n;if(_(f).contains(o)){var g=l.next();n=d.Node.v(g)}else{n=m}e.put(m,n)});return e},createJoinVarMap:function(h,m,j,k,g){if(j.length!=k.length){console.log("[ERROR] Cannot join on different number of columns");throw"Bailing out"}var n=d.ElementUtils.createDistinctVarMap(h,m,g);for(var e=0;e<j.length;++e){var f=j[e];var l=k[e];n.put(l,f)}return n},createRenamedElement:function(f,g){var e=function(j){var i=g.get(j);return i};var h=f.copySubstitute(e);return h}};d.ExprUtils={copySubstitute:function(g,h){var f=(function(k){var i=null;if(k.isVar()){var j=h.get(k);if(j!=null){i=j}}if(i==null){i=k}return i});var e=g.copySubstitute(f);return e},bindingToExprs:function(g,f){if(f==null){f=g.getVars()}var e=_(f).each(function(i){var h=new d.ExprVar(i);var k=g.get(i);var j=d.NodeValue.makeNode(k);var l=new d.E_Equals(h,j);return l});return e}}})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.sparql;c.JoinType={INNER_JOIN:"inner_join",LEFT_JOIN:"left_join"};c.JoinNode=Class.create({initialize:function(g,e,f){this.joinBuilder=g;this.alias=e;this.targetJoinVars=f},getJoinBuilder:function(){return this.joinBuilder},getJoinVars:function(){return this.targetJoinVars},getElement:function(){return this.joinBuilder.getElement(this.alias)},getVarMap:function(){return this.joinBuilder.getVarMap(this.alias)},getJoinNodeInfos:function(){var g=this.joinBuilder.getState(this.alias);var h=this.joinBuilder;var f=this;var e=_(g.getJoinInfos()).map(function(i){var k=i.getAlias();var j=f.joinBuilder.getJoinNode(k);var l=new c.JoinNodeInfo(j,i.getJoinType());return l});return e},joinAny:function(j,h,g,i,f){var e=this.joinBuilder.addJoin(j,this.alias,h,g,i,f);return e},join:function(h,g,i,f){var e=this.joinAny(c.JoinType.INNER_JOIN,h,g,i,f);return e},leftJoin:function(h,g,i,f){var e=this.joinAny(c.JoinType.LEFT_JOIN,h,g,i,f);return e},joinTree:function(e){},leftJoinTree:function(e){},joinTreeAny:function(e){}});c.JoinNodeInfo=Class.create({initialize:function(f,e){this.joinNode=f;this.joinType=e},getJoinNode:function(){return this.joinNode},getJoinType:function(){return this.joinType},toString:function(){return this.joinType+" "+this.joinNode}});c.JoinInfo=Class.create({initialize:function(e,f){this.alias=e;this.joinType=f},getAlias:function(){return this.alias},getJoinType:function(){return this.joinType},toString:function(){return this.joinType+" "+this.alias}});c.JoinTargetState=Class.create({initialize:function(g,h,e,f){this.varMap=g;this.joinNode=h;this.element=e;this.elementVars=f;this.joinInfos=[]},getVarMap:function(){return this.varMap},getJoinNode:function(){return this.joinNode},getElement:function(){return this.element},getElementVars:function(){return this.elementVars},getJoinInfos:function(){return this.joinInfos}});c.JoinBuilderElement=Class.create({initialize:function(f,e,h,g){if(f==null){console.log("[Error] Root element must not be null");throw"Bailing out"}this.usedVarNames=[];this.usedVars=[];this.aliasGenerator=new c.GenSym("a");this.varNameGenerator=new c.GeneratorBlacklist(new c.GenSym("v"),this.usedVarNames);this.aliasToState={};this.rootAlias=h?h:this.aliasGenerator.next();if(g==null){g=[]}var i=this.createTargetState(this.rootAlias,new b.HashBidiMap(),g,f,e,g);this.aliasToState[this.rootAlias]=i;this.rootNode=i.getJoinNode()},getRootNode:function(){return this.rootNode},getJoinNode:function(f){var g=this.aliasToState[f];var e=g?g.getJoinNode():null;return e},getState:function(e){return this.aliasToState[e]},getElement:function(f){var g=this.aliasToState[f];var e=g?g.getElement():null;return e},addVars:function(f){var e=this;_(f).each(function(g){var i=g.getName();var h=_(e.usedVarNames).contains(i);if(!h){e.usedVarNames.push(i);e.usedVars.push(g)}})},createTargetState:function(e,g,k,h,f,m){var p=k.map(function(q){var s=g.get(q);return s});var l=c.ElementUtils.createJoinVarMap(this.usedVars,f,p,m,this.varNameGenerator);var n=null;if(h!=null){n=c.ElementUtils.createRenamedElement(h,l)}var j=l.getInverse().keyList();this.addVars(j);var o=new c.JoinNode(this,e,m);var i=new c.JoinTargetState(l,o,n,j);return i},addJoin:function(o,j,m,k,n,g){var f=this.aliasToState[j];var i=f.getVarMap();if(!g){g=this.aliasGenerator.next()}var e=k.getVarsMentioned();var l=this.createTargetState(g,i,m,k,e,n);var h=new c.JoinInfo(g,o);f.getJoinInfos().push(h);this.aliasToState[g]=l;var p=l.getJoinNode();return p},getElementsRec:function(h){var i=[];var g=h.getElement();if(g!=null){i.push(g)}var f=h.getJoinNodeInfos();var e=this;_(f).each(function(n){var k=n.getJoinNode();var m=e.getElementsRec(k);var j=new c.ElementGroup(m);var l=n.getJoinType();switch(l){case c.JoinType.LEFT_JOIN:j=new c.ElementOptional(j);break;case c.JoinType.INNER_JOIN:break;default:console.log("[ERROR] Unsupported join type: "+l);throw"Bailing out"}i.push(j)});return i},getElements:function(){var f=this.getRootNode();var e=this.getElementsRec(f);return e},getAliasToVarMap:function(){var e={};_(this.aliasToState).each(function(g,f){e[f]=g.varMap});return e}});c.JoinBuilderUtils={getChildren:function(e){return e.getJoinNodes()}};c.JoinBuilderElement.create=function(g,h,f){var i=g.getVarsMentioned();var j=new c.JoinBuilderElement(g,i,h,f);var e=j.getRootNode();return e};c.JoinBuilderElement.createWithEmptyRoot=function(f,g){var h=d.VarUtils.varNamesToNodes(f);var i=new c.JoinBuilderElement(null,h,g);var e=i.getRootNode();return e}})();(function(){var b=Jassa.util;var c=Jassa.service;c.ResultSet=Class.create(b.Iterator,{getVarNames:function(){throw"Override me"}});c.ResultSetArrayIteratorBinding=Class.create(c.ResultSet,{initialize:function(e,d){this.itBinding=e;this.varNames=d},hasNext:function(){return this.itBinding.hasNext()},next:function(){return this.nextBinding()},nextBinding:function(){return this.itBinding.next()},getVarNames:function(){return this.varNames},getBindings:function(){return this.itBinding.getArray()},getIterator:function(){return this.itBinding}})})();(function(d){var b=Jassa.util;var c=Jassa.service;c.SparqlService=Class.create({getServiceId:function(){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"},getStateHash:function(){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"},createQueryExecution:function(e){console.log("[ERROR] Method not overridden");throw"[ERROR] Method not overridden"}});c.SparqlServiceBaseString=Class.create(c.SparqlService,{createQueryExecution:function(f){var e;if(_(f).isString()){e=this.createQueryExecutionStr(f)}else{e=this.createQueryExecutionObj(f)}return e},createQueryExecutionObj:function(f){var g=""+f;var e=this.createQueryExecutionStr(g);return e},createQueryExecutionStr:function(e){throw"Not implemented"}});c.SparqlServiceHttp=Class.create(c.SparqlServiceBaseString,{initialize:function(e,h,f,g){this.serviceUri=e;this.defaultGraphUris=h;this.ajaxOptions=f;this.httpArgs=g},getServiceId:function(){return this.serviceUri},getStateHash:function(){var e=JSONCanonical.stringify(this.defaultGraphUris);e+=JSONCanonical.stringify(this.httpArgs);return e},hashCode:function(){return this.getServiceId()+"/"+this.getStateHash()},setDefaultGraphs:function(e){this.defaultGraphUris=e},getDefaultGraphs:function(){return this.defaultGraphUris},createQueryExecutionStr:function(g){var f=_({}).defaults(this.ajaxOptions);var e=new c.QueryExecutionHttp(g,this.serviceUri,this.defaultGraphUris,f,this.httpArgs);return e},createQueryExecutionObj:function($super,g){if(true){if(g.flatten){var f=g;g=f.flatten()}}var e=$super(g);return e}});c.RequestCache=Class.create({initialize:function(e,f){this.executionCache=e?e:{};this.resultCache=f?f:new Cache()},getExecutionCache:function(){return this.executionCache},getResultCache:function(){return this.resultCache}});c.SparqlServiceCache=Class.create(c.SparqlServiceBaseString,{initialize:function(e,g,f){this.qef=e;this.requestCache=new c.RequestCache()},getServiceId:function(){return this.qef.getServiceId()},getStateHash:function(){return this.qef.getStateHash()},hashCode:function(){return"cached:"+this.qef.hashCode()},createQueryExecutionStr:function(j){var h=this.qef.getServiceId();var f=this.qef.getStateHash();var i=h+"-"+f+j;var g=this.qef.createQueryExecution(j);var e=new c.QueryExecutionCache(g,i,this.requestCache);return e}})})(jQuery);(function(){var util=Jassa.util;var sparql=Jassa.sparql;var ns=Jassa.service;ns.QueryCacheNodeFactory=Class.create({createQueryCache:function(sparqlService,query,indexExpr){throw"Not overridden"}});ns.QueryCacheNodeFactoryImpl=Class.create(ns.QueryCacheNodeFactory,{initialize:function(){this.keyToCache=new Cache()},createQueryCache:function(sparqlService,query,indexExpr){var key="cache:/"+sparqlService.getServiceId()+"/"+sparqlService.getServiceState()+"/"+query+"/"+indexExpr;console.log("cache requested with id: "+key);var cache=this.keyToCache.getItem(key);if(cache==null){cache=new ns.QueryCacheBindingHashSingle(sparqlService,query,indexExpr);this.keyToCache.addItem(key,cache)}return cache}});ns.QueryCacheBindingHashSingle=Class.create({initialize:function(sparqlService,query,indexExpr){this.sparqlService=sparqlService;this.query=query;this.indexExpr=indexExpr;this.maxChunkSize=50;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.nodeToBindings=new Cache();this.nodeMisses=new Cache()},fetchResultSet:function(nodes){var self=this;var nodeToBindings=this.nodeToBindings;var stats=this.analyze(nodes);var resultBindings=[];_(stats.cachedNodes).each(function(node){var bindings=nodeToBindings.getItem(node.toString());resultBindings.push.apply(resultBindings,bindings)});var fetchTasks=_(stats.nonCachedChunks).map(function(chunk){var promise=self.fetchChunk(chunk);return promise});var masterTask=$.when.apply(window,fetchTasks);var exprEvaluator=this.exprEvaluator;var indexExpr=this.indexExpr;var result=masterTask.pipe(function(){var seenKeys={};for(var i=0;i<arguments.length;++i){var rs=arguments[i];while(rs.hasNext()){var binding=rs.nextBinding();resultBindings.push(binding);var keyNode=exprEvaluator.eval(indexExpr,binding);var hashKey=keyNode.toString();seenKeys[hashKey]=keyNode;var cacheEntry=nodeToBindings.getItem(hashKey);if(cacheEntry==null){cacheEntry=[];nodeToBindings.setItem(hashKey,cacheEntry)}cacheEntry.push(binding)}}var itBinding=new util.IteratorArray(resultBindings);var r=new ns.ResultSetArrayIteratorBinding(itBinding);return r});return result},fetchChunk:function(nodes){var query=this.query.clone();var filterExpr=new sparql.E_OneOf(this.indexExpr,nodes);var filterElement=new sparql.ElementFilter(filterExpr);query.getElements().push(filterElement);var qe=this.sparqlService.createQueryExecution(query);var result=qe.execSelect();return result},analyze:function(nodes){var nodeToBindings=this.nodeToBindings;var cachedNodes=[];var nonCachedNodes=[];_(nodes).each(function(node){var nodeStr=node.toString();var entry=nodeToBindings.getItem(node.toString());if(entry==null){nonCachedNodes.push(node)}else{cachedNodes.push(node)}});var maxChunkSize=this.maxChunkSize;var nonCachedChunks=[];for(var i=0;i<nonCachedNodes.length;i+=maxChunkSize){var chunk=nodes.slice(i,i+maxChunkSize);nonCachedChunks.push(chunk)}var result={cachedNodes:cachedNodes,nonCachedNodes:nonCachedNodes,nonCachedChunks:nonCachedChunks,maxChunkSize:maxChunkSize};return result}})})();(function(d){var b=Jassa.util;var c=Jassa.service;c.QueryExecution=Class.create({execSelect:function(){throw"Not overridden"},execAsk:function(){throw"Not overridden"},execDescribeTriples:function(){throw"Not overridden"},execConstructTriples:function(){throw"Not overridden"},setTimeout:function(e){throw"Not overridden"}});c.QueryExecutionHttp=Class.create(c.QueryExecution,{initialize:function(i,e,h,f,g){this.queryString=i;this.serviceUri=e;this.defaultGraphUris=h;this.ajaxOptions=f||{};this.httpArgs=g},execSelect:function(){var e=this.execAny().pipe(c.ServiceUtils.jsonToResultSet);return e},execAsk:function(){var e=this.execAny().pipe(function(f){return f["boolean"]});return e},execConstructTriples:function(){throw"Not implemented yet"},execDescribeTriples:function(){throw"Not implemented yet"},setTimeout:function(e){this.ajaxOptions.timeout=e},getTimeout:function(){return this.ajaxOptions.timeout},execAny:function(){var f=c.ServiceUtils.createSparqlRequestAjaxSpec(this.serviceUri,this.defaultGraphUris,this.queryString,this.httpArgs,this.ajaxOptions);var e=d.ajax(f);return e}});c.QueryExecutionCache=Class.create(c.QueryExecution,{initialize:function(g,f,e){this.queryExecution=g;this.cacheKey=f;this.requestCache=e},setTimeout:function(e){this.queryExecution.setTimeout(e)},execSelect:function(){var i=this.cacheKey;var e=this.requestCache;var f=e.getResultCache();var j=e.getExecutionCache();var k=j[i];if(!k){var m=f.getItem(i);if(m){var l=d.Deferred();l.resolve(m);k=l.promise()}else{var h=this.queryExecution.execSelect();var o=h.pipe(function(q){var p={bindings:q.getBindings(),varNames:q.getVarNames()};return p});var g=false;k=o.pipe(function(p){g=true;delete j[i];f.setItem(i,p);return p});if(!g){j[i]=k}}}else{console.log("[INFO] Joined query execution for: "+i)}var n=k.pipe(function(p){var q=c.QueryExecutionCache.createResultSetFromCacheData(p);return q});return n}});c.QueryExecutionCache.createResultSetFromCacheData=function(f){var h=new b.IteratorArray(f.bindings);var e=f.varNames;var g=new c.ResultSetArrayIteratorBinding(h,e);return g}})(jQuery);(function(){var b=Jassa.util;var c=Jassa.service;c.QueryPaginator=Class.create({initialize:function(f,d){this.query=f;var e=f.getOffset();var g=f.getLimit();this.nextOffset=e||0;this.nextRemaining=g==null?null:g;this.pageSize=d},getPageSize:function(){return this.pageSize},next:function(){var e=this.nextOffset===0?null:this.nextOffset;this.query.setOffset(e);if(this.nextRemaining==null){this.query.setLimit(this.pageSize);this.nextOffset+=this.pageSize}else{var d=Math.min(this.pageSize,this.nextRemaining);this.nextOffset+=d;this.nextRemaining-=d;if(d===0){return null}this.query.setLimit(d)}return this.query}});c.QueryExecutionPaginate=Class.create(c.QueryExecution,{initialize:function(e,f,d){this.sparqlService=e;this.query=f;this.pageSize=d;this.timeoutInMillis=null},executeSelectRec:function(i,h,e){var g=i.next();console.log("Query Pagination: "+g);if(!g){e.resolve(h);return}var d=this;var f=this.sparqlService.createQueryExecution(g);f.setTimeout(this.timeoutInMillis);f.execSelect().done(function(m){if(!m){throw"Null result set for query: "+g}var j;if(!h){j=m}else{var n=h.getIterator().getArray();var o=m.getIterator().getArray();var q=n.concat(o);var l=new b.IteratorArray(q);j=new c.ResultSetArrayIteratorBinding(l)}var p=m.getIterator().getArray().length;var k=i.getPageSize();if(p===0||p<k){e.resolve(j)}else{return d.executeSelectRec(i,j,e)}}).fail(function(){e.fail()})},execSelect:function(){var g=this.query.clone();var d=this.pageSize||c.QueryExecutionPaginate.defaultPageSize;var f=new c.QueryPaginator(g,d);var e=$.Deferred();this.executeSelectRec(f,null,e);return e.promise()},setTimeout:function(d){this.timeoutInMillis=d;if(!this.timeoutMsgShown){console.log("[WARN] Only preliminary timeout implementation for paginated query execution");this.timeoutMsgShown=true}}});c.QueryExecutionPaginate.defaultPageSize=1000;c.SparqlServicePaginate=Class.create(c.SparqlService,{initialize:function(e,d){this.sparqlService=e;this.pageSize=d},getServiceId:function(){return this.sparqlService.getServiceId()},getStateHash:function(){return this.sparqlService.getStateHash()},hashCode:function(){return"paginate:"+this.sparqlService.hashCode()},createQueryExecution:function(e){var d=new c.QueryExecutionPaginate(this.sparqlService,e,this.pageSize);return d}})})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.SparqlServiceVirtFix=Class.create(c.SparqlService,{initialize:function(e){this.sparqlService=e},getServiceId:function(){return this.sparqlService.getServiceId()},getStateHash:function(){return this.sparqlService.getStateHash()},hashCode:function(){return"virtfix:"+this.sparqlService.hashCode()},hasAggregate:function(g){var f=g.getProject().entries();var e=_(f).some(function(h){var i=h.expr;if(i instanceof d.E_Count){return true}});return e},createQueryExecution:function(m){var n=m.getOrderBy();var h=m.getLimit();var i=m.getOffset();if(i!=null&&h==null){h=2000000000}var g=this.hasAggregate(m);var k=n.length>0&&(h||i)||g;var f;if(k){var j=m.clone();j.setLimit(null);j.setOffset(null);f=new d.Query();var l=new d.ElementSubQuery(j);f.getElements().push(l);f.setLimit(h);f.setOffset(i);f.setResultStar(true)}else{f=m}var o=this.sparqlService.createQueryExecution(f);return o}})})();(function(e){var b=Jassa.util;var d=Jassa.sparql;var f=Jassa.facete;var c=Jassa.service;c.ServiceUtils={constrainQueryVar:function(k,j,i){var h=new d.ExprVar(j);var g=this.constrainQueryExprVar(k,h,i);return g},constrainQueryExprVar:function(j,i,h){var g=j.clone();var k=new d.ElementFilter(new d.E_OneOf(i,h));g.getElements().push(k);return g},chunkQuery:function(m,l,k,h){var n=b.ArrayUtils.chunk(k,h);var j=new d.ExprVar(l);var i=this;var g=_(n).map(function(o){var p=i.constrainQueryExprVar(m,j,k);return p});return g},mergeResultSets:function(i){var k=[];var h=[];_(i).each(function(m){var n=m.getVarNames();h=_(h).union(n);var l=m.getIterator().getArray();k.push.apply(k,l)});var j=new b.IteratorArray(k);var g=new c.ResultSetArrayIteratorBinding(j,h);return g},execSelectForNodes:function(i,k,n,h,g){var j=this.chunkQuery(k,n,h,g);var m=_(j).map(function(t){var q=i.createQueryExecution(t);var s=q.execSelect();return s});var l=jQuery.when.apply(window,m);var o=this;var p=l.pipe(function(){var q=o.mergeResultSets(arguments);return q});return p},consumeResultSet:function(g){while(g.hasNext()){g.nextBinding()}},resultSetToList:function(h,i){var g=[];while(h.hasNext()){var k=h.nextBinding();var j=k.get(i);g.push(j)}return g},resultSetToInt:function(h,i){var g=null;if(h.hasNext()){var k=h.nextBinding();var j=k.get(i);g=j.getLiteralValue()}return g},fetchList:function(j,i){var h=this;var g=j.execSelect().pipe(function(k){var l=h.resultSetToList(k,i);return l});return g},fetchInt:function(j,i){var h=this;var g=j.execSelect().pipe(function(k){var l=h.resultSetToInt(k,i);return l});return g},fetchCountConcept:function(g,i,k){var o=f.ConceptUtils.createNewVar(i);var l=k==null?null:k+1;var j=f.ConceptUtils.createQueryCount(i,o,l);var h=g.createQueryExecution(j);var n=jQuery.Deferred();var m=c.ServiceUtils.fetchInt(h,o);m.done(function(s){var p=s>k;var q={count:p?k:s,limit:k,hasMoreItems:p};n.resolve(q)}).fail(function(){n.fail()});return n.promise()},fetchCountQuery:function(h,o,m,j){var g=[new d.ElementSubQuery(o)];var l=o.getVarsMentioned();var n=d.VarUtils.createVarGen("c",l);var t=n.next();var k=f.QueryUtils.createQueryCount(g,null,null,t,null,null,null);var i=h.createQueryExecution(k);i.setTimeout(m);var q=jQuery.Deferred();var p=c.ServiceUtils.fetchInt(i,t);p.done(function(u){q.resolve({count:u,limit:null,hasMoreItems:false})}).fail(function(){var v=f.QueryUtils.createQueryCount(g,j+1,null,t,null,null,null);var u=h.createQueryExecution(v);var w=c.ServiceUtils.fetchInt(u,t);w.done(function(x){q.resolve({count:x,limit:j,hasMoreItems:x>j})}).fail(function(){q.fail()})});var s=q.promise();return s},createSparqlRequestAjaxSpec:function(j,i,m,h,l){var k={query:m,"default-graph-uri":i};var g={url:j,dataType:"json",crossDomain:true,traditional:true,data:k};_(k).defaults(h);_(g).defaults(l);return g},jsonToResultSet:function(k){var h=k.head.vars;var l=k.results.bindings;var j=l.map(function(m){var n=d.Binding.fromTalisJson(m);return n});var i=new b.IteratorArray(j);var g=new c.ResultSetArrayIteratorBinding(i,h);return g}}})(jQuery);(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.Buffer=Class.create({isFull:function(){throw"Not overridden"}});c.BufferSet=Class.create(c.Buffer,{initialize:function(f){this.data=new b.SetList();this.maxItemCount=f},add:function(f){if(this.isFull()){throw"Buffer was full with "+this.maxItemCount+" items; Could not add item "+f}this.data.add(f)},isFull:function(){var f=this.data.size()>=this.maxItemCount;return f},clear:function(){this.data.clear()},entries:function(){}});c.BindingLookup=Class.create({initialize:function(g,h,f){this.sparqlService=g;this.element=h},lookupByIterator:function(j){var f=[];while(j.hasNext()){var l=j.nextBinding();var k=d.ExprUtils.bindingToExprs(l);var g=k.join(", ");f.push({binding:l,exprs:k,exprsKey:g})}var m=new d.ElementFilter(expr);var i=this.query.clone();i.getElements().push(m);var h=this.sparqlService.execSelect(i)}});c.ResultSetHashJoin=Class.create(b.IteratorAbstract,{initialize:function(g,i,f,h){this.rsA=g;this.serviceB=i;this.elementB=f;this.expr=h;g.getVarsMentioned();h.getVarsMentioned()},$prefetch:function(){var g=20;var f=[];while(rsA.hasNext()){}if(f.isFull()||!rsa.hasNext()){}}});var e={createResultSetJoinHash:function(g,i,f,h){},execJoin:function(h,g,f,i){}}})();(function(){var b=Jassa.service;b.SparqlServiceFactory=Class.create({createSparqlService:function(){throw"Not overridden"}});b.SparqlServiceFactoryConst=Class.create({initialize:function(c){this.sparqlService=c},createSparqlService:function(){var c=this.sparqlService;if(c==null){console.log("[ERROR] Creation of a SPARQL service requested, but none was provided");throw"Bailing out"}return c},setSparqlService:function(c){this.sparqlService=c}});b.SparqlServiceFactoryDefault=Class.create({initialize:function(){this.hashToCache={}},createSparqlService:function(f,d){var e=new b.SparqlServiceHttp(f,d);e=new b.SparqlServiceCache(e);var g=e.getStateHash();var h=this.hashToCache[g];var c;if(h){c=h}else{this.hashToCache[g]=e;c=e}return c}})})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.service;c.TableServiceUtils={bindingToJsMap:function(f,g){var e={};_(f).each(function(h){var i=h.getName();e[i]=g.get(h)});return e},createNgGridOptionsFromQuery:function(g){if(!g){return[]}var h=g.getProjectVars();var f=d.VarUtils.getVarNames(h);var e=_(f).map(function(j){var i={field:j,displayName:j};return i});return e},fetchCount:function(h,j,f,i){var e;if(!h||!j){var g=jQuery.Deferred();g.resolve(0);e=g.promise()}else{j=j.clone();j.setLimit(null);j.setOffset(null);e=c.ServiceUtils.fetchCountQuery(h,j,f,i)}return e},fetchData:function(f,k,i,j){if(!f||!k){var m=jQuery.Deferred();var e=new b.IteratorArray([]);var l=[];var h=new c.ResultSetArrayIteratorBinding(e,l);m.resolve(h);return m.promise()}k=k.clone();k.setLimit(i);k.setOffset(j);var g=f.createQueryExecution(k);var n=g.execSelect().pipe(function(p){var q=[];var u=k.getProjectVars();while(p.hasNext()){var t=p.next();var s=c.TableServiceUtils.bindingToJsMap(u,t);q.push(s)}return q});return n},collectNodes:function(f){var e=[];_(f).each(function(h,g){_(h).each(function(i){e.push(i)})});_(e).uniq(false,function(g){return""+g});return e},fetchSchemaTableConfigFacet:function(i,h){var g=i.getPaths().getArray();var f=h.lookup(g);var e=f.pipe(function(l){var j=_(g).map(function(n){var m={field:i.getColumnId(n),displayName:l.get(n),path:n};return m});var k={colDefs:j};return k});return e},transformToNodeLabels:function(g,h){var f=this.collectNodes(h);var i=g.lookup(f);var e=i.pipe(function(j){var k=_(h).map(function(m){var l={};_(m).each(function(p,o){var n=j.get(p);l[o]={node:p,displayLabel:n}});return l});return k});return e}};c.TableService=Class.create({fetchSchema:function(){console.log("Implement me");throw"Implement me"},fetchCount:function(){console.log("Implement me");throw"Implement me"},fetchData:function(e,f){console.log("Implement me");throw"Implement me"}});c.TableServiceQuery=Class.create(c.TableService,{initialize:function(f,h,e,g){this.sparqlService=f;this.query=h;this.timeoutInMillis=e||3000;this.secondaryCountLimit=g||1000},fetchSchema:function(){var f={colDefs:c.TableServiceUtils.createNgGridOptionsFromQuery(this.query)};var e=$.Deferred();e.resolve(f);return e.promise()},fetchCount:function(){var e=c.TableServiceUtils.fetchCount(this.sparqlService,this.query,this.timeoutInMillis,this.secondaryCountLimit);return e},fetchData:function(f,g){var e=c.TableServiceUtils.fetchData(this.sparqlService,this.query,f,g);return e}});c.TableServiceDelegateBase=Class.create(c.TableService,{initialize:function(e){this.delegate=e},fetchSchema:function(){var e=this.delegate.fetchSchema();return e},fetchCount:function(){var e=this.delegate.fetchCount();return e},fetchData:function(f,g){var e=this.delegate.fetchData();return e}});c.TableServiceNodeLabels=Class.create(c.TableServiceDelegateBase,{initialize:function($super,e,f){$super(e);this.lookupServiceNodeLabels=f},fetchData:function(f,i){var h=this.delegate.fetchData(f,i);var g=this;var e=h.pipe(function(k){var j=c.TableServiceUtils.transformToNodeLabels(g.lookupServiceNodeLabels,k);return j});return e}});c.TableServiceFacet=Class.create(c.TableServiceNodeLabels,{initialize:function($super,e,h,f,g){$super(e,f);this.tableConfigFacet=h;this.lookupServicePathLabels=g},fetchSchema:function(){var e=c.TableServiceUtils.fetchSchemaTableConfigFacet(this.tableConfigFacet,this.lookupServicePathLabels);return e}})})();(function(){var b=jassa.util;var c=jassa.service;c.LookupService=Class.create({getIdStr:function(d){console.log("Not overridden");throw"Not overridden"},lookup:function(d){console.log("Not overridden");throw"Not overridden"}});c.LookupServiceBase=Class.create(c.LookupService,{getIdStr:function(e){var d=""+e;return d}});c.LookupServiceDelegateBase=Class.create(c.LookupService,{initialize:function(d){this.delegate=d},getIdStr:function(e){var d=this.delegate.getIdStr(e);return d}});c.LookupServiceCache=Class.create(c.LookupServiceDelegateBase,{initialize:function($super,d,e){$super(d);this.requestCache=e||new c.RequestCache()},lookup:function(d){var m=this;var l=_(d).uniq(false,function(p){var o=m.getIdStr(p);return o});var e=new b.HashMap();var h=this.requestCache.getResultCache();var j=this.requestCache.getExecutionCache();var i=[];var f=[];var k=[];_(l).each(function(t){var o=m.getIdStr(t);var q=h.getItem(o);if(!q){var s=j[o];if(s){f.push(t);var p=_(k).find(function(v){var u=(v==s);return u});if(!p){k.push(s)}}else{i.push(t);f.push(t)}}else{e.put(t,q)}});if(i.length>0){var g=this.fetchAndCache(i);k.push(g)}var n=jQuery.when.apply(window,k).pipe(function(){var o=arguments;_(f).each(function(q){var p=null;_(o).find(function(s){p=s.get(q);return !!p});if(p){e.put(q,p)}});return e});return n},fetchAndCache:function(g){var i=this.requestCache.getResultCache();var f=this.requestCache.getExecutionCache();var e=this;var h=this.delegate.lookup(g);var d=h.pipe(function(k){var j=new b.HashMap();_(g).each(function(n){var l=e.getIdStr(n);var m=k.get(n);i.setItem(l,m);j.put(n,m)});_(g).each(function(m){var l=e.getIdStr(m);delete f[l]});return j});_(g).each(function(k){var j=e.getIdStr(k);f[j]=d});return d}});c.LookupServiceChunker=Class.create(c.LookupServiceDelegateBase,{initialize:function($super,e,d){$super(e);this.maxChunkSize=d},lookup:function(g){var e=this;var i=_(g).uniq(false,function(k){var j=e.getIdStr(k);return j});var h=b.ArrayUtils.chunk(i,this.maxChunkSize);var f=_(h).map(function(j){var k=e.delegate.lookup(j);return k});var d=jQuery.when.apply(window,f).pipe(function(){var j=new b.HashMap();_(arguments).each(function(k){j.putAll(k)});return j});return d}});c.LookupServiceTimeout=Class.create(c.LookupServiceDelegateBase,{initialize:function($super,e,f,d){$super(e);this.delayInMs=f;this.maxRefreshCount=d||0;this.idStrToId={};this.currentDeferred=null;this.currentPromise=null;this.currentTimer=null;this.currentRefreshCount=0},getIdStr:function(e){var d=this.delegate.getIdStr(e);return d},lookup:function(f){if(!this.currentDeferred){this.currentDeferred=jQuery.Deferred();this.currentPromise=this.currentDeferred.promise()}var e=this;_(f).each(function(i){var g=e.getIdStr(i);var h=e.idStrToId[g];if(!h){e.idStrToId[g]=i}});if(!this.currentTimer){this.startTimer()}var d=this.currentPromise.pipe(function(h){var g=new b.HashMap();_(f).each(function(j){var i=h.get(j);g.put(j,i)});return g});return d},startTimer:function(){var e=this;var f=this.currentRefreshCount;var d=e.currentDeferred;this.currentTimer=setTimeout(function(){if(e.maxRefreshCount<0||f<e.maxRefreshCount){++e.currentRefreshCount;e.startTimer();return}var g=_(e.idStrToId).values();e.idStrToId={};e.currentRefreshCount=0;e.currentDeferred=null;e.currentTimer=null;var h=e.delegate.lookup(g);h.pipe(function(i){d.resolve(i)}).fail(function(){d.fail()})},this.delayInMs)}});c.LookupServiceSponate=Class.create(c.LookupServiceBase,{initialize:function(d){this.source=d},lookup:function(e){var d=this.source.find().nodes(e).asList(true).pipe(function(g){var f=new b.HashMap();_(g).each(function(h){f.put(h.id,h)});return f});return d}});c.LookupServiceTransform=Class.create(c.LookupServiceDelegateBase,{initialize:function($super,e,d){$super(e);this.fnTransform=d},lookup:function(f){var e=this.fnTransform;var d=this.delegate.lookup(f).pipe(function(g){_(f).each(function(j){var i=g.get(j);var h=e(i,j);g.put(j,h)});return g});return d}});c.LookupServicePathLabels=Class.create(c.LookupServiceBase,{initialize:function(d){this.lookupServiceBase=d},lookup:function(f){var e=_(f).chain().map(function(h){var g=_(h.getSteps()).map(function(i){return i.getPropertyName()});return g}).flatten().uniq().map(function(g){return rdf.NodeFactory.createUri(g)}).value();var d=this.lookupServiceBase.lookup(e).pipe(function(h){var g=new b.HashMap();_(f).each(function(j){var i=_(j.getSteps()).reduce(function(l,n){var k=l;var o=rdf.NodeFactory.createUri(n.getPropertyName());var m=h.get(o);k=k===""?k:k+"&raquo;";k+=m;k=!n.isInverse()?k:k+"&sup1";return k},"");if(i===""){i="Items"}g.put(j,i)});return g});return d}});c.LookupServiceIdFilter=Class.create(c.LookupServiceDelegateBase,{initialize:function($super,d,e){$super(d);this.predicateFn=e},lookup:function(f){var e=_(f).filter(this.predicateFn);var d=this.delegate.lookup(e);return d}});c.LookupServiceConst=Class.create(c.LookupServiceBase,{initialize:function(d){this.data=d},lookup:function(f){var g=new b.HashMap();var e=this;_(f).each(function(h){g.put(h,e.data)});var d=jQuery.Deferred();d.resolve(g);return d.promise()}});c.LookupServiceConstraintLabels=Class.create(c.LookupServiceBase,{initialize:function(d,e){this.lookupServiceNodeLabels=d;this.lookupServicePathLabels=e||new c.LookupServicePathLabels(d)},lookup:function(i){var h=[];var e=[];_(i).each(function(l){var k=l.getDeclaredPaths();var j=l.getValue();h.push.apply(h,k);e.push(j)});var g=this.lookupServiceNodeLabels.lookup(e);var f=this.lookupServicePathLabels.lookup(h);var d=jQuery.when.apply(window,[g,f]).pipe(function(l,j){var k=new b.HashMap();_(i).each(function(q){var p=q.getDeclaredPath();var o=q.getValue();var n=j.get(p);var s=l.get(o);var m=n+" = "+s;k.put(q,m)});return k});return d}})})();(function(){var b=jassa.util;var f=jassa.facete;var e=jassa.geo;var d=jassa.sponate;var f=jassa.facete;var c=jassa.service;c.DataService=Class.create({fetchData:function(g){console.log("Not implemented");throw"Not implemented"}});c.ListService=Class.create({fetchItems:function(h,g,i){console.log("Not implemented");throw"Not implemented"},fetchCount:function(h,g){console.log("Not implemented");throw"Not implemented"}});c.ListServiceBbox=Class.create(c.ListService,{initialize:function(h,g,i){this.sparqlService=h;this.geoMapFactory=g;this.concept=i},createFlow:function(i){var h=new d.StoreFacade(this.sparqlService);var g=this.geoMapFactory.createMap(i);h.addMap(g,"geoMap");return h.geoMap},fetchItems:function(j,h,k){var i=this.createFlow(j).find().concept(this.concept).limit(h).offset(k);var g=i.asList(true);return g},fetchCount:function(j,h){var i=this.createFlow(j).find().concept(this.concept).limit(h);var g=i.count();return g}});c.DataServiceBboxCache=Class.create({initialize:function(i,h,k,j){this.listServiceBbox=i;var g=new e.Bounds(-180,-90,180,90);this.quadTree=new e.QuadTree(g,18,0);this.maxItemsPerTileCount=k||25;this.maxGlobalItemCount=h||50;this.aquireDepth=j||2},fetchData:function(h){var g=this.runWorkflow(h).pipe(function(i){var j=_(i).map(function(l){return l.data.docs});var k=_(j).compact();k=_(k).flatten(true);_(i).each(function(n){if(n.isLoaded){return}var m=e.GeoExprUtils.boundsToWkt(n.getBounds());var l={id:m,zoomClusterBounds:n.getBounds(),wkt:rdf.NodeFactory.createPlainLiteral(m)};k.push(l)});return k});return g},runCheckGlobal:function(){var g;var j=this.quadTree.getRootNode();var i=this;if(!j.checkedGlobal){var l=this.listServiceBbox.fetchCount(null,this.maxGlobalItemCount);var k=l.pipe(function(m){var n=!m.hasMoreItems;console.log("Global check counts",m);j.canUseGlobal=n;j.checkedGlobal=true;return n});g=k}else{var h=$.Deferred();h.resolve(j.canUseGlobal);g=h.promise()}return g},runWorkflow:function(k){var j=$.Deferred();var i=this.quadTree.getRootNode();var h=this;this.runCheckGlobal().pipe(function(m){console.log("Can use global? ",m);var l;if(m){l=h.runGlobalWorkflow(i)}else{l=h.runTiledWorkflow(k)}l.done(function(n){j.resolve(n)}).fail(function(){j.fail()})}).fail(function(){j.fail()});var g=j.promise();return g},runGlobalWorkflow:function(i){var h=this;var g=this.listServiceBbox.fetchItems(null).pipe(function(j){h.loadTaskAction(i,j);return[i]});return g},runTiledWorkflow:function(k){var i=this;var h=this.quadTree.aquireNodes(k,this.aquireDepth);_(h).each(function(m){if(!m.data){m.data={}}});_(h).each(function(m){if(m.isCountComplete()&&m.infMinItemCount===0){m.isLoaded=true}});var j=_(h).filter(function(m){return i.isCountingNeeded(m)});var g=$.Deferred();var l=this.createCountTasks(j);$.when.apply(window,l).done(function(){var n=_(h).filter(function(o){return i.isLoadingNeeded(o)});var m=i.createLoadTasks(n);$.when.apply(window,m).done(function(){g.resolve(h)})}).fail(function(){g.fail()});return g},createCountTask:function(k){var j=this;var h=j.maxItemsPerTileCount;var i=this.listServiceBbox.fetchCount(k.getBounds(),h);var g=i.pipe(function(l){var m=l.count;k.setMinItemCount(l.count);if(m===0){k.isLoaded=true}});return g},isCountingNeeded:function(g){return !(this.isTooManyGeoms(g)||g.isCountComplete())},isLoadingNeeded:function(g){var h=g.isLoaded||(g.isCountComplete()&&g.infMinItemCount===0)||this.isTooManyGeoms(g);return !h},isTooManyGeoms:function(g){return g.infMinItemCount>=this.maxItemsPerTileCount},createCountTasks:function(i){var h=this;var g=_(i).chain().map(function(j){return h.createCountTask(j)}).compact().value();return g},loadTaskAction:function(g,h){g.data.docs=h;g.isLoaded=true},createLoadTasks:function(i){var h=this;var g=[];var g=_(i).map(function(k){var j=h.listServiceBbox.fetchItems(k.getBounds()).pipe(function(l){h.loadTaskAction(k,l)});return j});return g},finalizeLoading:function(h){var j=[];$.each(h,function(i,o){if(o.parent){j.push(o.parent)}});j=_.uniq(j);var n=false;do{n=false;for(var l in j){var m=j[l];var k=m.children;var g=c.tryMergeNode(m);if(!g){continue}n=true;$.each(k,function(o,q){var p=_.indexOf(h,q);if(p>=0){h[p]=undefined}});h.push(m);if(m.parent){j.push(m.parent)}break}}while(n==true);_.compact(h)}});c.ListServiceConceptKeyLookup=Class.create(c.ListService,{initialize:function(g,h){this.sparqlService=g;this.keyLookupService=h},fetchItems:function(j,g,l){var k=f.ConceptUtils.createQueryList(j,g,l);var i=jQuery.Deferred();var h=this;c.ServiceUtils.fetchList(k,j.getVar()).pipe(function(m){h.keyLookupService.lookup(m).pipe(function(n){i.resolve(n)}).fail(function(){i.fail()})}).fail(function(){i.fail()});return i.promise()},fetchCount:function(i,h){var g=c.ServiceUtils.fetchCountConcept(i,h);return g}});c.BBoxLookupService=Class.create({lookupBBox:function(g){console.log("Not implemented");throw"Not implemented"}});c.BBoxLookupService=Class.create(c.BBoxLookupService,{});c.LookupServiceUtils={lookup:function(j,i){var g;if(!j||!i){var h=jQuery.Deferred();h.resolve([]);g=h.promise()}else{g=j.lookup(i)}return g},zip:function(i,h){var g=jQuery.when.apply(window,h).pipe(function(){var l=new b.HashMap();for(var j=0;j<i.length;++j){var k=i[j];var m=arguments[j];l.put(k,m)}return l});return g},unmapKeys:function(i,h,j){var g=new b.HashMap();_(i).each(function(n){var m=h(n);var l=j.get(m);r.put(n,l)});return g},fetchItemsMapped:function(k,i,h){var j=_(i).map(h);var g=k.fetchItems(j).pipe(function(m){var l=c.LookupServiceUtils.unmapKeys(i,h,m);return l});return g},fetchCountsMapped:function(k,i,h){var j=_(i).map(h);var g=k.fetchCounts(j).pipe(function(m){var l=c.LookupServiceUtils.unmapKeys(i,h,m);return l});return g}};c.ListServiceAugmenter=Class.create(c.ListService,{initialize:function(g,h){this.listService=g;this.augmenter=h},fetchItems:function(j,g,l){var i=jQuery.Deferred();var k=this.listService.fetchItems(j);var h=this;k.pipe(function(m){var n=h.augmenter.augment(m);n.done(function(){i.resolve(m)}).fail(function(){i.fail()})}).fail(function(){i.fail()});return i.promise()},fetchCount:function(i,h){var g=this.listService.fetchCount(i,h);return g}});c.BBoxLookupServiceKeys=Class.create(c.BBoxLookupService,{initialize:function(){}});c.BBoxLookupServiceSupplierDynamic=Class.create({initialize:function(i,h,j,g){this.sparqlServiceSupplier=i;this.geoMapSupplier=h;this.conceptSupplier=j;this.quadTreeConfig=g;this.hashToCache={}},fetchItems:function(j){quadTreeConfig=quadTreeConfig||{};_(quadTreeConfig).defaults(c.ViewStateFetcher.defaultQuadTreeConfig);var h=geoMapFactory.createMapForGlobal();var k=c.ViewStateUtils.createStateHash(sparqlService,h,concept);var l=this.hashToCache[k];if(!l){l=new c.QuadTreeCache(sparqlService,geoMapFactory,concept,null,quadTreeConfig);this.hashToCache[k]=l}var i=l.fetchData(j);var g=i.pipe(function(m){var n=new c.ViewState(sparqlService,h,concept,j,m);return n});return g}});c.AugmenterLookup=Class.create({initialize:function(i,h,g){this.lookupService=i;this.itemToKeyFn=h||function(j){return j.id};this.mergeFn=g||function(l,k){var j=_(l).extend(k);return j}},augment:function(i){var h=jQuery.Deferred();var j=_(i).map(this.itemToKeyFn);var g=this;this.lookupService.lookup(j).pipe(function(n){for(var l=0;l<j.length;++l){var k=j[l];var m=i[l];var o=n.get(k);i[l]=g.mergeFn(m,o)}h.resolve(i)}).fail(function(){h.fail()});return h.promise()}})})();(function(){var ns=Jassa.sparql;ns.evaluators={"&&":function(){}};ns.ExprEvaluator=Class.create({eval:function(expr,binding){throw"Not overridden"}});ns.ExprEvaluatorImpl=Class.create(ns.ExprEvaluator,{eval:function(expr,binding){var result;if(expr.isVar()){var e=expr.getExprVar();result=this.evalExprVar(e,binding)}else{if(expr.isFunction()){var e=expr.getFunction();result=this.evalExprFunction(e,binding)}else{if(expr.isConstant()){var e=expr.getConstant();result=this.evalConstant(e,binding)}else{throw"Unsupported expr type"}}}return result},evalExprVar:function(expr,binding){var v=expr.asVar();var node=binding.get(v);var result;if(node==null){return ns.NodeValue.nvNothing}else{result=ns.NodeValue.makeNode(node)}return result},evalExprFunction:function(expr,binding){},evalNodeValue:function(expr,binding){}})})();(function(d){var b=Jassa.service;var c=Jassa.client;c.ConceptPathFinderApi=Class.create({initialize:function(i,g,e,f,h){this.apiUrl=i;this.sparqlServiceIri=g;this.defaultGraphIris=e;this.joinSummaryServiceIri=f;this.joinSummaryGraphIris=h},createAjaxConfig:function(g,f){var e={"service-uri":this.sparqlServiceIri,"default-graph-uri":this.defaultGraphIris,"source-element":g.getElement().toString(),"source-var":g.getVar().getName(),"target-element":f.getElement().toString(),"target-var":f.getVar().getName(),"js-service-uri":this.joinSummaryServiceIri,"js-graph-uri":this.joinSummaryGraphIris};return e},createSparqlService:function(g,f){var h=this.createAjaxConfig(g,f);var e=new b.SparqlServiceHttp(this.apiUrl,this.defaultGraphIris,null,h);return e},findPaths:function(g,f){var i=this.createAjaxConfig(g,f);var h={url:this.apiUrl,dataType:"json",crossDomain:true,traditional:true,data:i};var e=d.ajax(h).pipe(function(n){var j=[];for(var k=0;k<n.length;++k){var l=n[k];var m=facete.Path.parse(l);j.push(m)}return j});return e},findPathsOldApi:function(g,f){var i={service:{serviceIri:this.sparqlServiceIri,defaultGraphIris:this.defaultGraphIris},sourceConcept:{elementStr:g.getElement().toString(),varName:g.getVar().value},targetConcept:{elementStr:f.getElement().toString(),varName:f.getVar().value}};var h={url:this.apiUrl,dataType:"json",data:{query:JSON.stringify(i)}};var e=d.ajax(h).pipe(function(n){var j=[];for(var k=0;k<n.length;++k){var l=n[k];var m=facete.Path.parse(l);j.push(m)}return j});return e}})})(jQuery);(function(){var b=Jassa.sponate;b.MapList=Class.create({initialize:function(){this.items=[];this.keyToIndex={}},put:function(d,e){if(d==null){console.log("key must not be null");throw"Bailing out"}var c=this.keyToIndex[d];if(c){console.log("Index already existed");throw"Bailing out"}c=this.items.length;this.items.push(e);this.keyToIndex[d]=c},get:function(e){var d=this.keyToIndex[e];var c=(d==null)?null:this.items[d];return c},getByIndex:function(c){return this.items[c]},getItems:function(){return this.items},getKeyToIndex:function(){return this.keyToIndex}})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var util=Jassa.util;var ns=Jassa.sponate;ns.AccumulatorFactoryFn=Class.create({classLabel:"AccumulatorFactoryFn",initialize:function(fn,referencedVars){this.fn=fn;this.referencedVars=referencedVars},createAggregator:function(){var result=new ns.AccumulatorFn(this.fn,this.referencedVars);return result},getVarsMentioned:function(){return this.referencedVars}});ns.AccumulatorFn=Class.create({classLabel:"AccumulatorFn",initialize:function(fn){this.fn=fn;this.node=null},processBinding:function(binding){var val=this.fn(binding);this.node=val},getJson:function(retainRdfNodes){return this.node},toNode:function(){return this.node}});ns.AttrPath=Class.create({classLabel:"AttrPath",initialize:function(steps){this.steps=steps?steps:[]},getSteps:function(){return this.steps},toString:function(){return this.steps.join(".")},slice:function(start,end){var result=this.steps.slice(start,end);return result},first:function(){return this.steps[0]},at:function(index){return this.steps[index]},isEmpty:function(){return this.steps.length==0},size:function(){return this.steps.length},concat:function(that){var tmp=this.steps.concat(that.getSteps());var result=new ns.AttrPath(tmp);return result},find:function(doc){var result=doc;var steps=this.steps;for(var i=0;i<steps.length;++i){var attr=steps[i];if(!_(result).isObject()){console.log("[ERROR] Cannot access attribute of non-object",this.steps,doc,result);throw"Bailing out"}result=result[attr]}return result}});ns.AttrPath.parse=function(str){var steps=str.split(".");return new ns.AttrPath(steps)};ns.callVisitor=function(name,self,args){var visitor=args[0];var fn=visitor[name];if(!fn){console.log("[ERROR] No visitor with name "+name+" in ",self);throw"Bailing out"}var tmp=Array.prototype.slice.call(args,1);var xargs=[self].concat(tmp);var result=fn.apply(visitor,xargs);return result};ns.Pattern=Class.create({classLabel:"Pattern",callVisitor:function(name,self,args){var result=ns.callVisitor(name,self,args);return result},getClassName:function(){throw"override me"},toString:function(){return"override me"},getVarsMentioned:function(){throw"override me"},getSubPatterns:function(){throw"override me"},$getReferences:function(result){throw"override me"},findPattern:function(rawAttrPath,start){var attrPath;if(_(attrPath).isString()){attrPath=ns.AttrPath.parse(rawAttrPath)}else{attrPath=rawAttrPath}start=start?start:0;var result;var pathLength=attrPath.size();if(start>pathLength){console.log("[ERROR] Start in path "+start+" greater than path length "+pathLength)}else{if(start==pathLength){result=this}else{result=this.$findPattern(attrPath,start)}}return result},$findPattern:function(attrPath,start){console.log('[ERROR] "findPattern" for path "'+attrPath+'" is not supported on this kind of object: '+JSON.stringify(this));throw"Bailing out"}});ns.PatternUtils={getRefs:function(pattern){var result=[];var fn=function(pattern){var proceed=true;if(pattern instanceof ns.PatternRef){result.push(pattern);proceed=false}return proceed};util.TreeUtils.visitDepthFirst(pattern,ns.PatternUtils.getChildren,fn);return result},getChildren:function(pattern){return pattern.getSubPatterns()}};ns.PatternCustomAgg=Class.create(ns.Pattern,{classLabel:"PatternCustomAgg",initialize:function(customAggFactory){this.customAggFactory=customAggFactory},getCustomAggFactory:function(){return this.customAggFactory},getClassName:function(){return"PatternCustomAgg"},getVarsMentioned:function(){var result=this.customAggFactory.getVarsMentioned();return result},getSubPatterns:function(){return[]}});ns.PatternLiteral=Class.create(ns.Pattern,{classLabel:"PatternLiteral",initialize:function(expr,aggregatorName){this.expr=expr;this.aggregatorName=aggregatorName},getClassName:function(){return"PatternLiteral"},getExpr:function(){return this.expr},toString:function(){return""+this.expr},getVarsMentioned:function(){var result=this.expr.getVarsMentioned();return result},getSubPatterns:function(){return[]}});ns.PatternObject=Class.create(ns.Pattern,{classLabel:"PatternObject",initialize:function(attrToPattern){this.attrToPattern=attrToPattern},getClassName:function(){return"PatternObject"},getMembers:function(){return this.attrToPattern},getPattern:function(attr){return this.attrToPattern[attr]},toString:function(){var parts=[];_(this.attrToPattern).each(function(v,k){parts.push('"'+k+'": '+v)});var result="{"+parts.join(",")+"}";return result},getVarsMentioned:function(){var result=[];var fnToString=(function(x){return x.toString()});_(this.attrToPattern).each(function(member,k){var vs=member.getVarsMentioned();if(!vs){console.log("[ERROR] Could not retrieve vars for member of pattern",this,member)}else{result=result.concat(vs)}});result=_.uniq(result,false,fnToString);return result},$findPattern:function(attrPath,start){var attr=attrPath.at(start);var pattern=this.attrToPattern[attr];var result;if(pattern){result=pattern.findPattern(attrPath,start+1)}else{result=null}return result},getSubPatterns:function(){var result=[];_.each(this.attrToPattern,function(member,k){result.push(member)});return result}});ns.PatternMap=Class.create(ns.Pattern,{classLabel:"PatternMap",initialize:function(keyExpr,subPattern,isArray){this.keyExpr=keyExpr;this.subPattern=subPattern;this._isArray=isArray},getClassName:function(){return"PatternMap"},getKeyExpr:function(){return this.keyExpr},getSubPattern:function(){return this.subPattern},isArray:function(){return this._isArray},toString:function(){var result="["+this.subPattern+" / "+this.keyExpr+"/"+this.type+"]";return result},getVarsMentioned:function(){var result=this.subPattern.getVarsMentioned();return result},getSubPatterns:function(){return[this.subPattern]},$findPattern:function(attrPath,start){var result=this.subPattern.findPattern(attrPath,start);return result}});ns.PatternRef=Class.create(ns.Pattern,{classLabel:"PatternRef",initialize:function(stub){this.stub=stub;this.refSpec=null},getClassName:function(){return"PatternRef"},getStub:function(){return this.stub},setRefSpec:function(refSpec){this.refSpec=refSpec},getRefSpec:function(){return this.refSpec},toString:function(){return JSON.stringify(this)},getVarsMentioned:function(){var result=[];var stub=this.stub;if(stub.joinColumn!=null){var v=rdf.Node.v(stub.joinColumn.substr(1));result.push(v)}else{console.log("[ERROR] No join column declared; cannot get variable");throw"Bailing out"}return result},getSubPatterns:function(){return[]}});ns.JoinTableRef=Class.create({initialize:function(tableName,sourceColumns,targetColumns){this.tableName=tableName;this.sourceColumns=sourceColumns;this.targetColumns=targetColumns},getTableName:function(){return this.tableName},getSourceColumns:function(){return this.sourceColumns},getTargetColumns:function(){return this.targetColumns},toString:function(){var result="("+this.sourceColumns.join(", ")+") "+this.tableName+" ("+this.targetJoinColumns.join()+")";return result}});ns.TableRef=Class.create({initialize:function(tableName,columnNames){this.tableName=tableName;this.columnNames=columnNames},getTableName:function(){return this.tableName},getColumnNames:function(){return this.columnNames},toString:function(){var result=this.tableName+"("+this.columnNames.join(", ")+")";return result}});ns.MapRef=Class.create({initialize:function(mapName,tableRef,attrPath){this.mapName=mapName;this.tableRef=tableRef},getMapName:function(){return this.mapName},getTableRef:function(){return this.tableRef},getAttrPath:function(){return this.attrPath},toString:function(){var result=this.patternRef+"/"+this.tableRef+"@"+this.attrPath;return result}});ns.RefSpec=Class.create({initialize:function(sourceMapRef,targetMapRef,isArray,joinTableRef){this.sourceMapRef=sourceMapRef;this.targetMapRef=targetMapRef;this.isArray=isArray;this.joinTableRef=joinTableRef},getSourceMapRef:function(){return this.sourceMapRef},getTargetMapRef:function(){return this.targetMapRef},isArray:function(){return this.isArray},getJoinTableRef:function(){return this.joinTableRef},toString:function(){var result=this.sourceMapRef+" references "+this.targetMapRef+" via "+this.joinTableRef+" as array? "+this.isArray;return result}});ns.Aggregator=Class.create({classLabel:"Aggregator",getPattern:function(){throw"override me"},getJson:function(retainRdfNodes){throw"override me"}});ns.AggregatorCustomAgg=Class.create(ns.Aggregator,{classLabel:"AggregatorCustomAgg",initialize:function(patternCustomAgg,customAgg){this.customAgg=customAgg;this.patternCustomAgg=patternCustomAgg},getPattern:function(){return this.patternCustomAgg},process:function(binding,context){this.customAgg.processBinding(binding)},getJson:function(retainRdfNodes){var result=this.customAgg.getJson(retainRdfNodes);return result}});ns.AggregatorLiteral=Class.create(ns.Aggregator,{classLabel:"AggregatorLiteral",initialize:function(patternLiteral){this.patternLiteral=patternLiteral;this.node=null},getPattern:function(){return this.patternLiteral},process:function(binding,context){var expr=this.patternLiteral.getExpr();var exprEvaluator=context.exprEvaluator;var ex=exprEvaluator.eval(expr,binding);if(ex.isConstant()){var c=ex.getConstant();var node=c.asNode();this.setNode(node)}else{console.log("[ERROR] Could not evaluate to constant");throw"Bailing out"}},setNode:function(newNode){var oldNode=this.node;if(oldNode==null){this.node=newNode}else{if(!oldNode.equals(newNode)){console.log("[ERROR] Value already set: Attempted to override "+oldNode+" with "+newNode)}}},getJson:function(retainRdfNodes){var result;var node=this.node;if(node){if(retainRdfNodes){result=node}else{if(node.isUri()){result=node.toString()}else{if(node.isLiteral()){result=node.getLiteralValue();if(result instanceof rdf.TypedValue){result=result.getLexicalValue()}}else{if(sparql.NodeValue.nvNothing.asNode().equals(node)){result=null}else{console.log("[ERROR] Unsupported node types: ",node);throw"Unsupported node type"}}}}}return result}});ns.AggregatorObject=Class.create(ns.Aggregator,{classLabel:"AggregatorObject",initialize:function(patternObject,attrToAggr){this.patternObject=patternObject;this.attrToAggr=attrToAggr},process:function(binding,context){_(this.attrToAggr).each(function(aggr,attr){aggr.process(binding,context)})},getJson:function(retainRdfNodes){var result={};_(this.attrToAggr).each(function(aggr,attr){var json=aggr.getJson(retainRdfNodes);result[attr]=json});return result}});ns.AggregatorMap=Class.create(ns.Aggregator,{classLabel:"AggregatorMap",initialize:function(patternMap){this.patternMap=patternMap;this.keyToAggr=new ns.MapList()},getPattern:function(){return this.patternMap},process:function(binding,context){var pattern=this.patternMap;var keyExpr=pattern.getKeyExpr();var subPattern=pattern.getSubPattern();var isArray=pattern.isArray();var exprEvaluator=context.exprEvaluator;var aggregatorFactory=context.aggregatorFactory;var keyEx=exprEvaluator.eval(keyExpr,binding);if(!keyEx.isConstant()){console.log("[ERROR] Could not evaluate key to a constant "+JSON.stringify(keyEx)+" with binding "+binding);throw"Bailing out"}var key=keyEx.getConstant().asNode();var keyStr=""+key;var aggr=this.keyToAggr.get(keyStr);if(aggr==null){aggr=aggregatorFactory.create(subPattern);this.keyToAggr.put(keyStr,aggr)}aggr.process(binding,context)},getJson:function(retainRdfNodes){var result;var isArray=this.patternMap.isArray();if(isArray){result=this.getJsonArray(retainRdfNodes)}else{result=this.getJsonMap(retainRdfNodes)}return result},getJsonArray:function(retainRdfNodes){var aggrs=this.keyToAggr.getItems();var result=aggrs.map(function(aggr){var data=aggr.getJson(retainRdfNodes);return data});return result},getJsonMap:function(retainRdfNodes){var result={};var aggrs=this.keyToAggr.getItems();var keyToIndex=this.keyToAggr.getKeyToIndex();_(keyToIndex).each(function(index,aggr){var aggr=items[index];var data=aggr.getJson(retainRdfNodes);result[key]=data});return result}});ns.AggregatorRefCounter=0;ns.AggregatorRef=Class.create(ns.Aggregator,{classLabel:"AggregatorRef",initialize:function(patternRef){this.name=""+(ns.AggregatorRefCounter++);this.patternRef=patternRef;this.json=null;this.bindings=[]},getName:function(){return this.name},process:function(binding,context){this.bindings.push(binding)},getJson:function(retainRdfNodes){return this.json},setJson:function(json){this.json=json}});ns.AggregatorFactory=Class.create({classLabel:"AggregatorFactory",initialize:function(){},create:function(pattern){var fnName="visit"+pattern.getClassName();var fn=this[fnName];if(!fn){console.log('[ERROR] Function with name "'+fnName+'" not found.');throw"Bailing out"}var result=fn.call(this,pattern);return result},visitPatternObject:function(patternObject){var attrToAggr={};var self=this;var members=patternObject.getMembers();_(members).each(function(attrPattern,attr){var aggr=self.create(attrPattern);attrToAggr[attr]=aggr});var result=new ns.AggregatorObject(patternObject,attrToAggr);return result},visitPatternArray:function(pattern){return ns.AggregatorArray(pattern)},visitPatternMap:function(patternMap){return new ns.AggregatorMap(patternMap)},visitPatternLiteral:function(patternLiteral){return new ns.AggregatorLiteral(patternLiteral)},visitPatternRef:function(patternRef){return new ns.AggregatorRef(patternRef)},visitPatternCustomAgg:function(patternCustomAgg){var customAgg=patternCustomAgg.getCustomAggFactory().createAggregator();return new ns.AggregatorCustomAgg(patternCustomAgg,customAgg)}});ns.RegistryRef=Class.create({initialize:function(){},addRef:function(aggergatorRef,binding){}});ns.AggregatorFacade=Class.create({initialize:function(pattern){this.context={exprEvaluator:new sparql.ExprEvaluatorImpl(),aggregatorFactory:new ns.AggregatorFactory(),refRegistry:new ns.RegistryRef()};this.rootAggregator=this.context.aggregatorFactory.create(pattern)},process:function(binding){this.rootAggregator.process(binding,this.context)},getJson:function(retainRdfNodes){var result=this.rootAggregator.getJson(retainRdfNodes);return result}});ns.ParserPattern=Class.create({initialize:function(){this.attrs={id:"id",ref:"ref"}},parseArray:function(val){if(val.length!=1){console.log("[ERROR] Arrays must have exactly one element that is either a string or an object",val);throw"Bailing out"}var config=val[0];var result;if(_(config).isString()){result=this.parseArrayLiteral(config)}else{if(_(config).isObject()){result=this.parseArrayConfig(config)}else{throw"Bailing out"}}return result},parseArrayConfig:function(config){var idAttr=this.attrs.id;var refAttr=this.attrs.ref;var hasId=config[idAttr]!=null;var hasRef=config[refAttr]!=null;if(hasId&&hasRef){console.log("[ERROR] id and ref are mutually exclusive");throw"Bailing out"}var result;if(hasId){var subPattern=this.parseObject(config);var idPattern=subPattern.getPattern(idAttr);var idExpr=idPattern.getExpr();result=new ns.PatternMap(idExpr,subPattern,true)}else{if(hasRef){result=this.parseArrayRef(config)}else{console.log("[ERROR] Not implemented");throw"Bailing out"}}return result},parseArrayRef:function(config){var result=new ns.PatternRef(config);return result},parseArrayLiteral:function(){},parseLiteral:function(val){var expr=this.parseExprString(val);var result=new ns.PatternLiteral(expr);return result},parseObject:function(val){var attrToPattern={};var self=this;_(val).each(function(v,attr){var v=val[attr];var subPattern=self.parsePattern(v);attrToPattern[attr]=subPattern});var result=new ns.PatternObject(attrToPattern);return result},parsePattern:function(val){var result;if(_(val).isString()){result=this.parseLiteral(val)}else{if(_(val).isArray()){result=this.parseArray(val)}else{if(_(val).isFunction()){result=new ns.PatternCustomAgg(new ns.AccumulatorFactoryFn(val))}else{if(val instanceof rdf.Node&&val.isVariable()){var expr=new sparql.ExprVar(val);result=new ns.PatternLiteral(expr)}else{if(val instanceof sparql.Expr){result=new ns.PatternLiteral(expr)}else{if(_(val).isObject()){var fnCustomAggFactory=val.createAggregator;if(fnCustomAggFactory){result=new ns.PatternCustomAgg(val)}else{result=this.parseObject(val)}}else{console.log("[ERROR] Unknown item type: ",val);throw"Unkown item type"}}}}}}return result},parseExpr:function(obj){var result;if(_.isString(obj)){result=this.parseExprString(obj)}return result},parseExprString:function(str){var result;if(_(str).startsWith("?")){var varName=str.substr(1);var v=sparql.Node.v(varName);result=new sparql.ExprVar(v)}else{result=sparql.NodeValue.makeString(str)}return result}});ns.parseExpr=function(str){}})();(function(){var c=Jassa.util;var d=Jassa.rdf;var f=Jassa.sparql;var b=Jassa.service;var g=Jassa.facete;var e=Jassa.sponate;e.QueryConfig=Class.create({initialize:function(m,h,l,k,j,i){this.criteria=m;this.limit=h;this.offset=l;this.concept=k;this._isLeftJoin=j;this.nodes=i},shallowClone:function(){var h=new e.QueryConfig(this.criteria,this.limit,this.offset,this.concept,this._isLeftJoin,this.nodes);return h},getCriteria:function(){return this.criteria},setCriteria:function(h){this.criteria=h},getLimit:function(){return this.limit},setLimit:function(h){this.limit=h},getOffset:function(){return this.offset},setOffset:function(h){this.offset=h},getConcept:function(){return this.concept},setConcept:function(h){this.concept=h},isLeftJoin:function(){return this._isLeftJoin},setLeftJoin:function(h){this._isLeftJoin=h},getNodes:function(){return this.nodes},setNodes:function(h){this.nodes=h}});e.Cursor=Class.create({hasNext:function(){},next:function(){},forEach:function(i){while(this.hasNext()){var h=this.next();i(h)}}});e.CursorFlow=Class.create({hasNext:function(){},skip:function(h){},limit:function(h){},sort:function(h){}});e.QueryFlow=Class.create({initialize:function(h,i){this.store=h;this.config=new e.QueryConfig();this.config.setCriteria(i)},concept:function(h,i){this.config.setConcept(h);this.config.setLeftJoin(i);return this},nodes:function(h){this.config.setNodes(h);return this},skip:function(h){this.config.setOffset(h);return this},limit:function(h){this.config.setLimit(h);return this},offset:function(h){this.config.setOffset(h);return this},asList:function(i){var j=this.execute(i);var h=j.pipe(function(l){var k=[];while(l.hasNext()){k.push(l.next())}return k});return h},hasNext:function(){},next:function(){},execute:function(i){var h=this.store.execute(this.config,i);return h},count:function(){var h=this.store.executeCount(this.config);return h}});e.Store=Class.create({initialize:function(h,i,j,k){this.sparqlService=h;this.context=i;this.mappingName=j;this.cacheFactory=k},find:function(i){var j=this.context.getCriteriaParser();var k=j.parse(i);var h=new e.QueryFlow(this,k);return h},getByIds:function(h){},getByConcept:function(i,h){},createQuerySpec:function(M){var k=this.context;var p=M.getCriteria();var H=M.getLimit();var o=M.getOffset();var B=M.getConcept();var v=M.isLeftJoin();var y=M.getNodes();var t=this.context.getMapping(this.mappingName);e.ContextUtils.resolveMappingRefs(this.context,t);console.log("Refs: ",t.getPatternRefs());var j=new e.CriteriaCompilerSparql();var E=j.compile(k,t,p);console.log("Compiled criteria: "+E,E);var l=t.getElementFactory();var i=l.createElement();if(E){}var C=t.getPattern();var w=C.getVarsMentioned();var J;if(C instanceof e.PatternMap){J=C.getKeyExpr()}var s=[];if(J!=null){var h=new f.SortCondition(J,1);s.push(h)}var G;if(!(J instanceof f.ExprVar)){console.log("[ERROR] Currently the idExpr must be a variable. This restriction may be lifted in the future");throw"Bailing out"}G=J.asVar();var n=H!=null||o!=null||E.length>0;var F=i;var q=new g.Concept(F,G);var A;var z;if(!B){A=q}else{if(!v){A=g.ConceptUtils.createCombinedConcept(q,B,true)}else{if(E.length>0){A=g.ConceptUtils.createCombinedConcept(q,B,true,true)}else{A=g.ConceptUtils.createRenamedConcept(q,B)}}}if(E.length>0){var I=(E.length>0)?new f.ElementFilter(E):null;var L=[A.getElement(),I];var m=new f.ElementGroup(L);A=new g.Concept(m,A.getVar())}console.log("[INFO] SponateCoreConcept "+A);var K=A.getElement();if(n){var D=new f.Query();D.setQueryPattern(K);D.setLimit(H);D.setOffset(o);D.setDistinct(true);D.getProject().add(G);var x=i;if(v){x=new f.ElementOptional(i)}i=new f.ElementGroup([new f.ElementSubQuery(D),x]);F=K}else{i=K}var u={requireSubQuery:n,coreConcept:A,innerElement:F,outerElement:i,idVar:G,idExpr:J,vars:w,sortConditions:s,pattern:C,criteria:p,nodes:y};return u},execute:function(k,j){var i=this.createQuerySpec(k);var h=this.executeData(i,j);return h},executeCount:function(k){var j=this.createQuerySpec(k);if(j.nodes){console.log("Counting if nodes are provided is not implemented yet");throw"Counting if nodes are provided is not implemented yet"}var l=j.coreConcept;var i=k.getLimit();var h=b.ServiceUtils.fetchCountConcept(this.sparqlService,l,i);return h},executeData:function(v,s){var k=v.outerElement;var q=v.idExpr;var u=v.idVar;var j=v.sortConditions;var m=v.vars;var n=v.pattern;var t=v.criteria;var p=new f.Query();p.getElements().push(k);_(m).each(function(x){p.getProject().add(x)});if(q!=null){var o=new f.SortCondition(q,1);var i=p.getOrderBy();i.push.apply(i,j)}var l;if(v.nodes){l=b.ServiceUtils.execSelectForNodes(this.sparqlService,p,u,v.nodes)}else{var h=this.sparqlService.createQueryExecution(p);l=h.execSelect()}var w=l.pipe(function(x){var y=e.SponateUtils.processResultSet(x,n,s,false);return y});return w}});e.QueryPlan=Class.create({initialize:function(){}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.Table=Class.create({initialize:function(d,f,e){this.name=d;this.columnNames=f;this.schema=e},getName:function(){return this.name},getColumnNames:function(){return this.columnNames},getSchema:function(){return this.schema},toString:function(){return this.name+"("+this.columnNames.join(", ")+")"}});b.SparqlParserFake=Class.create({initialize:function(){this.prefixes={}},parseElement:function(f){var e=c.extractSparqlVars(f);var d=b.ElementString.create(f,e)}});b.Schema=Class.create({initialize:function(){this.nameToTable={}},addTable:function(e){var d=e.getName();this.nameToTable[d]=e},getTable:function(e){var d=this.nameToTable[e];return d}});b.Context=Class.create({initialize:function(d){this.schema=d?d:new b.Schema();this.prefixMapping=new c.PrefixMappingImpl();this.tableNameToElementFactory={};this.nameToMapping={};this.patternParser=new b.ParserPattern();this.criteriaParser=new b.CriteriaParser()},getSchema:function(){return this.schema},getPrefixMapping:function(){return this.prefixMapping},getPatternParser:function(){return this.patternParser},getTableNameToElementFactory:function(){return this.tableNameToElementFactory},getNameToMapping:function(){return this.nameToMapping},mapTableNameToElementFactory:function(e,d){this.tableNameToElementFactory[e]=d},addMapping:function(e,d){this.nameToMapping[e]=d},getMapping:function(e){var d=this.nameToMapping[e];return d},getElementFactory:function(e){var d=this.tableNameToElementFactory[e];return d},getCriteriaParser:function(){return this.criteriaParser}});b.ContextUtils={createTable:function(e,d,f){var g=e.getPrefixMapping().getNsPrefixMap();var i=c.extractSparqlVars(f);var j=c.expandPrefixes(g,f);var h=c.ElementString.create(j,i);var l=i.map(function(m){return m.toString()});var k=new b.Table(d,l);e.getSchema().addTable(k);e.mapTableNameToElementFactory(d,h)},resolveMappingRefs:function(e,d){var f=d.getPatternRefs();_(f).each(function(g){var h=g.getStub();var i=b.ContextUtils.createRefSpec(d,h,e);g.setRefSpec(i)})},createRefSpec:function(e,f,g){var q=g.getSchema();var o=e.getName();var x=f.ref;var v=g.getMapping(x);if(v==null){console.log("[ERROR] Target mapping "+v+" not defined");throw"Bailing out"}var k=e.getTableName();var p=v.getTableName();var t=q.getTable(k);var m=q.getTable(p);var n=f.card!=1;var s;var j;if(f.joinColumn){s=[f.joinColumn]}if(f.refJoinColumn){j=[f.refJoinColumn]}var u=f.joinTable;if(u!=null){console.log("[ERROR] Implement me");throw"Bailing out"}var w=new b.TableRef(k,s);var i=new b.TableRef(p,j);var d=new b.MapRef(o,w,null);var h=new b.MapRef(x,i,null);var l=new b.RefSpec(d,h,n,null);return l}}})();(function(){var d=Jassa.sparql;var b=Jassa.util;var c=Jassa.sponate;c.MapParser=Class.create({initialize:function(f,e){this.prefixMapping=f;this.patternParser=e||new c.ParserPattern()},parseMap:function(f){var e=c.SponateUtils.parseMap(f,this.prefixMapping,this.patternParser);return e}});c.SponateUtils={processResultSet:function(g,i,k,f){var e=new c.AggregatorFacade(i);while(g.hasNext()){var j=g.nextBinding();e.process(j)}var o=e.getJson(k);var p;if(_(o).isArray()){var h=o;if(f&&!k){h=_(o).filter(function(s){var q=criteria.match(s);return q});var l=o.length;var n=h.length;var m=l-n;console.log("[DEBUG] "+m+" items filtered on the client ("+n+"/"+l+" remaining) using criteria "+JSON.stringify(criteria))}p=new b.IteratorArray(h)}else{console.log("[ERROR] Implement me");throw"Implement me"}return p},parseMap:function(s,i,p){var e=s.name;var l=s.template;var q=s.from;var f=this.context;var o;if(_(q).isString()){var g=q;if(i!=null){var k=i.getNsPrefixMap();var n=d.expandPrefixes(k,g)}var j=d.ElementString.create(n);o=new d.ElementFactoryConst(j)}else{if(q instanceof d.Element){o=new d.ElementFactoryConst(q)}else{if(q instanceof d.ElementFactory){o=q}else{console.log('[ERROR] Unknown argument type for "from" attribute',q);throw"Bailing out"}}}var m=p.parsePattern(l);var h=c.PatternUtils.getRefs(m);var t=new c.Mapping(e,m,o,h);return t},defaultPrefLangs:["en",""],prefLabelPropertyUris:["http://www.w3.org/2000/01/rdf-schema#label"],createDefaultLabelMap:function(g,i,m,e,f){g=g||c.SponateUtils.defaultPrefLangs;i=i||c.SponateUtils.prefLabelPropertyUris;m=m||"s";e=e||"p";f=f||"o";var j=new c.MapParser();var h=new c.LabelUtilFactory(i,g);var k=h.createLabelUtil(f,m,e);var l=j.parseMap({name:"labels",template:[{id:"?"+m,displayLabel:k.getAggFactory(),hiddenLabels:[{id:"?"+f}]}],from:k.getElement()});return l}};c.JoinElement=Class.create({initialize:function(e,f){this.element=e}});c.JoinUtils={join:function(i,g,h){var f=eleA.getVarsMentioned();var e=eleB.getVarsMentioned()},createMappingJoin:function(f,l){var k=new d.GenSym("a");var g=k.next();var h={};var o={};h[g]={mapping:l,aggs:[]};var i=[a];while(i.isEmpty()){var j=i.shift();var e=h[j];var n=e.mapping;c.ContextUtils.resolveMappingRefs(this.context,n);var m=this.mapping.getPatternRefs();_(m).each(function(s){var v=s.getTargetMapRef();var q=k.next();h[q]={mapping:targetMapping};var u=o[j];if(u==null){u=[];o[j]=u}var t={targetAlias:q,isTransient:true};u.push(t)});var p={aliasToState:h,aliasToJoins:o};return p}}};c.GraphItem=Class.create({initialize:function(e,f){this.graph=e;this.id=f},getGraph:function(){return this.graph},getId:function(){return this.id}});c.Node=Class.create(c.GraphItem,{initialize:function($super,e,f){$super(e,f)},getOutgoingEdges:function(){var e=this.graph.getEdges(this.id);return e}});c.Edge=Class.create({initialize:function(f,h,e,g){this.graph=f;this.id=h;this.nodeIdFrom=e;this.nodeIdTo=g},getNodeFrom:function(){var e=this.graph.getNode(this.nodeIdFrom);return e},getNodeTo:function(){var e=this.graph.getNode(this.nodeIdTo);return e}});c.Graph=Class.create({initialize:function(f,e){this.fnCreateNode=f;this.fnCreateEdge=e;this.idToNode={};this.nodeIdToEdgeIdToEdge={};this.idToEdge={};this.nextNodeId=1;this.nextEdgeId=1},createNode:function(){var h=""+(++this.nextNodeId);var f=Array.prototype.slice.call(arguments,0);var g=[this,h].concat(f);var e=this.fnCreateNode.apply(this,g);this.idToNode[h]=e;return e},createEdge:function(g,i){var j=""+(++this.nextEdgeId);var f=Array.prototype.slice.call(arguments,0);var h=[this.graph,g,i].concat(f);var e=this.fnEdgeNode.apply(this,h);var k=this.nodeIdToEdgeIdToEdge[edges];if(k==null){k={};this.nodeIdToEdgeIdToEdge=k}k[j]=e;this.idToEdge[j]=e;return e}});c.NodeJoinElement=Class.create(c.Node,{initialize:function($super,g,h,f,e){$super(g,h);this.element=f;this.alias=e},getElement:function(){return this.element},getAlias:function(){return this.alias}});c.fnCreateMappingJoinNode=function(e,f){console.log("Node arguments:",arguments);return new c.MappingJoinNode(e,f)};c.fnCreateMappingEdge=function(e,f){return new c.MappingJoinEdge(e,f)};c.JoinGraphElement=Class.create(c.Graph,{initialize:function($super){$super(c.fnCreateMappingJoinNode,c.fnCreateMappingEdge)}});c.RowMapperAlias=Class.create({initialize:function(e){this.aliasToVarMap=e},map:function(g){var f=g.getVars();var e={};_(this.aliasToVarMap).each(function(k,i){var h=new d.Binding();e[i]=h;var l=k.getInverse();var j=l.keyList();_(j).each(function(o){var n=l.get(o);var m=g.get(o);h.put(n,m)})});return e}});c.MappingJoinEdge=Class.create(c.Edge,{initialize:function($super,e,f){$super(e,e,f)}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.Mapping=Class.create({classLabel:"jassa.sponate.Mapping",initialize:function(e,g,d,f){this.name=e;this.pattern=g;this.elementFactory=d;this.patternRefs=f||[]},getName:function(){return this.name},getPattern:function(){return this.pattern},getElementFactory:function(){return this.elementFactory},getPatternRefs:function(){return this.patternRefs},toString:function(){var d="[pattern: "+this.pattern+", element: "+this.elementFactory.createElement()+"]";return d}});b.StoreFacade=Class.create({initialize:function(d,e){this.service=d;this.context=new b.Context();e=e||{};this.context.getPrefixMapping().setNsPrefixes(e)},addMap:function(f,e){var d=(f instanceof b.Mapping)?this.addMapObj(e,f):this.addMapSpec(f);return d},addMapObj:function(e,f){var d=f.getElementFactory();this.context.mapTableNameToElementFactory(e,d);this.context.addMapping(e,f);this.createStore(e);return this},addMapSpec:function(e){var g=b.SponateUtils.parseMap(e,this.context.getPrefixMapping(),this.context.getPatternParser());var f=e.name;var d=this.addMapObj(f,g);return d},createStore:function(d){if(d in this){console.log("[ERROR] An attribute / store with name "+d+" already exists");throw"Bailing out"}this[d]=new b.Store(this.service,this.context,d)},getSchema:function(){return schema}})})();(function(){var b=Jassa.sponate;b.CriteriaParser=Class.create({parse:function(d){var e=new b.AttrPath();var c=this.parseAny(d,e);return c},parseAny:function(d,e){var c;if(d==null){c=new b.CriteriaTrue()}else{if(_(d).isObject()){c=this.parseObject(d,e)}else{if(_(d).isArray()){throw"Not implemented"}else{c=this.parse_$eq(e,d)}}}return c},parseObject:function(g,h){var d=this;var e=g["$options"];var f=_(g).chain().omit("$options").map(function(m,i){var o;if(_(i).startsWith("$")){var n="parse_"+i;var j=d[n];if(!j){console.log("[ERROR] No criteria implementation for "+i);throw"Bailing out"}o=j.call(d,h,m,e)}else{var k=b.AttrPath.parse(i);var l=h.concat(k);if(!m){console.log("[ERROR] No value for attribute "+i);throw"Bailing out"}o=d.parseAny(m,l)}return o}).value();var c;if(f.length==1){c=f[0]}else{c=new b.CriteriaLogicalAnd(new b.AttrPath(),f)}return c},parse_$eq:function(d,c){return new b.CriteriaEq(d,c)},parse_$gt:function(d,c){return new b.CriteriaGt(d,c)},parse_$gte:function(d,c){return new b.CriteriaGte(d,c)},parse_$lt:function(d,c){return new b.CriteriaLt(d,c)},parse_$lte:function(d,c){return new b.CriteriaLte(d,c)},parse_$ne:function(d,c){return new b.CriteriaNe(d,c)},parse_$regex:function(g,f,d){var e;if(_(f).isString()){e=new RegExp(f,d)}else{if(f instanceof RegExp){e=f}else{console.log("[ERROR] Not a regex: "+f);throw"Bailing out"}}var c=new b.CriteriaRegex(g,e);return c},parse_$elemMatch:function(g,f){var h=this.parse(f);var e;if(h instanceof b.CriteriaLogicalAnd){e=h.getCriterias()}else{e=[h]}var d=new b.CriteriaElemMatch(g,e);return d},parse_$or:function(g,f){if(!_(f).isArray()){console.log("Argument of $or must be an array");throw"Bailing out"}var d=this;var e=f.map(function(i){var h=d.parse(i);return h});var c;if(e.length==1){c=e[0]}else{c=new b.CriteriaLogicalOr(g,e)}return c}});b.Criteria=Class.create({getOpName:function(){throw"Not overridden"},match:function(c){throw"Not overridden"},callVisitor:function(f,d,e){var c=b.callVisitor(f,d,e);return c},accept:function(c){console.log("Not overridden");throw"Not overridden"}});b.CriteriaBase=Class.create(b.Criteria,{initialize:function(c){this.opName=c},getOpName:function(){return this.opName},accept:function(d){var c=b.callVisitor("visitCriteria"+this.opName,this,arguments);return c}});b.CriteriaFalse=Class.create(b.CriteriaBase,{initialize:function($super){$super("$false")},match:function(c){return false}});b.CriteriaTrue=Class.create(b.CriteriaBase,{initialize:function($super){$super("$true")},match:function(c){return true}});b.CriteriaPath=Class.create(b.CriteriaBase,{initialize:function($super,c,d){$super(c);this.attrPath=d;if(!d){throw"npe"}},getAttrPath:function(){return this.attrPath},match:function(d){var e=this.attrPath.find(d);var c=this.$match(d,e);return c},$match:function(c,d){throw"Not overridden"}});b.CriteriaPathValue=Class.create(b.CriteriaPath,{initialize:function($super,c,e,d){$super(c,e);this.value=d},getValue:function(){return this.value},toString:function(){return"("+this.attrPath+" "+this.opName+" "+this.value+")"}});b.CriteriaEq=Class.create(b.CriteriaPathValue,{initialize:function($super,d,c){$super("$eq",d,c)},$match:function(d,e){var c=e==this.value;return c}});b.CriteriaGt=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$gt",d);this.value=c},$match:function(d,e){var c=e>this.value;return c}});b.CriteriaGte=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$gte",d);this.value=c},$match:function(d,e){var c=e>=this.value;return c}});b.CriteriaLt=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$lt",d);this.value=c},$match:function(d,e){var c=e<this.value;return c}});b.CriteriaLte=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$lte",d);this.value=c},$match:function(d,e){var c=e<=this.value;return c}});b.CriteriaNe=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$ne",d);this.value=c},$match:function(d,e){var c=e!=this.value;return c}});b.CriteriaRegex=Class.create(b.CriteriaPath,{initialize:function($super,d,c){$super("$regex",d);this.regex=c},getRegex:function(){return this.regex},$match:function(d,e){var c=this.regex.test(e);return c}});b.CriteriaPathCollection=Class.create(b.CriteriaPath,{initialize:function($super,c,e,d){$super(c,e);this.criterias=d},getCriterias:function(){return this.criterias},toString:function(){return"["+this.criterias.join(", ")+"]"}});b.CriteriaLogicalAnd=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$and",d,c)},match:function(d){var c=_(this.criterias).every(function(f){var e=f.match(d);return e});return c}});b.CriteriaLogicalOr=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$or",d,c)},$match:function(d,e){var c=_(this.criterias).some(function(g){var f=g.match(e);return f});return c}});b.CriteriaElemMatch=Class.create(b.CriteriaPathCollection,{initialize:function($super,d,c){$super("$elemMatch",d,c)},$match:function(d,e){if(!_(e).isArray()){console.log("[ERROR] Cannon apply $elemMatch to non-array",e);throw"Bailing out"}console.log("$elemMatch "+this.attrPath);var c=this.matchArray(e);return c},matchArray:function(e){var d=this;var c=_(e).some(function(g){var f=_(d.criterias).every(function(i){var h=i.match(g);return h});return f});return c},accept:function(d){var c=this.callVisitor("visitElemMatch",this,arguments);return c}})})();(function(){var c=Jassa.sparql;var b=Jassa.sponate;b.CriteriaCompilerSparql=Class.create({compile:function(h,f,k){var e=f.getElementFactory();var g=e.createElement();var j=c.JoinBuilderElement.create(g);var d=[];console.log("Compile request for criteria: "+k+"; "+JSON.stringify(k));var i=f.getPattern();this.visitCriteria(k,i,h,j,d);return d},visitCriteria:function(j,g,e,h,d){var i="visitCriteria"+j.getOpName();var f=this[i];if(!f){console.log("Member not found: "+i);throw"Bailing out"}var d=f.call(this,j,g,e,h,d);return d},visitCriteria$elemMatch:function(k,j,d,g,m){var h=j.findPattern(k.getAttrPath());var l=this;var e=k.getCriterias();var i=[];_(e).each(function(p){var o=[];l.visitCriteria(p,h,d,g,o);var n=c.andify(o);i.push(n)});var f=c.orify(i);m.push(f)},getExpr:function(d){if(d instanceof b.PatternLiteral){var e=d.getExpr();return e}else{console.log("[ERROR] pattern type not supported yet");throw"Bailing out"}},visitEq:function(l,h,g,k,d){var f=h.findPattern(this.attrPath);var j=this.getExpr(f);var i=new c.E_Equals(new c.E_Str(j),c.NodeValue.makeString(ap.getValue()));d.push(i)},visitCriteria$and:function(k,i,h,j,d){console.log("Pattern: "+i);var g=i.findPattern(k.getAttrPath());var e=this;var f=k.getCriterias();_(f).each(function(l){e.visitCriteria(l,g,h,j,d)})},visitCriteria$or:function(k,j,d,g,m){var h=j.findPattern(k.getAttrPath());var l=this;var e=k.getCriterias();var i=[];_(e).each(function(p){var o=[];l.visitCriteria(p,h,d,g,o);var n=c.andify(o);i.push(n)});var f=c.orify(i);m.push(f)},visitCriteria$regex:function(m,l,d,h,p){var i=l.findPattern(m.getAttrPath());var j=m.getRegex().toString();var o=j.lastIndexOf("/");var f=j.substring(1,o);var g=j.substring(o+1);var n=this.getExpr(i);var k=new c.E_Regex(new c.E_Str(n),f,g);p.push(k)},visitCriteria$true:function(h,f,e,g,d){},visitRef:function(g,d,e,f){},visitGt:function(){}})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var ns=Jassa.sponate;var compareArray=function(as,bs,op){var zipped=_.zip(as,bs);var result=false;for(var i=0;i<zipped.length;++i){var item=zipped[i];var a=item[0];var b=item[1];if(op(a,b)){if(op(b,a)){continue}result=true;break}else{if(!op(b,a)){continue}result=false;break}}return result};var cmpLessThan=function(a,b){return a<b};ns.extractLabelFromUri=function(str){var a=str.lastIndexOf("#");var b=str.lastIndexOf("/");var i=Math.max(a,b);var result=(i===str.length)?str:str.substring(i+1);if(result===""){result=str}return result};ns.AggregatorFactoryLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.labelExpr=labelExpr;this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr},createAggregator:function(){var result=new ns.AggregatorLabel(this.labelPrios,this.prefLangs,this.labelExpr,this.subjectExpr,this.propertyExpr);return result},getVarsMentioned:function(){var vm=(function(expr){var result=expr?expr.getVarsMentioned():[];return result});var result=_.union(vm(this.labelExpr),vm(this.subjectExpr),vm(this.propertyExpr));return result}});ns.AggregatorLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr;this.labelExpr=labelExpr;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.bestMatchNode=null;this.bestMatchScore=[1000,1000]},processBinding:function(binding){var property=this.exprEvaluator.eval(this.propertyExpr,binding);var label=this.exprEvaluator.eval(this.labelExpr,binding);var subject=this.exprEvaluator.eval(this.subjectExpr,binding);if(this.bestMatchNode==null&&subject.isConstant()){this.bestMatchNode=subject.getConstant().asNode()}var propertyScore=-1;var langScore;var l;if(property&&property.isConstant()){var p=property.getConstant().asNode();if(p.isUri()){var propertyUri=p.getUri();propertyScore=this.labelPrios.indexOf(propertyUri)}}if(label&&label.isConstant()){l=label.getConstant().asNode();var lang=l.isLiteral()?l.getLiteralLanguage():"nolang";langScore=this.prefLangs.indexOf(lang)}var score=[propertyScore,langScore];var allNonNegative=_(score).every(function(item){return item>=0});if(allNonNegative){var cmp=compareArray(score,this.bestMatchScore,cmpLessThan);if(cmp===true){this.bestMatchScore=score;this.bestMatchNode=l}}},getNode:function(){return this.bestMatchNode},getJson:function(){var result=null;var bestMatchNode=this.bestMatchNode;if(bestMatchNode){if(bestMatchNode.isUri()){var uri=bestMatchNode.getUri();result=ns.extractLabelFromUri(uri)}else{result=bestMatchNode.getLiteralValue()}}return result}});ns.LabelUtil=Class.create({initialize:function(aggFactory,element){this.aggFactory=aggFactory;this.element=element},getAggFactory:function(){return this.aggFactory},getElement:function(){return this.element}});ns.LabelUtilFactory=Class.create({initialize:function(prefLabelPropertyUris,prefLangs){this.prefLabelPropertyUris=prefLabelPropertyUris;this.prefLangs=prefLangs;this.prefLabelProperties=_(this.prefLabelPropertyUris).map(function(uri){return rdf.NodeFactory.createUri(uri)})},createLabelUtil:function(labelVarName,subjectVarName,propertyVarName){var s=rdf.NodeFactory.createVar(subjectVarName);var p=rdf.NodeFactory.createVar(propertyVarName);var o=rdf.NodeFactory.createVar(labelVarName);var subjectExpr=new sparql.ExprVar(s);var propertyExpr=new sparql.ExprVar(p);var labelExpr=new sparql.ExprVar(o);var aggFactoryLabel=new ns.AggregatorFactoryLabel(this.prefLabelPropertyUris,this.prefLangs,labelExpr,subjectExpr,propertyExpr);var langTmp=_(this.prefLangs).map(function(lang){var r=new sparql.E_LangMatches(new sparql.E_Lang(labelExpr),sparql.NodeValue.makeString(lang));return r});var langConstraint=sparql.orify(langTmp);var propFilter=new sparql.E_OneOf(propertyExpr,this.prefLabelProperties);var els=[];els.push(new sparql.ElementTriplesBlock([new rdf.Triple(s,p,o)]));els.push(new sparql.ElementFilter(propFilter));els.push(new sparql.ElementFilter(langConstraint));var langElement=new sparql.ElementGroup(els);var result=new ns.LabelUtil(aggFactoryLabel,langElement);return result}})})();(function(){var rdf=Jassa.rdf;var sparql=Jassa.sparql;var ns=Jassa.sponate;var compareArray=function(as,bs,op){var zipped=_.zip(as,bs);var result=false;for(var i=0;i<zipped.length;++i){var item=zipped[i];var a=item[0];var b=item[1];if(op(a,b)){if(op(b,a)){continue}result=true;break}else{if(!op(b,a)){continue}result=false;break}}return result};var cmpLessThan=function(a,b){return a<b};ns.extractLabelFromUri=function(str){var a=str.lastIndexOf("#");var b=str.lastIndexOf("/");var i=Math.max(a,b);var result=(i===str.length)?str:str.substring(i+1);if(result===""){result=str}return result};ns.AggregatorFactoryLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.labelExpr=labelExpr;this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr},createAggregator:function(){var result=new ns.AggregatorLabel(this.labelPrios,this.prefLangs,this.labelExpr,this.subjectExpr,this.propertyExpr);return result},getVarsMentioned:function(){var vm=(function(expr){var result=expr?expr.getVarsMentioned():[];return result});var result=_.union(vm(this.labelExpr),vm(this.subjectExpr),vm(this.propertyExpr));return result}});ns.AggregatorLabel=Class.create({initialize:function(labelPrios,prefLangs,labelExpr,subjectExpr,propertyExpr){this.subjectExpr=subjectExpr;this.propertyExpr=propertyExpr;this.labelExpr=labelExpr;this.exprEvaluator=new sparql.ExprEvaluatorImpl();this.labelPrios=labelPrios;this.prefLangs=prefLangs;this.bestMatchNode=null;this.bestMatchScore=[1000,1000]},processBinding:function(binding){var property=this.exprEvaluator.eval(this.propertyExpr,binding);var label=this.exprEvaluator.eval(this.labelExpr,binding);var subject=this.exprEvaluator.eval(this.subjectExpr,binding);if(this.bestMatchNode==null&&subject.isConstant()){this.bestMatchNode=subject.getConstant().asNode()}var propertyScore=-1;var langScore;var l;if(property&&property.isConstant()){var p=property.getConstant().asNode();if(p.isUri()){var propertyUri=p.getUri();propertyScore=this.labelPrios.indexOf(propertyUri)}}if(label&&label.isConstant()){l=label.getConstant().asNode();var lang=l.isLiteral()?l.getLiteralLanguage():"nolang";langScore=this.prefLangs.indexOf(lang)}var score=[propertyScore,langScore];var allNonNegative=_(score).every(function(item){return item>=0});if(allNonNegative){var cmp=compareArray(score,this.bestMatchScore,cmpLessThan);if(cmp===true){this.bestMatchScore=score;this.bestMatchNode=l}}},getNode:function(){return this.bestMatchNode},getJson:function(){var result=null;var bestMatchNode=this.bestMatchNode;if(bestMatchNode){if(bestMatchNode.isUri()){var uri=bestMatchNode.getUri();result=ns.extractLabelFromUri(uri)}else{result=bestMatchNode.getLiteralValue()}}return result}});ns.LabelUtil=Class.create({initialize:function(aggFactory,element){this.aggFactory=aggFactory;this.element=element},getAggFactory:function(){return this.aggFactory},getElement:function(){return this.element}});ns.LabelUtilFactory=Class.create({initialize:function(prefLabelPropertyUris,prefLangs){this.prefLabelPropertyUris=prefLabelPropertyUris;this.prefLangs=prefLangs;this.prefLabelProperties=_(this.prefLabelPropertyUris).map(function(uri){return rdf.NodeFactory.createUri(uri)})},createLabelUtil:function(labelVarName,subjectVarName,propertyVarName){var s=rdf.NodeFactory.createVar(subjectVarName);var p=rdf.NodeFactory.createVar(propertyVarName);var o=rdf.NodeFactory.createVar(labelVarName);var subjectExpr=new sparql.ExprVar(s);var propertyExpr=new sparql.ExprVar(p);var labelExpr=new sparql.ExprVar(o);var aggFactoryLabel=new ns.AggregatorFactoryLabel(this.prefLabelPropertyUris,this.prefLangs,labelExpr,subjectExpr,propertyExpr);var langTmp=_(this.prefLangs).map(function(lang){var r=new sparql.E_LangMatches(new sparql.E_Lang(labelExpr),sparql.NodeValue.makeString(lang));return r});var langConstraint=sparql.orify(langTmp);var propFilter=new sparql.E_OneOf(propertyExpr,this.prefLabelProperties);var els=[];els.push(new sparql.ElementTriplesBlock([new rdf.Triple(s,p,o)]));els.push(new sparql.ElementFilter(propFilter));els.push(new sparql.ElementFilter(langConstraint));var langElement=new sparql.ElementGroup(els);var result=new ns.LabelUtil(aggFactoryLabel,langElement);return result}})})();(function(){var b=Jassa.sponate;if(!b.angular){b.angular={}}var c=Jassa.sponate.angular;c.bridgePromise=function(f,e,d,g){f.done(function(i){var j=g?g(i):i;e.resolve(j);var h=function(){if(d&&!d.$$phase&&!d.$root.$$phase){d.$apply()}else{setTimeout(h,25)}};h()}).fail(function(h){e.reject(h)});return e.promise}})();(function(){var b=Jassa.sponate;var c=Jassa.sparql;var d=Jassa.sponate;b.GeoMapFactory=Class.create({classLabel:"GeoMapFactory",initialize:function(e,f){this.baseSponateView=e;this.bboxExprFactory=f},createMap:function(f){var e=this.createMapForBounds(f);return e},createMapForGlobal:function(){var e=this.createMapForBounds(null);return e},createMapForBounds:function(e){var i=this.baseSponateView;var g=this.bboxExprFactory;var k=i.getPattern();var l=i.getElementFactory();var m=l.createElement();var h=m;if(e){var f=g.createExpr(e);var j=new c.ElementFilter(f);h=new c.ElementGroup([m,j])}var n=new d.Mapping(null,k,new c.ElementFactoryConst(h));return n}})})();(function(){var c=Jassa.rdf;var e=Jassa.sparql;var b=Jassa.service;var d=Jassa.sponate;d.LookupServiceUtils={createLookupServiceNodeLabels:function(h,g,l){var f=new d.StoreFacade(h);var k=d.SponateUtils.createDefaultLabelMap(g,l);f.addMap(k,"labels");var j=f.labels;var i=new b.LookupServiceSponate(j);i=new b.LookupServiceChunker(i,20);i=new b.LookupServiceIdFilter(i,function(o){var n=o&&o.isUri();if(n){var m=o.getUri();n=n&&!_(m).include(" ");n=n&&!_(m).include("<");n=n&&!_(m).include(">")}return n});i=new b.LookupServiceTimeout(i,20);i=new b.LookupServiceTransform(i,function(n,o){var m=n?n.displayLabel:null;if(!m){if(!o){m=null}else{if(o.isUri()){m=d.extractLabelFromUri(o.getUri())}else{if(o.isLiteral()){m=""+o.getLiteralValue()}else{m=""+o}}}}return m});var i=new b.LookupServiceCache(i);return i}}})();(function(){var c=Jassa.facete;var d=Jassa.sparql;var b=Jassa.rdf;c.Step=Class.create({initialize:function(e,f){this.type="property";this.propertyName=e;this._isInverse=f},toJson:function(){var e={isInverse:this.isInverse,propertyName:this.propertyName};return e},getPropertyName:function(){return this.propertyName},isInverse:function(){return this._isInverse},equals:function(e){return _.isEqual(this,e)},toString:function(){if(this._isInverse){return"<"+this.propertyName}else{return this.propertyName}},createElement:function(f,j,h){var g=d.Node.uri(this.propertyName);var i;if(this._isInverse){i=new b.Triple(j,g,f)}else{i=new b.Triple(f,g,j)}var e=new d.ElementTriplesBlock([i]);return e}});c.Step.classLabel="Step";c.Step.fromJson=function(g){var f=checkNotNull(g.propertyName);var h=g.IsInverse();var e=new c.Step(f,h);return e};c.Step.parse=function(f){var e;if(_(f).startsWith("<")){e=new c.Step(f.substring(1),true)}else{e=new c.Step(f,false)}return e};c.Path=Class.create({initialize:function(e){this.steps=e?e:[]},getLength:function(){return this.steps.length},isEmpty:function(){var e=this.steps.length===0;return e},toString:function(){var e=this.steps.join(" ");return e},concat:function(f){var e=new c.Path(this.steps.concat(f.steps));return e},getLastStep:function(){var f=this.steps;var g=f.length;var e;if(g===0){e=null}else{e=f[g-1]}return e},getSteps:function(){return this.steps},startsWith:function(e){var j=e.steps.length;if(j>this.steps.length){return false}for(var h=0;h<j;++h){var g=this.steps[h];var f=e.steps[h];if(!g.equals(f)){return false}}return true},hashCode:function(){return this.toString()},equals:function(f){var g=this.steps.length;if(g!=f.steps.length){return false}var e=this.startsWith(f);return e},copyAppendStep:function(g){var f=this.steps.slice(0);f.push(g);var e=new c.Path(f);return e},toJson:function(){var f=[];var g=this.steps;for(var h=0;h<g.length;++h){var j=g[h];var e=j.toJson();f.push(e)}return f},getPropertyNames:function(){var e=[];var g=this.steps;for(var h=0;h<g.length;++h){var j=g[h];var f=j.getPropertyName();e.push(f)}return e}});c.Path.classLabel="Path";c.Path.fromJson=function(h){var f=[];for(var g=0;g<h.length;++g){var k=h[g];var j=c.Step.fromJson(k);f.push(j)}var e=new c.Path(f);return e};c.Path.parse=function(h){h=_(h).trim();var g=h.length!==0?h.split(" "):[];var f=_.map(g,function(i){if(i==="<^"){return new c.StepFacet(-1)}else{if(i==="^"||i===">^"){return new c.StepFacet(1)}else{return c.Step.parse(i)}}});var e=new c.Path(f);return e};c.PathUtils={parsePathSpec:function(f){var e=(f instanceof c.Path)?f:c.Path.parse(f);return e}};c.PathHead=Class.create({initialize:function(f,e){this.path=f;this.inverse=e?true:false},getPath:function(){return this.path},isInverse:function(){return this.inverse},equals:function(g){var f=this.path.equals(g.path);var h=this.inverse=g.inverse;var e=f&&h;return e}});c.Path.fromString=c.Path.parse})();(function(){var d=jassa.sparql;var b=jassa.rdf;var e=jassa.vocab;var c=jassa.facete;c.getElementsDirectTriples=function(j){var f=[];for(var h=0;h<j.length;++h){var g=j[h];if(g instanceof d.ElementTriplesBlock){f.push.apply(f,g.triples)}}return f};c.ConceptUtils={createVarMap:function(o,l){var g=o.getElement();var j=l.getElement();var i=o.getVar();var h=g.getVarsMentioned();var n=j.getVarsMentioned();var f=[o.getVar()];var k=[l.getVar()];var m=d.ElementUtils.createJoinVarMap(h,n,f,k);return m},createRenamedConcept:function(h,g){var k=this.createVarMap(h,g);var j=h.getVar();var l=g.getElement();var i=d.ElementUtils.createRenamedElement(l,k);var f=new c.Concept(i,j);return f},createCombinedConcept:function(q,p,h,l,i){var n;if(h){n=this.createRenamedConcept(q,p)}else{n=p}var o=n.getElements();var k=q.getVar();var g=q.getElement();var m;if(o.length>0){if(n.isSubjectConcept()){m=q.getElement()}else{var f=[];if(l){g=new d.ElementOptional(q.getElement())}f.push(g);if(i){o=[new d.ElementSubQuery(n.asQuery())]}f.push.apply(f,o);m=new d.ElementGroup(f);m=m.flatten()}}else{m=g}var j=new c.Concept(m,k);return j},createSubjectConcept:function(h,i,j){h=h||b.NodeFactory.createVar("s");i=i||b.NodeFactory.createVar("_p_");j=j||b.NodeFactory.createVar("_o_");var g=new d.ElementTriplesBlock([new b.Triple(h,i,j)]);var f=new c.Concept(g,h);return f},createTypeConcept:function(i,g){var h=i instanceof b.Node?i:b.NodeFactory.createUri(i);var j=!g?b.NodeFactory.createVar("s"):(g instanceof b.Node?g:b.NodeFactory.createVar(g));var f=new c.Concept(new d.ElementTriplesBlock([new b.Triple(j,e.rdf.type,h)]),j);return f},createQueryList:function(h,g,j){var f=new d.Query();f.setDistinct(true);f.setLimit(g);f.setOffset(j);f.getProject().add(h.getVar());var k=f.getElements();var i=h.getElements();k.push.apply(k,i);return f},createNewVar:function(h,j){j=j||"c";var g=h.getVarsMentioned();var i=d.VarUtils.createVarGen(j,g);var f=i.next();return f},createQueryCount:function(i,g,h){var f=c.QueryUtils.createQueryCount(i.getElements(),h,i.getVar(),g,null,true);return f},createQueryCountNotAsConciseAsPossible:function(h,g){var i=c.ConceptUtils.createQueryList(h);var f=new d.Query();f.getProject().add(g,new d.E_Count());f.getElements().push(i);return f},createQueryCountDoesNotWorkWithVirtuoso:function(h,g){var f=new d.Query();f.getProject().add(g,new d.E_Count(new d.ExprVar(h.getVar()),true));var j=f.getElements();var i=h.getElements();j.push.apply(j,i);return f}};c.FacetConcept=Class.create({initialize:function(h,f,g){this.elements=h;this.facetVar=f;this.facetValueVar=g},getElements:function(){return this.elements},getFacetVar:function(){return this.facetVar},getFacetValueVar:function(){return this.facetValueVar},toString:function(){var f="FacetConcept: ({"+this.elements.join(", ")+"}, "+this.facetVar+", "+this.facetValueVar+")";return f}});c.Concept=Class.create({classLabel:"jassa.sparql.Concept",initialize:function(g,f){this.element=g;this.variable=f},toJson:function(){var f={element:JSON.parse(JSON.stringify(this.element)),variable:this.variable};return f},getElement:function(){return this.element},getVarsMentioned:function(){var f=this.getElement().getVarsMentioned();return f},hasTriples:function(){var g=this.getElements();var h=c.getElementsDirectTriples(g);var f=h.length>0;return f},getElements:function(){var f;if(this.element instanceof d.ElementGroup){f=this.element.elements}else{f=[this.element]}return f},getVar:function(){return this.variable},getVariable:function(){if(!this.warningShown){this.warningShown=true}return this.getVar()},toString:function(){return""+this.element+"; "+this.variable},isSubjectConcept:function(){var f=false;var g=this.variable;var l=this.element;if(l instanceof d.ElementTriplesBlock){var j=l.triples;if(j.length===1){var h=j[0];var i=h.getSubject();var k=h.getPredicate();var m=h.getObject();f=g.equals(i)&&k.isVariable()&&m.isVariable()}}return f},combineWith:function(g){var f=c.createCombinedConcept(this,g);return f},createOptimizedConcept:function(){var g=this.getElement();var h=g.flatten();var f=new c.ConceptInt(h,this.variable);return f},asQuery:function(g,h){var f=c.ConceptUtils.createQueryList(this,g,h);return f},getOptimizedElement:function(){}});c.Concept.createFromElements=function(i,g){var h;if(i.length==1){h=i[0]}else{h=new d.ElementGroup(i)}var f=new c.Concept(h,g);return f}})();(function(){var c=Jassa.sparql;var b=Jassa.facete;b.ElementFactoryConceptFactory=Class.create(c.ElementFactory,{initialize:function(d){this.conceptFactory=d},createElement:function(){var e=this.conceptFactory.createConcept();var d=e?e.getElement():null;return d}});b.ConceptFactory=Class.create({createConcept:function(){throw"not overridden"}});b.ConceptFactoryConst=Class.create(b.ConceptFactory,{initialize:function(d){this.concept=d},getConcept:function(){return this.concept},setConcept:function(d){this.concept=d},createConcept:function(){return this.concept}});b.ConceptFactoryFacetConfig=Class.create(b.ConceptFactory,{initialize:function(d,f,e){this.facetConfig=d;this.path=f||new facete.Path();this.excludeSelfConstraints=e},createConcept:function(){var e=b.FaceteUtils.createFacetConceptGenerator(this.facetConfig);var d=e.createConceptResources(this.path,this.excludeSelfConstraints);return d}});b.ConceptFactoryFacetTreeConfig=Class.create(b.ConceptFactory,{initialize:function(f,e,d){this.facetTreeConfig=f;this.path=e||new facete.Path();this.excludeSelfConstraints=d},setPath:function(d){this.path=d},getPath:function(){return this.path},getFacetTreeConfig:function(){return this.facetTreeConfig},setFacetTreeConfig:function(d){this.facetTreeConfig=d},isExcludeSelfConstraints:function(){return this.excludeSelfConstraints},setExcludeSelfConstraints:function(d){this.excludeSelfConstraints=d},createConcept:function(){var f=this.facetTreeConfig.getFacetConfig();var e=b.FaceteUtils.createFacetConceptGenerator(f);var d=e.createConceptResources(this.path,this.excludeSelfConstraints);return d}})})();(function(){var b=Jassa.facete;b.FacetNodeFactory=Class.create({createFacetNode:function(){throw"Override me"}});b.FacetNodeFactoryConst=Class.create(b.FacetNodeFactory,{initialize:function(c){this.facetNode=c},createFacetNode:function(){return this.facetNode}})})();(function(){var b=Jassa.facete;b.QueryFactory=Class.create({createQuery:function(){throw"Not overridden"}});b.QueryFactoryFacets=Class.create(b.QueryFactory,{initialize:function(c,e,d){this.subQueryFactory=c;this.rootFacetNode=e;this.constraintManager=d?d:new b.ConstraintManager()},getRootFacetNode:function(){return this.rootFacetNode},getConstraintManager:function(){return this.constraintManager},createQuery:function(){var f=this.subQueryFactory.createQuery();if(f==null){return null}var d=f.getProject();var c=_.map(d,function(g){return g.value});var e=this.constraintManager.createElements(this.rootFacetNode);f.elements.push.apply(f.elements,e);return f}});b.QueryFactoryFacets.create=function(d,e,g){g=g?g:new facets.GenSym("fv");var f=facets.FacetNode.createRoot(e,g);var c=new b.QueryFactoryFacets(d,f);return c}})();(function(){var b=Jassa.util;var c=Jassa.facete})();(function(){var e=Jassa.vocab;var d=Jassa.sparql;var b=Jassa.xsd;var c=Jassa.facete;c.Constraint=Class.create({getName:function(){console.log("[ERROR] Override me");throw"Override me"},getDeclaredPaths:function(){console.log("[ERROR] Override me");throw"Override me"},createElementsAndExprs:function(f){console.log("[ERROR] Override me");throw"Override me"},equals:function(){console.log("[ERROR] Override me");throw"Override me"},hashCode:function(){console.log("[ERROR] Override me");throw"Override me"}});c.ConstraintBasePath=Class.create(c.Constraint,{initialize:function(f,g){this.name=f;this.path=g},getName:function(){return this.name},getDeclaredPaths:function(){return[this.path]},getDeclaredPath:function(){return this.path}});c.ConstraintBasePathValue=Class.create(c.ConstraintBasePath,{initialize:function($super,f,h,g){$super(f,h);this.value=g},getValue:function(){return this.value},equals:function(i){if(!i instanceof c.ConstraintBasePathValue){return false}var g=this.name==i.name;var f=this.path.equals(i.path);var j=this.value.equals(i.value);var h=g&&f&&j;return h},hashCode:function(){var f=util.ObjectUtils.hashCode(this,true);return f}});c.ConstraintExists=Class.create(c.ConstraintBasePath,{classLabel:"jassa.facete.ConstraintExists",initialize:function($super,f){$super("exists",f)},createElementsAndExprs:function(g){var f=c.ConstraintUtils.createConstraintExists(g,this.path);return f}});c.ConstraintLang=Class.create(c.ConstraintBasePathValue,{classLabel:"jassa.facete.ConstraintLang",initialize:function($super,g,f){$super("lang",g,f)},createElementsAndExprs:function(g){var f=c.ConstraintUtils.createConstraintLang(g,this.path,this.value);return f}});c.ConstraintEquals=Class.create(c.ConstraintBasePathValue,{classLabel:"jassa.facete.ConstraintEquals",initialize:function($super,g,f){$super("equals",g,f)},createElementsAndExprs:function(g){var f=c.ConstraintUtils.createConstraintEquals(g,this.path,this.value);return f}});c.ConstraintRegex=Class.create(c.ConstraintBasePathValue,{classLabel:"jassa.facete.ConstraintRegex",initialize:function($super,g,f){$super("regex",g,f)},createElementsAndExprs:function(g){var f=c.ConstraintUtils.createConstraintRegex(g,this.path,this.regexStr);return f}});c.ConstraintElementFactory=Class.create({createElementsAndExprs:function(g,f){console.log("[ERROR] Override me");throw"Override me"}});c.ConstraintElementFactoryBBoxRange=Class.create(c.ConstraintElementFactory,{initialize:function(){this.stepX=new c.Step(e.wgs84.str.lon);this.stepY=new c.Step(e.wgs84.str.lat)},createElementsAndExprs:function(j,s){var u=j.forPath(s.getPath());var h=s.getValue();var i=u.forStep(this.stepX);var g=u.forStep(this.stepY);var l=i.getTriples();var k=g.getTriples();var q=d.util.mergeTriples(l,k);var p=i.getVar();var n=g.getVar();var o=c.createWgsFilter(p,n,this.bounds,b.xdouble);var f=[new d.ElementTriplesBlock(q)];var m=[o];var t=new c.ElementsAndExprs(f,m);return t}})})();(function(){var d=Jassa.vocab;var c=Jassa.sparql;var b=Jassa.facete;b.ElementsAndExprs=Class.create({initialize:function(e,f){this.elements=e;this.exprs=f},getElements:function(){return this.elements},getExprs:function(){return this.exprs},toElements:function(){var e=[];var f=c.ElementUtils.createFilterElements(this.exprs);e.push.apply(e,this.elements);e.push.apply(e,f);return e}});b.ConstraintUtils={createConstraintExists:function(h,g){var e=h.forPath(g);var f=c.ElementUtils.createElementsTriplesBlock(e.getTriples());var i=new b.ElementsAndExprs(f,[]);return result},createConstraintLang:function(i,m,j){var n=i.forPath(m);var h=n.getVar();var f=new c.ExprVar(h);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var g=j;var k=[new c.E_LangMatches(new c.E_Lang(f),g)];var l=new b.ElementsAndExprs(e,k);return l},createConstraintRegex:function(i,m,k){var n=i.forPath(m);var h=n.getVar();var f=new c.ExprVar(h);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var g=k;var j=[new c.E_Regex(f,g,"i")];var l=new b.ElementsAndExprs(e,j);return l},createConstraintEquals:function(i,m,h){var n=i.forPath(m);var g=n.getVar();var f=new c.ExprVar(g);var e=c.ElementUtils.createElementsTriplesBlock(n.getTriples());var j=c.NodeValue.makeNode(h);var k=[new c.E_Equals(f,j)];var l=new b.ElementsAndExprs(e,k);return l}}})();(function(){var b=Jassa.util;var d=Jassa.sparql;var c=Jassa.facete;c.ConstraintManager=Class.create({classLabel:"jassa.facete.ConstraintList",initialize:function(e){this.constraints=e||[]},shallowClone:function(){var e=new c.ConstraintManager(this.constraints.slice(0));return e},getConstraintsByPath:function(h){var e=[];var l=this.constraints;for(var f=0;f<l.length;++f){var g=l[f];var k=g.getDeclaredPaths();var j=_.some(k,function(m){var i=m.equals(h);return i});if(j){e.push(g)}}return e},getConstrainedSteps:function(v){var l=[];var n=v.getSteps();var h=this.constraints;for(var m=0;m<h.length;++m){var f=h[m];var u=f.getDeclaredPaths();for(var k=0;k<u.length;++k){var e=u[k];var s=e.getSteps();var q=s.length-n.length;var o=e.startsWith(v);if(q==1&&o){var g=s[s.length-1];l.push(g)}}}var t=_.uniq(l,function(i){return""+i});return t},getConstraints:function(){return this.constraints},addConstraint:function(e){this.constraints.push(e)},removeConstraint:function(h){var e=false;var g=this.constraints;var k=[];for(var f=0;f<g.length;++f){var j=g[f];if(!j.equals(h)){k.push(j)}else{e=true}}this.constraints=k;return e},toggleConstraint:function(f){var e=this.removeConstraint(f);if(!e){this.addConstraint(f)}},createElementsAndExprs:function(i,g){var k=[];var j=[];var h={};var f=this;_(this.constraints).each(function(l){var s=l.getDeclaredPaths();var n=_(s).reduce(function(v,w){return v+" "+w},"");if(g){var q=_(s).some(function(w){var v=g.equals(w);return v});if(q){return}}_(s).each(function(x){var w=i.forPath(x);var v=w.getElements();k.push.apply(k,v)});var u=l.createElementsAndExprs(i);var t=u.getElements();var m=u.getExprs();if(t){k.push.apply(k,t)}if(m&&m.length>0){var o=h[n];if(!o){o=[];h[n]=o}var p=d.andify(m);o.push(p)}});_(h).each(function(m){var l=d.orify(m);j.push(l)});var e=new c.ElementsAndExprs(k,j);return e}})})();(function(){var b=Jassa.facete;b.ConstraintTaggerFactory=Class.create({initialize:function(c){this.constraintManager=c},createConstraintTagger:function(e){var f=this.constraintManager.getConstraintsByPath(e);var d={};_(f).each(function(i){var g=i.getName();if(g==="equals"){var h=i.getValue();d[h.toString()]=h}});console.log("eqConstraints: ",d);var c=new b.ConstraintTagger(d);return c}});b.ConstraintTagger=Class.create({initialize:function(c){this.equalConstraints=c},getTags:function(d){var c={isConstrainedEqual:this.equalConstraints[d.toString()]?true:false};return c}})})();(function(){var b=Jassa.rdf;var d=Jassa.sparql;var c=Jassa.facete;c.VarNode=Class.create({initialize:function(h,g,i,f,e){this.variableName=h;this.generator=g;this.stepId=i;this.parent=f;this.root=e;if(!this.root){if(this.parent){this.root=f.root}else{this.root=this}}this.idToChild={}},isRoot:function(){var e=this.parent?false:true;return e},getVariableName:function(){return this.variableName},getIdStr:function(){var f=this.parent?this.parent.getIdStr():"";var e=f+this.variableName;return e},getStepId:function(e){return""+JSON.stringify(e)},getSteps:function(){return this.steps},forProperty:function(h,f){var g=new c.Step(h,f);var e=this.forStep(g);return e},forStepId:function(f){var g=this.idToChild[f];if(!g){var e=this.generator.next();g=new c.VarNode(e,this.generator,f,this);this.idToChild[f]=g}return g},findNodeByVarName:function(j){if(this.variableName===j){return this}var g=_.values(this.idToChild);for(var f=0;f<g.length;++f){var h=g[f];var e=h.findNodeByVarName(j);if(e){return e}}return null}});c.FacetNode=Class.create({initialize:function(f,h,g,e){this.parent=g;this.root=e;if(!this.root){if(this.parent){this.root=g.root}else{this.root=this}}this.varNode=f;this.step=h;this._isActive=true;this.idToChild={}},getRootNode:function(){return this.root},isRoot:function(){var e=this.parent?false:true;return e},getVar:function(){var f=this.varNode.getVariableName();var e=b.NodeFactory.createVar(f);return e},getVariable:function(){if(!this.warningShown){this.warningShown=true}return this.getVar()},getStep:function(){return this.step},getParent:function(){return this.parent},getPath:function(){var f=[];var g=this;while(g!=this.root){f.push(g.getStep());g=g.getParent()}f.reverse();var e=new c.Path(f);return e},forPath:function(g){var f=g.getSteps();var e=this;_.each(f,function(h){e=e.forStep(h)});return e},getIdStr:function(){},getSteps:function(){return this.steps},getConstraints:function(){return this.constraints},isActiveDirect:function(){return this._isActive},getElements:function(){var e=[];var g=this.getTriples();if(g.length>0){var f=new d.ElementTriplesBlock(g);e.push(f)}return e},getTriples:function(){var e=[];this.getTriples2(e);return e},getTriples2:function(e){this.createDirectTriples2(e);if(this.parent){this.parent.getTriples2(e)}return e},createDirectTriples:function(){var e=[];this.createDirectTriples2(e);return e},createDirectTriples2:function(e){if(this.step){var g=this.parent.getVariable();var i=this.getVariable();var f=this.step.createElement(g,i,this.generator);var h=f.getTriples();e.push.apply(e,h)}return e},isActive:function(){if(!this._isActive){return false}if(this.parent){return this.parent.isActive()}return true},attachToParent:function(){if(!this.parent){return}this.parent[this.id]=this;this.parent.attachToParent()},forProperty:function(h,f){var g=new c.Step(h,f);var e=this.forStep(g);return e},forStep:function(e){var g=""+JSON.stringify(e);var h=this.idToChild[g];if(!h){var f=this.varNode.forStepId(g);h=new c.FacetNode(f,e,this,this.root);this.idToChild[g]=h}return h},copyTo:function(e){_.each(this.getConstraints(),function(f){e.addConstraint(f)})},copyExclude:function(){var e=new c.FacetNode();console.log("Now root:",e);this.root.copyExcludeRec(e,this);return e},copyExcludeRec:function(f,e){console.log("Copy:",this,f);if(this===e){return}this.copyTo(f);_.each(this.getSteps(),function(j){var i=j.step;var h=j.child;console.log("child:",i,h);if(h===e){return}var g=f.forStep(i);console.log("New child:",g);h.copyExcludeRec(g,e)})}});c.FacetNode.createRoot=function(g,h){var i=g.getName();h=h?h:new d.GenSym("fv");var f=new c.VarNode(i,h);var e=new c.FacetNode(f);return e};c.FacetManager=Class.create({initialize:function(g,f){var e=new c.VarNode(g,f);this.rootNode=new c.FacetNode(e);this.generator=f},getRootNode:function(){return this.rootNode},getGenerator:function(){return this.generator}});c.SimpleFacetFacade=Class.create({initialize:function(f,e){this.constraintManager=f;this.facetNode=e},getFacetNode:function(){return this.facetNode},getVariable:function(){var e=this.facetNode.getVariable();return e},getPath:function(){return this.facetNode.getPath()},forProperty:function(f,h){var g=this.facetNode.forProperty(f,h);var e=this.wrap(g);return e},forStep:function(g){var f=this.facetNode.forStep(g);var e=this.wrap(f);return e},wrap:function(f){var e=new c.SimpleFacetFacade(this.constraintManager,f);return e},forPathStr:function(f){var g=c.Path.fromString(f);var e=this.forPath(g);return e},forPath:function(g){var f=this.facetNode.forPath(g);var e=this.wrap(f);return e},createConstraint:function(g){if(g.type!="equals"){throw"Only equals supported"}var h=g.node;var f=d.NodeValue.makeNode(h);var e=c.ConstraintUtils.createEquals(this.facetNode.getPath(),f);return e},addConstraint:function(e){var f=this.createConstraint(e);this.constraintManager.addConstraint(f)},removeConstraint:function(e){var f=this.createConstraint(e);this.constraintManager.moveConstraint(f)},getConstraints:function(){var e=this.facetNode.getPath();var f=this.constraintManager.getConstraintsByPath(e);return f},createElements:function(i){var f=this.facetNode.getRootNode();var h=i?null:this.facetNode.getPath();var j=this.constraintManager.createElements(f,h);var g=this.facetNode.getElements();j.push.apply(j,g);var e=d.ElementUtils.flatten(j);return e},createConcept:function(g){var h=this.createElements(g);var f=this.getVariable();var e=new c.Concept(h,f);return e},getConstrainedSteps:function(){var f=this.getPath();var e=this.constraintManager.getConstrainedSteps(f);return e}})})();(function(){var b=Jassa.rdf;var e=Jassa.vocab;var d=Jassa.sparql;var c=Jassa.facete;c.QueryUtils={createElementsFacet:function(k,m,l,g){var t=[];if(!k.isSubjectConcept()){var f=k.getElements();t.push.apply(t,f)}var q=k.getVariable();var h=l;var i=g;var n=m?[new b.Triple(i,h,q)]:[new b.Triple(q,h,i)];var j=new d.ElementTriplesBlock(n);t.push(j);return t},createQueryFacetCount:function(l,g,k,j,h){var i=d.Node.v("__o");var m=c.createElementsFacet(l,j,g,i);var f=c.createQueryCount(m,h,i,k,[g],true);return f},createQueryCount:function(f,m,l,v,p,j,u){var h=l?new d.ExprVar(l):null;var s;var q=m||j||(p&&p.length>0);if(q){var o=new d.Query();var k=o.getElements();k.push.apply(k,f);if(p){for(var n=0;n<p.length;++n){var g=p[n];o.getProject().add(g)}}if(l){o.getProject().add(l)}if(o.getProjectVars().length===0){o.setResultStar(true)}o.setDistinct(j);o.setLimit(m);s=new d.ElementSubQuery(o)}else{s=new d.ElementGroup(f)}var t=new d.Query();t.setQueryPattern(s);if(p){_(p).each(function(i){t.getProject().add(i);t.getGroupBy().push(new d.ExprVar(i))})}t.getProject().add(v,new d.E_Count());return t},createQueryCountDoesNotWorkWithVirtuoso:function(f,m,l,u,q,j,t){var h=l?new d.ExprVar(l):null;var s=new d.Query();if(m){var p=new d.Query();var k=p.getElements();k.push.apply(k,f);if(q){for(var n=0;n<q.length;++n){var g=q[n];p.projectVars.add(g)}}if(l){p.projectVars.add(l)}if(p.projectVars.vars.length===0){p.setResultStar(true)}p.limit=m;s.getElements().push(new d.ElementSubQuery(p))}else{var o=s.getElements();o.push.apply(o,f)}if(q){_(q).each(function(i){s.getProject().add(i);s.getGroupBy().push(new d.ExprVar(i))})}s.getProject().add(u,new d.E_Count(h,j));return s}}})();(function(){var f=Jassa.vocab;var b=Jassa.util;var e=Jassa.sparql;var c=Jassa.rdf;var d=Jassa.facete;d.NodeSet=Class.create({initialize:function(g,h){this.nodes=g;this.isNegated=h},getNodes:function(){return this.nodes},isNegated:function(){return this.isNegated}});d.FacetConceptItem=Class.create({initialize:function(h,g){this.step=h;this.concept=g},getStep:function(){return this.step},getFacetConcept:function(){return this.concept},toString:function(){return this.step+": "+this.concept}});d.createFilter=function(j,i,k){var h=[];var g=null;if(i.length>0){var l=new e.E_OneOf(new e.ExprVar(j),i);if(k){l=new e.E_LogicalNot(l)}g=new e.ElementFilter(l)}return g};d.itemToArray=function(h){var g=[];if(h!=null){g.push(h)}return g};d.LimitAndOffset=Class.create({initialize:function(g,h){this.limit=g;this.offset=h},getOffset:function(){return this.offset},getLimit:function(){return this.limit},setOffset:function(g){this.offset=g},setLimit:function(g){this.limit=g}});d.FacetState=Class.create({isExpanded:function(){throw"Override me"},getResultRange:function(){throw"Override me"},getAggregationRange:function(){throw"Override me"}});d.FacetStateImpl=Class.create(d.FacetState,{initialize:function(h,i,g){this._isExpanded=h;this.resultRange=i;this.aggregationRange=g},isExpanded:function(){return this._isExpanded},getResultRange:function(){return this.resultRange},getAggregationRange:function(){return this.aggregationRange}});d.FacetStateProvider=Class.create({getFacetState:function(g){throw"Override me"}});d.FacetStateProviderImpl=Class.create({initialize:function(g){this.defaultLimit=g;this.pathToState=new b.HashMap()},getMap:function(){return this.pathToState},getFacetState:function(h){var g=this.pathToState.get(h);if(!g){g=new d.FacetStateImpl(null,new d.LimitAndOffset(this.defaultLimit,0),null);this.pathToState.put(h,g)}return g}});d.FacetConceptGenerator=Class.create({createFacetConcept:function(h,g){throw"Override me"},createFacetValueConcept:function(h,g){throw"Override me"}});d.FacetGeneratorConfig=Class.create({initialize:function(g,i,h){this.baseConcept=g;this.rootFacetNode=i;this.constraintManager=h},getBaseConcept:function(){return this.baseConcept},getRootFacetNode:function(){return this.rootFacetNode},getConstraintManager:function(){return this.constraintManager}});d.FacetGeneratorConfigProvider=Class.create({getConfig:function(){throw"Override me"}});d.FacetGeneratorConfigProviderConst=Class.create(d.FacetGeneratorConfigProvider,{initialize:function(g){this.facetConfig=g},getConfig:function(){return this.facetConfig}});d.FacetGeneratorConfigProviderIndirect=Class.create(d.FacetGeneratorConfigProvider,{initialize:function(h,g,i){this.baseConceptFactory=h;this.rootFacetNodeFactory=g;this.constraintManager=i},getConfig:function(){var h=this.baseConceptFactory.createConcept();var j=this.rootFacetNodeFactory.createFacetNode();var i=this.constraintManager;var g=new d.FacetGeneratorConfig(h,j,i);return g}});d.FacetConceptGeneratorFactory=Class.create({createFacetConceptGenerator:function(){throw"Implement me"}});d.FacetConceptGeneratorFactoryImpl=Class.create(d.FacetConceptGeneratorFactory,{initialize:function(g){this.facetConfigProvider=g},createFacetConceptGenerator:function(){var h=this.facetConfigProvider.getConfig();var g=new d.FacetConceptGeneratorImpl(h);return g}});d.FacetConceptGeneratorImpl=Class.create(d.FacetConceptGenerator,{initialize:function(g){this.facetConfig=g},createConceptResources:function(q,y){var t=this.facetConfig;var u=t.getBaseConcept();var j=t.getRootFacetNode();var l=t.getConstraintManager();var o=y?q:null;var v=l.createElementsAndExprs(j,o);var w=v.getElements();var i=v.getExprs();var n=j.forPath(q);var h=n.getVar();var k=u.getElements();var x=n.getElements();var g=[];g.push.apply(g,x);g.push.apply(g,w);if(u.isSubjectConcept()){if(g.length==0){g=k}}else{g.push.apply(g,k)}var s=_(i).map(function(A){var z=new e.ElementFilter(A);return z});g.push.apply(g,s);var m=e.ElementUtils.flatten(g);m=e.ElementUtils.flattenElements(m);var p=d.Concept.createFromElements(m,h);return p},createConceptFacetsCore:function(D,m,x,E){var G=this.facetConfig;var H=G.getBaseConcept();var j=G.getRootFacetNode();var p=G.getConstraintManager();var O=null;if(E){O=new d.Step(E.getUri(),m)}var t=null;if(O){t=D.copyAppendStep(O)}var I=p.createElementsAndExprs(j,t);var N=I.toElements();var s=j.forPath(D);var h=s.getVar();var o=H.getElements();var g;if(H.isSubjectConcept()){g=N}else{g=o.concat(N)}var C=e.PatternUtils.getVarsMentioned(g);var w=C.map(function(Q){return Q.getName()});var M=new e.GeneratorBlacklist(e.GenSym.create("p"),w);var K=new e.GeneratorBlacklist(e.GenSym.create("o"),w);var F=c.NodeFactory.createVar(M.next());var L=c.NodeFactory.createVar(K.next());var B=g.length!==0;var J;if(x&&!B&&D.isEmpty()){var A=[f.rdf.Property,f.owl.AnnotationProperty,f.owl.DatatypeProperty,f.owl.ObjectProperty];var z=c.NodeFactory.createVar("_x_");var y=new e.ExprVar(z);var i=_(A).map(function(Q){var v=e.NodeValue.makeNode(Q);var R=new e.E_Equals(y,v);return R});var n=e.orify(i);J=new c.Triple(F,f.rdf.type,z);var k=new e.ElementGroup([new e.ElementTriplesBlock([J]),new e.ElementFilter(n)]);g.push(k)}else{if(!m){J=new c.Triple(h,F,L)}else{J=new c.Triple(L,F,h)}g.push(new e.ElementTriplesBlock([J]))}if(O){var y=new e.ExprVar(F);var l=new e.E_Equals(y,e.NodeValue.makeNode(E));g.push(new e.ElementFilter(l))}var P=s.getElements();g.push.apply(g,P);var q=e.ElementUtils.flatten(g);q=e.ElementUtils.flattenElements(q);var u=new d.FacetConcept(q,F,L);return u},createConceptFacets:function(j,i){var h=this.createConceptFacetsCore(j,i,true);var g=new d.Concept.createFromElements(h.getElements(),h.getFacetVar());return g},createConceptFacetValues:function(v,i,l,j){i=i==null?false:i;var p;var x=l.map(function(B){return B.getUri()});var y=this.facetConfig;var z=y.getBaseConcept();var h=y.getRootFacetNode();var m=y.getConstraintManager();var o=h.forPath(v);var s=m.getConstrainedSteps(v);var A=_(s).filter(function(D){var C=D.isInverse()===i;if(!C){return false}var E=_(x).contains(D.getPropertyName());var B=j?!E:E;return B});var k=A.map(function(B){return B.getPropertyName()});var q=[];var w=[];_(l).each(function(B){if(_(k).contains(B.getUri())){w.push(B)}else{q.push(B)}});var p=this.createConceptItems(o,A);var n=this.createConceptFacetsCore(v,i,false);var g=n.getElements();var u=d.createFilter(n.getFacetVar(),q,false);if(u!=null){g.push(u)}if(q.length>0){var t=new d.FacetConceptItem(null,n);p.push(t)}return p},createConceptItems:function(i,j){var h=this;var g=_(j).map(function(l){var k=h.createConceptItem(i,l);return k});return g},createConceptItem:function(i,k){var h=k.getPropertyName();var l=c.NodeFactory.createUri(h);var m=i.getPath();var j=this.createConceptFacetsCore(m,k.isInverse(),false,l);var g=new d.FacetConceptItem(k,j);return g}})})();(function(g){var b=Jassa.service;var d=Jassa.rdf;var i=Jassa.sponate;var c=Jassa.util;var f=Jassa.sparql;var e=Jassa.facete;e.FacetTreeServiceImpl=Class.create({initialize:function(m,k,n,l,j){this.facetService=m;this.expansionSet=k;this.expansionMap=n;this.facetStateProvider=l;this.pathToFilterString=j},fetchFacetTree:function(l){var m;if(l.isEmpty()){m=new e.FacetItem(l,d.NodeFactory.createUri("http://root"),null)}else{m=new e.FacetItem(l,d.NodeFactory.createUri(l.getLastStep().getPropertyName()),null)}m.setDoc({displayLabel:"Items"});var k=this.facetService.getTags(l);m.setTags(k);var j=this.fetchFacetTreeRec(l,m);return j},fetchFavFacets:function(m){var k=this;var l=_(m).map(function(o){var p=new e.FacetItem(o,d.NodeFactory.createUri(o.getLastStep().getPropertyName()),null);var n=k.fetchFacetTreeRec(o,p);return n});var j=g.Deferred();g.when.apply(window,l).done(function(){var n=_(arguments).map(function(o){return o});j.resolve(n)}).fail(j.fail);return j.promise()},fetchFacetTreeChildren:function(y,v){var p={path:y,children:[],limit:null,offset:null};var o=null;var q=null;var k=this.facetStateProvider.getFacetState(y);if(k){var u=k.getResultRange();o=u.getLimit();q=u.getOffset()||0}p.limit=o;p.offset=q;var s=this.pathToFilterString.get(y);var j=this.facetService.createFlow(y,v,s);var l=j.count();var m=j.skip(q).limit(o);var n=this.facetService.fetchFacetsFromFlow(m,y,v);var t=[l,n];var x=g.Deferred();var w=this;g.when.apply(window,t).pipe(function(B,z){p.childFacetCount=B;var C=o?Math.floor((q||0)/o):0;p.pageIndex=1+C;p.pageCount=1+(o?Math.floor(B/o):0);var A=_(z).map(function(D){var E=D.getPath();var F=w.fetchFacetTreeRec(E,D);return F});g.when.apply(window,A).done(function(){_(arguments).each(function(D){p.children.push(D)});x.resolve(p)}).fail(function(){x.fail()})});return x},fetchFacetTreeRec:function(u,l){var j=this.expansionSet.contains(u);var o=this.expansionMap.get(u);var n=(o&1)!=0;var k=(o&2)!=0;var m={item:l,isExpanded:j,expansionState:o,isOutgoingActive:n,isIncomingActive:k,incoming:null,outgoing:null};var q=this;var t=g.Deferred();var p=[];if(j){if(n){var s=this.fetchFacetTreeChildren(u,false).pipe(function(v){m.outgoing=v});p.push(s)}if(k){var s=this.fetchFacetTreeChildren(u,true).pipe(function(v){m.incoming=v});p.push(s)}}g.when.apply(window,p).done(function(){t.resolve(m)});return t.promise()},fetchFacetTreeRecOldWrongChildFacetCounts:function(s){console.log("fetchFacetTreeRec: "+s);var q=this;var t=g.Deferred();var m=null;var n=null;var j=this.facetStateProvider.getFacetState(s);if(j){var p=j.getResultRange();m=p.getLimit();n=p.getOffset()}var k=this.facetService.fetchFacetCount(s,false);var l=this.facetService.fetchFacets(s,false,m,n);var o=[k,l];g.when.apply(window,o).done(function(y,v){var x=[];var w=[];var u=0;_(v).each(function(A){var C=A.getPath();var B=A.getNode().getUri();var D=q.expansionSet.contains(C);var z={item:A,isExpanded:D,children:null,childFacetCount:y,limit:m,offset:n};++u;x.push(z);if(!D){return}console.log("Got a child facet for path "+C+" with "+y+" children");var E=q.fetchFacetTreeRec(C).pipe(function(F){z.children=F});w.push(E)});g.when.apply(window,w).done(function(){t.resolve(x)}).fail(function(){t.fail()})});return t.promise()}});e.FacetService=Class.create({fetchFacets:function(k,j){throw"Override me"}});e.FacetItem=Class.create({initialize:function(n,l,k,j,m){this.path=n;this.node=l;this.distinctValueCount=k;this.tags=j||{};this.doc=m||{}},getNode:function(){return this.node},getPath:function(){return this.path},getDoc:function(){return this.doc},setDoc:function(j){this.doc=j},getDistinctValueCount:function(){return this.distinctValueCount},getTags:function(){return this.tags},setTags:function(j){this.tags=j}});e.FacetFetchingWorkflow=Class.create({execute:function(j,k){}});e.FacetServiceImpl=Class.create(e.FacetService,{initialize:function(k,j,m,l){this.sparqlService=k;this.facetConceptGenerator=j;this.labelMap=m;this.pathTaggerManager=l},getTags:function(k){var j=this.pathTaggerManager.createTags(k);return j},createFlow:function(o,k,m){var n=new i.StoreFacade(this.sparqlService,{});n.addMap(this.labelMap,"labels");var l=this.facetConceptGenerator.createConceptFacets(o,k);var p={};if(m){p={$or:[{hiddenLabels:{$elemMatch:{id:{$regex:m,$options:"i"}}}},{id:{$regex:m,$options:"i"}}]}}var j=n.labels.find(p).concept(l,true);return j},fetchFacetCount:function(o,l){var m=this.facetConceptGenerator.createConceptFacets(o,l);var j=d.NodeFactory.createVar("_c_");var n=e.ConceptUtils.createQueryCount(m,j);var k=this.sparqlService.createQueryExecution(n);var p=b.ServiceUtils.fetchInt(k,j);return p},fetchFacets2:function(x,t,m,n){var q=this.facetConceptGenerator.createConceptFacetsCore(x,t,false);var j=q.getElements();var k=q.getFacetVar();var p=q.getFacetValueVar();var w=d.NodeFactory.createVar("_c_");var s=e.QueryUtils.createQueryCount(j,null,p,w,[k],true);var l=s.getProject().getExpr(w);s.getOrderBy().push(new f.SortCondition(l,-1));var v=this.sparqlService.createQueryExecution(s).execSelect();var u=v.pipe(function(B){var y=[];while(B.hasNext()){var E=B.nextBinding();var G=E.get(k);var C=E.get(w);var D=G.getUri();var z=C.getLiteralValue();var A=new e.Step(D,t);var F=x.copyAppendStep(A);var H=new e.FacetItem(F,G,z);y.push(H)}return y});var o=this.pipeTagging(u);return o},pipeTagging:function(l){var k=this;var j=l.pipe(function(m){_(m).each(function(o){var n=k.pathTaggerManager.createTags(o.getPath());o.setTags(n)});return m});return j},fetchFacetsFromFlow:function(l,o,n){var p=l.asList(true);var k=g.Deferred();var j=this;p.done(function(u){var s=c.MapUtils.indexBy(u,"id");var q=_(u).pluck("id");if(q.length===0){k.resolve([]);return}var t=j.fetchFacetValueCounts(o,n,q,false);t.done(function(v){console.log("PropertyCounts",v);_(v).each(function(w){var x=s.get(w.getNode());w.setDoc(x)});k.resolve(v)}).fail(function(){k.fail()})}).fail(function(){k.fail()});var m=this.pipeTagging(k);return m.promise()},fetchFacet:function(q){var l=1000;var s=d.NodeFactory.createVar();var k=this.facetConceptGenerator.createConceptResources(q,false,l);var m=e.ConceptUtils.createQueryCount(k,s);var j=this.sparqlService.createQueryExecution(m);var p=b.ServiceUtils.fetchInt(j,s);var o=this;var n=p.pipe(function(w){var v=q.isEmpty()?d.NodeFactory.createUri("http://root"):d.NodeFactory.createUri(q.getLastStep().getPropertyName());var u=new e.FacetItem(q,v,w,null,null);var t=o.pathTaggerManager.createTags(item.getPath());item.setTags(t);return u});return n},fetchFacets:function(t,o,l,m){var k=this.facetConceptGenerator.createConceptFacets(t,o);var n=e.ConceptUtils.createQueryList(k);n.setLimit(l);n.setOffset(m);var j=this.sparqlService.createQueryExecution(n);var s=b.ServiceUtils.fetchList(j,k.getVar());var q=this;var p=g.Deferred();s.done(function(u){var v=q.fetchFacetValueCounts(t,o,u,false);v.done(function(w){console.log("PropertyCounts",w);p.resolve(w)}).fail(function(){p.fail()})}).fail(function(){p.fail()});return p.promise()},fetchFacetValueCountsThresholded:function(u,o,m,k,l,p){l=10000;var n=this.createQuerySpecsFacetValueScanCounts(u,o,m,k,l,p);var t=this.processQuerySpecsFacetValueCounts(u,o,m,n);var s=jQuery.Deferred();var q=this;t.done(function(x){var w=_(x).filter(function(z){return z.getDistinctValueCount()<l});var v=_(w).map(function(z){return z.getNode()});var y=q.fetchFacetValueCountsFull(u,o,v,k,l);y.done(function(A){var z=_(A).indexBy(function(C){return C.getNode().getUri()});var B=_(m).map(function(H){var C=H.getUri();var G=z[C];if(!G){var D=-1;var F=new e.Step(C,o);var E=u.copyAppendStep(F);G=new e.FacetItem(E,H,D)}return G});s.resolve(B)}).fail(function(){s.fail.apply(this,arguments)})}).fail(function(){s.fail.apply(this,arguments)});var j=this.pipeTagging(s);return j},createQuerySpecsFacetValueScanCounts:function(y,s,p,n,o,t){if(n){console.log("Negated property sets not (yet) supported with thresholded counting strategy");throw"Bailing out"}var z=d.NodeFactory.createVar("_c_");var j=d.NodeFactory.createVar("p_1");var w=this;var l=_(p).map(function(G){var D=w.facetConceptGenerator.createConceptFacetValues(y,s,[G],n);var C=D[0];var A=C.getFacetConcept();var B=A.getFacetVar();var H=A.getFacetValueVar();var F=A.getElements();var E=e.QueryUtils.createQueryCount(F,o,H,z,[B],false);return E});var v;if(l.length>1){var u=_(l).map(function(B){var A=new f.ElementSubQuery(B);return A});var k=new f.ElementUnion(u);v=new f.Query();v.getProject().add(j);v.getProject().add(z);var q=v.getElements();v.getElements().push(k)}else{if(l.length===1){v=l[0]}else{console.log("Should not happen");throw"Should not happen"}}var m={query:v,groupVar:j,outputVar:z};var x=[m];return x},processQuerySpecsFacetValueCounts:function(p,m,l,n){var o={};_(l).each(function(t){var s=t.getUri();o[s]={property:t,distinctValueCount:0}});var j=this;var k=_(n).map(function(w){var v=w.query;var t=w.groupVar;var s=w.outputVar;var u=j.sparqlService.createQueryExecution(v);var x=u.execSelect().pipe(function(z){while(z.hasNext()){var C=z.nextBinding();var B=C.get(t);var y=B.getUri();var A=C.get(s).getLiteralValue();o[y]={property:B,distinctValueCount:A}}});return x});var q=g.Deferred();g.when.apply(window,k).done(function(){var s=_(l).map(function(z){var t=z.getUri();var y=o[t];var v=y.distinctValueCount;var x=new e.Step(t,m);var w=p.copyAppendStep(x);var u=new e.FacetItem(w,z,v);return u});q.resolve(s)}).fail(function(){q.fail()});return q.promise()},fetchFacetValueCounts:function(n,m,l,k){var j=this.fetchFacetValueCountsThresholded(n,m,l,k);return j},fetchFacetValueCountsFull:function(s,p,m,k){var j=this.facetConceptGenerator.createConceptFacetValues(s,p,m,k);var t=d.NodeFactory.createVar("_c_");var n={};_(m).each(function(v){var u=v.getUri();n[u]={property:v,distinctValueCount:0}});var q=this;var o=_(j).map(function(x){var u=x.getFacetConcept();var v=u.getFacetVar();var B=u.getFacetValueVar();var z=u.getElements();var y=e.QueryUtils.createQueryCount(z,null,B,t,[v],true);var w=q.sparqlService.createQueryExecution(y);var A=w.execSelect().pipe(function(D){while(D.hasNext()){var G=D.nextBinding();var F=G.get(v);var C=F.getUri();var E=G.get(t).getLiteralValue();n[C]={property:F,distinctValueCount:E}}});return A});var l=g.Deferred();g.when.apply(window,o).done(function(){var u=_(m).map(function(B){var v=B.getUri();var A=n[v];var x=A.distinctValueCount;var z=new e.Step(v,p);var y=s.copyAppendStep(z);var w=new e.FacetItem(y,B,x);return w});l.resolve(u)}).fail(function(){l.fail()});return l.promise()}});var h={refreshPageCount:function(){var m=this;if(!this.tableExecutor){m.paginatorModel.set({pageCount:1});return}var j=g.Deferred();m.paginatorModel.set({isLoadingPageCount:true});var n=function(p){m.tableModel.set({itemCount:p.count,hasMoreItems:p.more});m.paginatorModel.set({isLoadingPageCount:false});j.resolve()};var l=10000;var o=3000;var k=this.tableExecutor.fetchResultSetSize(null,null,{timeout:o});k.fail(function(){console.log("[WARN] Timeout encountered when retrieving page count - retrying with sample strategy");var p=m.tableExecutor.fetchResultSetSize(l,null,{timeout:o});p.pipe(n);p.fail(function(){console.log("[ERROR] Timout encountered during fallback sampling strategy - returning only 1 page");m.paginatorModel.set({isLoadingPageCount:false});j.resolve({itemCount:1,hasMoreItems:true})})});k.pipe(n)},omfgWhatDidIDo_IWasABadProgrammer:function(){var n=[];for(var m=0;m<conceptItems.length;++m){var o=conceptItems[m];var q=this.fnFetchSubFacets(this.sparqlService,o);n.push(q)}var l=model.get("children");var p=_.map(this.facetProviders,function(u){var s=u.fetchFacets(concept,false,constrainedSteps);var t=s.pipe(function(x){var w=[];for(var z=0;z<x.length;++z){var C=x[z];var y=C.facetUri;var A=C.isInverse;var B={type:"property",property:y,isInverse:A};var v=facetFacadeNode.forProperty(y,A);C.facetFacadeNode=v;C.facetNode=v.getFacetNode();C.step=B;w.push(C)}return w});return t});model.set({isLoading:true});n.push.apply(n,p);var j=g.when.apply(null,n);j.always(function(){model.set({isLoading:false})});var k=g.Deferred();j.pipe(function(){var z=[];for(var w=0;w<arguments.length;++w){var y=arguments[w];z.push.apply(z,y)}var t=[];for(var w=0;w<z.length;++w){var C=z[w];var A=C.id;t.push(A)}var u=l.map(function(E){return E.id});var B=_.difference(u,t);l.remove(B);for(var w=0;w<z.length;++w){var C=z[w];var x=l.get(C.id);if(x){var v=C;C=x;C.set(v)}else{l.add(C)}}var D=[];l.each(function(G){var E=G.get("facetFacadeNode");var F=self.updateFacets(G,E);D.push(F)});var s=g.when.apply(null,D);s.done(function(){k.resolve()}).fail(function(){k.fail()})})}}})(jQuery);(function(){var c=Jassa.sponate;var b=Jassa.facete;b.FacetValueService=Class.create({initialize:function(d,e){this.sparqlService=d;this.facetTreeConfig=e},getFacetTreeConfig:function(){return this.facetTreeConfig},createFacetValueFetcher:function(p,f,g){g=g||true;var e=this.facetTreeConfig.getFacetConfig();var j=b.FaceteUtils.createFacetConceptGenerator(e);var i=j.createConceptResources(p,g);var n=new b.ConstraintTaggerFactory(e.getConstraintManager());var m=new c.StoreFacade(this.sparqlService);var k=c.SponateUtils.createDefaultLabelMap();m.addMap(k,"labels");var h=m.labels;var l={};if(f){l={$or:[{hiddenLabels:{$elemMatch:{id:{$regex:f,$options:"i"}}}},{id:{$regex:f,$options:"i"}}]}}var d=h.find(l).concept(i,true);var o=new b.FacetValueFetcher(d,this.facetTreeConfig,p);return o}});b.FacetValueFetcher=Class.create({initialize:function(d,f,e){this.baseFlow=d;this.facetTreeConfig=f;this.path=e},fetchCount:function(){var d=this.baseFlow.count();return d},fetchData:function(g,d){var h=this.baseFlow.skip(g).limit(d);var e=this;var f=h.asList(true).pipe(function(m){var l=e.path;var j=e.facetTreeConfig.getFacetConfig();var i=new b.ConstraintTaggerFactory(j.getConstraintManager());var n=i.createConstraintTagger(l);var k=_(m).map(function(s){var q=s.id;var o=s.displayLabel?s.displayLabel:""+s.id;var p={displayLabel:o,path:l,node:q,tags:n.getTags(q)};return p});return k});return f}})})();(function(){var b=Jassa.util;var c=Jassa.rdf;var e=Jassa.sponate;var d=Jassa.facete;d.FacetConfig=Class.create({classLabel:"jassa.facete.FacetConfig",initialize:function(h,j,i,g,f){this.baseConcept=h;this.rootFacetNode=j;this.constraintManager=i;this.labelMap=g||e.SponateUtils.createDefaultLabelMap();this.pathTaggerManager=f||new d.ItemTaggerManager()},getBaseConcept:function(){return this.baseConcept},setBaseConcept:function(f){this.baseConcept=f},getRootFacetNode:function(){return this.rootFacetNode},setRootFacetNode:function(f){this.rootFacetNode=f},getConstraintManager:function(){return this.constraintManager},setConstraintManager:function(f){this.constraintManager=f},getLabelMap:function(){return this.labelMap},setLabelMap:function(f){this.labelMap=f},getPathTaggerManager:function(){return this.pathTaggerManager},hashCode:function(){var g=_(this).omit("rootFacetNode");var f=b.ObjectUtils.hashCode(g,true);return f}});d.FacetConfig.createDefaultFacetConfig=function(){var h=c.NodeFactory.createVar("s");var g=d.ConceptUtils.createSubjectConcept(h);var j=d.FacetNode.createRoot(h);var i=new d.ConstraintManager();var f=new d.FacetConfig(g,j,i);return f};d.FacetTreeConfig=Class.create({classLabel:"jassa.facete.FacetTreeConfig",initialize:function(i,j,g,k,h,f){this.facetConfig=i||d.FacetConfig.createDefaultFacetConfig();this.expansionSet=g||new b.HashSet();this.expansionMap=k||new b.HashMap();this.facetStateProvider=h||new d.FacetStateProviderImpl(10);this.pathToFilterString=f||new b.HashMap()},getFacetConfig:function(){return this.facetConfig},setFacetConfig:function(f){this.facetConfig=f},getExpansionSet:function(){return this.expansionSet},getExpansionMap:function(){return this.expansionMap},getFacetStateProvider:function(){return this.facetStateProvider},getPathToFilterString:function(){return this.pathToFilterString},hashCode:function(){var f=b.ObjectUtils.hashCode(this,true);return f}});d.FaceteUtils={createFacetConceptGenerator:function(g){var h=g.getBaseConcept();var j=g.getRootFacetNode();var i=g.getConstraintManager();var f=this.createFacetConceptGenerator2(h,j,i);return f},createFacetConceptGenerator2:function(h,k,j){var i=new d.FacetGeneratorConfigProviderIndirect(new d.ConceptFactoryConst(h),new d.FacetNodeFactoryConst(k),j);var g=new d.FacetConceptGeneratorFactoryImpl(i);var f=g.createFacetConceptGenerator();return f},createFacetService:function(g,h){var f=this.createFacetConceptGenerator(h);var i=new d.FacetServiceImpl(g,f,h.getLabelMap(),h.getPathTaggerManager());return i},createFacetTreeService:function(i,l){var j=this.createFacetService(i,l.getFacetConfig());var g=l.getExpansionSet();var m=l.getExpansionMap();var h=l.getFacetStateProvider();var f=l.getPathToFilterString();var k=new d.FacetTreeServiceImpl(j,g,m,h,f);return k},createFacetTreeTagger:function(f){var h=new d.ItemTaggerManager();h.getTaggerMap()["filter"]=new d.ItemTaggerFilterString(f);var g=new d.FacetTreeTagger(h);return g}}})();(function(){var b=Jassa.service;var c=Jassa.rdf;var e=Jassa.facete;var d=Jassa.facete;d.test=function(){var p=new b.SparqlServiceHttp("http://localhost/sparql",[]);var j=new e.ConstraintManager();var h=c.NodeFactory.createVar("s");var n=e.ConceptUtils.createSubjectConcept(h);var f=e.FacetNode.createRoot(h);var i=new e.FacetStateProviderImpl();var o=new e.FacetGeneratorConfigProviderIndirect(new e.ConceptFactoryConst(n),new e.FacetNodeFactoryConst(f),j);var k=new d.FacetConceptGeneratorFactoryImpl(o);var g=k.createFacetConceptGenerator();var l=new e.FacetServiceImpl(p,g);l.fetchFacets(e.Path.parse("")).done(function(q){_(q).each(function(s){console.log("FacetItem: "+JSON.stringify(s))})});var m=l.createConceptFacetValues(e.Path.parse(""));console.log("FacetValues: "+m)};d.testQueryApi=function(){var h=new b.SparqlServiceHttp("http://localhost/sparql",[]);var f=h.createQueryExecution("Select * { ?s ?p ?o } Limit 10");var g=c.NodeFactory.createVar("s");f.execSelect().done(function(i){while(i.hasNext()){console.log(""+i.nextBinding().get(g))}})}})();(function(){var c=Jassa.rdf;var e=Jassa.sparql;var b=Jassa.util;var d=Jassa.facete;d.SortCondition=Class.create({initialize:function(g,f,h){this.columnId=g;this.sortDir=f==null?1:f;this.sortType=h||"data"},getColumnId:function(){return this.columnId},getSortType:function(){return this.sortType},setSortType:function(f){this.sortType=f},getSortDir:function(){return this.sortDir},setSortDir:function(f){this.sortDir=f}});d.FilterString=Class.create({initialize:function(g,f){this.str=g;this.mode=f}});d.ColumnView=Class.create({initialize:function(f,g){this.tableMod=f;this.columnId=g},getId:function(){return this.columnId},getSortConditions:function(){var f={};var g=this.columnId;_(this.tableMod.getSortConditions()).each(function(i){var j=i.getColumnId();if(j===g){var h=i.getSortType();f[h]=i.getSortDir()}});return f},getAggregator:function(){var f=this.tableMod.getAggregator(this.columnId);return f},setAggregator:function(f){this.tableMod.getAggregators()[this.columnId]=f}});d.Aggregator=Class.create({initialize:function(g,f){this.name=g;this.attrs=f},getName:function(){return this.name},getAttrs:function(){return this.attrs}});d.TableMod=Class.create({initialize:function(){this.columnIds=[];this.colIdToColView={};this.sortConditions=[];this.colIdToAgg={};this.limitAndOffset=new d.LimitAndOffset();this._isDistinct=true},isDistinct:function(){return this._isDistinct},setDistinct:function(f){this._isDistinct=f},getColumnIds:function(){return this.columnIds},getColumn:function(f){return this.colIdToColView[f]},getColumns:function(){var g=this;var f=_(this.columnIds).map(function(i){var h=g.colIdToColView[i];return h});return f},getSortConditions:function(){return this.sortConditions},getLimitAndOffset:function(){return this.limitAndOffset},getAggregator:function(g){var f=this.colIdToAgg[g];return f},getAggregators:function(){return this.colIdToAgg},addColumn:function(g,h){var f=this.colIdToColView[g];if(f){throw"Column "+g+" already part of the table"}f=new d.ColumnView(this,g);this.colIdToColView[g]=f;if(!h){this.columnIds.push(g)}return f},removeColumn:function(g){delete this.colIdToColView[g];var f=this;b.ArrayUtils.filter(this.columnIds,function(i){var h=g!=i;return h});b.ArrayUtils.filter(this.sortConditions,function(i){var h=g!=i.getColumnId()});delete this.colIdToAgg[g]}});d.ExprModFactoryAggCount=Class.create({createExpr:function(g){var f=new e.E_Count(g);return f}});d.ExprModFactoryAggMin=Class.create({createExpr:function(g){var f=new e.E_Min(g);return f}});d.ExprModFactoryAggMax=Class.create({createExpr:function(g){var f=new e.E_Min(g);return f}});d.ExprModRegistry={count:new d.ExprModFactoryAggCount,min:new d.ExprModFactoryAggMin,max:new d.ExprModFactoryAggMax};d.ElementFactoryFacetPaths=Class.create({initialize:function(f,g){this.facetConfig=f;this.paths=g||new b.ArrayList()},createElement:function(){var g=facete.FaceteUtils.createFacetConceptGenerator(this.facetConfig);var j=g.createConceptResources(new facete.Path());var l=this.facetConfig.getRootFacetNode();var h=_(this.paths).map(function(q){var m=l.forPath(q);console.log("facetNode: ",m);var p=m.getElements(true);var o=new e.ElementGroup(p);var n;if(p.length!==0){n=new e.ElementOptional(o)}else{n=o}return n});var k=[];k.push.apply(k,j.getElements());k.push.apply(k,h);var i=new e.ElementGroup(k);var f=i.flatten();return f}});d.TableConfigFacet=Class.create({initialize:function(f,g,h){this.facetConfig=f;this.tableMod=g||new d.TableMod();this.paths=h||new b.ArrayList()},getFacetConfig:function(){return this.facetConfig},getTableMod:function(){return this.tableMod},getPaths:function(){return this.paths},getPath:function(h){var g=_(this.tableMod.getColumnIds()).indexOf(h);var f=this.paths.get(g);return f},getColumnId:function(h){var g=this.paths.firstIndexOf(h);var f=this.tableMod.getColumnIds()[g];return f},removeColumn:function(f){var g=this.getPath(f);this.paths.remove(g)},getColIdForPath:function(i){var h=this.facetConfig.getRootFacetNode();var g=h.forPath(i);var f=g.getVar().getName();return f},togglePath:function(g){var f=b.CollectionUtils.toggleItem(this.paths,g);var h=this.getColIdForPath(g);if(f){this.tableMod.addColumn(h)}else{this.tableMod.removeColumn(h)}},createDataConcept:function(){var l=new d.Path();var k=this.paths.getArray().slice(0);if(!this.paths.contains(l)){k.push(l)}var h=new d.ElementFactoryFacetPaths(this.facetConfig,k);var g=h.createElement();var j=this.facetConfig.getRootFacetNode();var i=j.getVar();var f=new d.Concept(g,i);return f}});d.QueryFactoryFacetTable=Class.create(d.QueryFactory,{initialize:function(f){this.tableConfigFacet=f},createQuery:function(){var i=this.tableConfigFacet.getFacetConfig();var k=this.tableConfigFacet.getPaths().getArray();var j=this.tableConfigFacet.getTableMod();var h=new d.ElementFactoryFacetPaths(i,k);var g=new d.QueryFactoryTableMod(h,j);var f=g.createQuery();return f}});d.TableUtils={createNgGridColumnDefs:function(h){var g=h.getColumns();var f=_(g).each(function(i){var j={field:i.getId(),displayName:i.getId()};return j});return f}};d.QueryFactoryTableMod=Class.create(d.QueryFactory,{initialize:function(f,g){this.elementFactory=f;this.tableMod=g},createQuery:function(){var n=this.tableMod;var j=this.elementFactory.createElement();if(!j){return null}var m=n.isDistinct();var o=new e.Query();o.getElements().push(j);var g=n.getColumns();var f={};var l=[];var i=[];_(g).each(function(y){var w=y.getId();var q=c.NodeFactory.createVar(w);var u=new e.ExprVar(q);var p=y.getAggregator();if(p){l.push(w);var x=p.getName();var t=d.ExprModRegistry[x];if(!t){throw"No aggExprFactory for "+x}var s=t.createExpr(u);u=s;o.getProject().add(q,u)}else{i.push(w);o.getProject().add(q)}f[w]=u});if(l.length>0){_(i).each(function(p){var q=f[p];o.getGroupBy().push(q)});m=false}var k=n.getLimitAndOffset();o.setLimit(k.getLimit());o.setOffset(k.getOffset());var h=n.getSortConditions();_(h).each(function(v){var q=v.getColumnId();var u=f[q];if(!u){console.log("[ERROR] Should not happen");throw"Should not happen"}var p=v.getSortDir();var t=v.getSortType();var s=null;switch(t){case"null":if(_(l).indexOf(q)<0){if(p>0){s=new e.SortCondition(new e.E_LogicalNot(new e.E_Bound(u)),1)}else{if(p<0){s=new e.SortCondition(new e.E_Bound(u),1)}}}break;case"data":s=!p?null:new e.SortCondition(u,p);break;default:console.log("Should not happen");throw"Should not happen"}if(s){o.getOrderBy().push(s)}});o.setDistinct(m);return o}});d.FaceteTable=Class.create({initialize:function(){this.varNode=varNode;this.paths=new b.ArrayList();this.tableMod=tableMod},getPaths:function(){return this.paths},getTableMod:function(){return this.tableMod},togglePath:function(h){var f=b.CollectionUtils.toggleItem(this.paths,h);var g=this.varNode.forPath(h);var i=g.getVarName();if(f){this.tableMode.addColumn(i)}else{this.tableMode.removeColumn(i)}}});d.FaceteTableModOld=Class.create({initialize:function(){this.columnIds=[];this.columnIdToPath=new b.HashBidiMap();this.columnIdToData={};this.tableMod=new d.TableMod()},getTableMod:function(){return this.tableMod},createColumnData:function(){var g=this;var f=_(this.columnIds).map(function(i){var h=g.columnIdToData;if(!h){h={};g.columnIdToData[i]=h}return h})},getColumns:function(){var g=this;var f=_(this.columnIds).map(function(i){var h=g.columnIdToData;return h})},putColumn:function(f,g){this.columnIds.push(g);this.columnIdToPath.put(f,g)},removeColumn:function(g){var f=this.tableMod;this.columnIdToPath.remove(g);f.removeColumn(g);b.ArrayUtils.filter(this.columnIds,function(h){return h!=g})},getPaths:function(){var g=this.columnIdToPath.getInverse().keyList();var f=new b.ArrayList();f.setItems(g);return f},togglePath:function(h){var f=this.columnIdToPath.getInverse();var g=f.get(h);if(g){this.removeColumn(g)}else{g="col_"+this.columnIds.length;this.putColumn(g,h)}}})})();(function(){var b=Jassa.util;var c=Jassa.facete;c.FacetTreeTagger=Class.create({initialize:function(d){this.pathTagger=d},applyTags:function(d){c.FacetTreeUtils.applyTags(this.pathTagger,d);return d}});c.FacetTreeUtils={applyTags:function(f,d){var e=b.TreeUtils.flattenTree(d,"children");_(e).each(function(h){var i=h.item.getPath();var g=f.createTags(i);_(h).extend(g)});return d}};c.ItemTagger=Class.create({createTags:function(d){throw"Not overidden"}});c.ItemTaggerManager=Class.create(c.ItemTagger,{initialize:function(){this.taggerMap={}},getTaggerMap:function(){return this.taggerMap},createTags:function(e){var d={};_(this.taggerMap).each(function(h,g){var f=h.createTags(e);d[g]=f});return d}});c.ItemTaggerFilterString=Class.create(c.ItemTagger,{initialize:function(d){this.pathToFilterString=d},createTags:function(f){var e=this.pathToFilterString.get(f);var d={filterString:e};return d}});c.ItemTaggerMembership=Class.create(c.ItemTagger,{initialize:function(d){this.collection=d},createTags:function(e){var f=this.collection.contains(e);var d={isContained:f};return d}});c.ItemTaggerMapLinkPath=Class.create(c.ItemTagger,{initialize:function(d,e){this.mapLinkManager=d;this.conceptSpace=e},createTags:function(e){var d={isActive:isContained};return d}})})();(function(){var b=Jassa.geo;b.BBoxExprFactory=Class.create({createExpr:function(c){throw"Not implemented"}});b.BBoxExprFactoryWgs84=Class.create(b.BBoxExprFactory,{initialize:function(c,e,d){this.xVar=c;this.yVar=e;this.castNode=d},createExpr:function(d){var c=b.GeoExprUtils.createExprWgs84Intersects(this.xVar,this.yVar,d,this.castNode);return c}});b.BBoxExprFactoryWkt=Class.create(b.BBoxExprFactory,{initialize:function(c,e,d){this.wktVar=c;this.intersectsFnName=e;this.geomFromTextFnName=d},createExpr:function(d){var c=b.GeoExprUtils.createExprOgcIntersects(this.wktVar,d,this.intersectsFnName,this.geomFromTextFnName);return c}})})();(function(){var b=Jassa.geo;b.Point=Class.create({initialize:function(c,d){this.x=c;this.y=d},getX:function(){return this.x},getY:function(){return this.y}});b.Bounds=Class.create({initialize:function(f,c,d,e){this.left=f;this.right=d;this.bottom=c;this.top=e},containsPoint:function(c){return c.x>=this.left&&c.x<this.right&&c.y>=this.bottom&&c.y<this.top},getCenter:function(){return new b.Point(0.5*(this.left+this.right),0.5*(this.bottom+this.top))},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},contains:function(c){return c.left>=this.left&&c.right<this.right&&c.bottom>=this.bottom&&c.top<this.top},rangeX:function(){return new b.Range(this.left,this.right)},rangeY:function(){return new b.Range(this.bottom,this.top)},overlap:function(e){if(!e.rangeX||!e.rangeY){console.error("Missing range");throw"Error"}var d=this.rangeX().getOverlap(e.rangeX());if(!d){return null}var c=this.rangeY().getOverlap(e.rangeY());if(!c){return null}return new b.Bounds(d.min,c.min,c.max,d.max)},isOverlap:function(d){var c=this.overlap(d);return c!=null},toString:function(){return"["+this.left+" - "+this.right+", "+this.bottom+" - "+this.top+"]"}});b.Bounds.createFromJson=function(d){var c=new b.Bounds(d.left,d.bottom,d.right,d.top);return c};b.Range=Class.create({initialize:function(d,c){this.min=d;this.max=c},getOverlap:function(d){var e=Math.max(this.min,d.min);var c=Math.min(this.max,d.max);return(e>c)?null:new b.Range(e,c)}});b.QuadTree=Class.create({initialize:function(d,e,c){if(c==undefined){c=0.25}this.node=new b.Node(null,d,e,0,c);this.idToNodes=[]},getRootNode:function(){return this.node},aquireNodes:function(c,d){return this.node.aquireNodes(c,d)},query:function(c,d){return this.node.query(c,d)},insert:function(c){}});b.Node=Class.create({initialize:function(d,e,h,f,c,g){this.parent=d;this.parentChildIndex=g;this._bounds=e;this._maxDepth=h;this._depth=f;this._k=c;this.isLoaded=false;this.children=null;this.data={};this._minItemCount=null;this.infMinItemCount=null;this.idToPos={};this._classConstructor=b.Node},getId:function(){var d=this.parent;var f=d?d.getId():"";var e=this.parentChildIndex!=null?this.parentChildIndex:"r";var c=f+e;return c},isLeaf:function(){return !this.children},addItem:function(d,c){this.idToPos[d]=c},addItems:function(c){var e;for(e in c){var d=c[e];this.addItem(e,d)}},removeItem:function(c){delete this.idToPos[c]},setMinItemCount:function(c){this._minItemCount=c;this.infMinItemCount=c;if(this.parent){this.parent.updateInfMinItemCount()}},getMinItemCount:function(){return this._minItemCount},isCountComplete:function(){if(this.getMinItemCount()!==null){return true}if(this.children){var c=_.reduce(this.children,function(d,e){return d&&e.isCountComplete()},true);return c}return false},updateInfMinItemCount:function(){if(!this.children&&this._minItemCount!==null){return}var c=0;_(this.children).each(function(e,d){if(e._minItemCount!==null){c+=e._minItemCount}else{if(e.infMinItemCount){c+=e.infMinItemCount}}});this.infMinItemCount=c;if(this.parent){this.parent.updateInfMinItemCount()}},getBounds:function(){return this._bounds},getCenter:function(){return this._bounds.getCenter()},subdivide:function(){var f=this._depth+1;var g=this.getCenter();var d=this._k*0.5*this._bounds.getWidth();var e=this._k*0.5*this._bounds.getHeight();this.children=[];this.children[b.Node.TOP_LEFT]=new this._classConstructor(this,new b.Bounds(this._bounds.left,g.y-e,g.x+d,this._bounds.top),this._maxDepth,f,this._k,b.Node.TOP_LEFT);this.children[b.Node.TOP_RIGHT]=new this._classConstructor(this,new b.Bounds(g.x-d,g.y-e,this._bounds.right,this._bounds.top),this._maxDepth,f,this._k,b.Node.TOP_RIGHT);this.children[b.Node.BOTTOM_LEFT]=new this._classConstructor(this,new b.Bounds(this._bounds.left,this._bounds.bottom,g.x+d,g.y+e),this._maxDepth,f,this._k,b.Node.BOTTOM_LEFT);this.children[b.Node.BOTTOM_RIGHT]=new this._classConstructor(this,new b.Bounds(g.x-d,this._bounds.bottom,this._bounds.right,g.y+e),this._maxDepth,f,this._k,b.Node.BOTTOM_RIGHT)},_findIndexPoint:function(d){var c=this.getCenter(bounds);var g=d.x<c.x;var f=d.y>c.y;var e;if(g){if(f){e=Node.TOP_LEFT}else{e=Node.BOTTOM_LEFT}}else{if(f){e=Node.TOP_RIGHT}else{e=Node.BOTTOM_RIGHT}}return e},_findIndex:function(d){var c=new b.Point(d.left,d.top);return this._findIndexPoint(c)},getOverlaps:function(c){},query:function(d,e){var c=[];this.queryRec(d,c);return c},queryRec:function(j,c){if(!this._bounds.isOverlap(j)){return}var d=j.getWidth()/this._bounds.getWidth();var f=j.getHeight()/this._bounds.getHeight();var g=Math.max(d,f);if(this.isLoaded||!this.children||g>=depth){c.push(this);return}for(var e in this.children){var k=this.children[e];k.queryRec(j,depth,c)}},splitFor:function(j,k,c){if(!this._bounds.isOverlap(j)){return}if(this.isLoaded){if(c){c.push(this)}return}var d=j.getWidth()/this._bounds.getWidth();var f=j.getHeight()/this._bounds.getHeight();var g=Math.max(d,f);if(g>=k||this._depth>=this._maxDepth){if(c){c.push(this)}return}if(!this.children){this.subdivide()}for(var e=0;e<this.children.length;++e){var l=this.children[e];l.splitFor(j,k,c)}},aquireNodes:function(d,e){var c=[];this.splitFor(d,e,c);return c},unlink:function(){if(!this.parent){return}var c;for(c in this.parent.children){var d=this.parent.children[c];if(d==this){this.parent.children=new b.Node(this.parent,this._bounds,this._depth,this._k)}}}});b.Node.TOP_LEFT=0;b.Node.TOP_RIGHT=1;b.Node.BOTTOM_LEFT=2;b.Node.BOTTOM_RIGHT=3})();(function(){var b=Jassa.geo;var c=Jassa.sparql;b.GeoExprUtils={createExprWgs84Intersects:function(l,k,d,j){var e=new c.ExprVar(l);var i=new c.ExprVar(k);if(j){e=new c.E_Cast(e,j);i=new c.E_Cast(i,j)}var f=c.NodeValue.makeDecimal(d.left);var h=c.NodeValue.makeDecimal(d.right);var m=c.NodeValue.makeDecimal(d.bottom);var g=c.NodeValue.makeDecimal(d.top);var n=new c.E_LogicalAnd(new c.E_LogicalAnd(new c.E_GreaterThan(e,f),new c.E_LessThan(e,h)),new c.E_LogicalAnd(new c.E_GreaterThan(i,m),new c.E_LessThan(i,g)));return n},createExprOgcIntersects:function(j,d,h,f){var l="http://www.opengis.net/rdf#";h=h||(l+"intersects");f=f||(l+"geomFromText");var e=new c.ExprVar(j);var g=this.boundsToWkt(d);var i=c.NodeValue.makeString(g);var k=new c.E_Function(h,[e,new c.E_Function(f,[i])]);return k},boundsToWkt:function(f){var g=f.left;var e=f.bottom;var i=f.right;var h=f.top;var d="POLYGON(("+g+" "+e+","+i+" "+e+","+i+" "+h+","+g+" "+h+","+g+" "+e+"))";return d}}})();(function(h){var d=Jassa.geo;var c=Jassa.xsd;var g=Jassa.sparql;var i=Jassa.sponate;var f=function(m){var l=m.wkt;var k=d.WktUtils.extractPointsFromWkt(l);var j=d.WktUtils.createBBoxFromPoints(k);return j};var e="(\\d+(\\.\\d*)?)";var b="[^\\d]*";d.pointRegexPattern=new RegExp(b+"("+e+"\\s+"+e+b+")");d.WktUtils={extractPointsFromWkt:function(o){var l=[];var n;while(n=d.pointRegexPattern.exec(o)){var m=n[2];var k=n[4];var j=parseFloat(m);var s=parseFloat(k);var q=new d.Point(j,s);l.push(q);o=o.replace(n[0],"")}return l},createBBoxFromPoints:function(l){var k=null;var o=null;var n=null;var m=null;_(l).each(function(q){var p=q.getX();var s=q.getY();k=!k?p:Math.min(k,p);o=!o?s:Math.min(o,s);n=!n?p:Math.max(n,p);m=!m?s:Math.max(m,s)});var j=new d.Bounds(k,o,n,m);return j}};d.QuadTreeCacheService=Class.create({});d.QuadTreeCache=Class.create({initialize:function(l,k,n,o,m){this.sparqlService=l;var j=new d.Bounds(-180,-90,180,90);this.quadTree=new d.QuadTree(j,18,0);this.concept=n;if(!m){m={}}this.maxItemsPerTileCount=m.maxItemsPerTileCount||25;this.maxGlobalItemCount=m.maxGlobalItemCount||50;this.geoMapFactory=k;this.fnGetBBox=o||f},fetchData:function(k){var j=this.runWorkflow(k);return j},createFlowForBounds:function(l){var k=new i.StoreFacade(this.sparqlService);var j=this.geoMapFactory.createMapForBounds(l);k.addMap(j,"geoMap");return k.geoMap},createFlowForGlobal:function(){var k=new i.StoreFacade(this.sparqlService);var j=this.geoMapFactory.createMapForGlobal();k.addMap(j,"geoMap");return k.geoMap},runCheckGlobal:function(){var j;var m=this.quadTree.getRootNode();var l=this;if(!m.checkedGlobal){var p=this.createFlowForGlobal().find().concept(this.concept).limit(l.maxGlobalItemCount);var o=p.count();var n=o.pipe(function(q){console.debug("Global check counts",q,l.maxGlobalItemCount);var s=!(q>=l.maxGlobalItemCount);m.canUseGlobal=s;m.checkedGlobal=true;return s});j=n}else{var k=h.Deferred();k.resolve(m.canUseGlobal);j=k.promise()}return j},runWorkflow:function(n){var m=h.Deferred();var l=this.quadTree.getRootNode();var k=this;this.runCheckGlobal().pipe(function(p){console.log("Can use global? ",p);var o;if(p){o=k.runGlobalWorkflow(l)}else{o=k.runTiledWorkflow(n)}o.done(function(q){m.resolve(q)}).fail(function(){m.fail()})}).fail(function(){m.fail()});var j=m.promise();return j},runGlobalWorkflow:function(m){var k=this;var l=this.createFlowForGlobal().find().concept(this.concept);var j=l.asList(true).pipe(function(n){k.loadTaskAction(m,n);return[m]});return j},runTiledWorkflow:function(n){var l=this;console.log("Aquiring nodes for "+n);var k=this.quadTree.aquireNodes(n,2);_(k).each(function(p){if(!p.data){p.data={}}});_(k).each(function(p){if(p.isCountComplete()&&p.infMinItemCount===0){p.isLoaded=true}});var m=_(k).filter(function(p){return l.isCountingNeeded(p)});var j=h.Deferred();var o=this.createCountTasks(m);h.when.apply(window,o).done(function(){var q=_(k).filter(function(s){return l.isLoadingNeeded(s)});var p=l.createLoadTasks(q);h.when.apply(window,p).done(function(){h.when(l.postProcess(k)).then(function(){j.resolve(k)})})}).fail(function(){j.fail()});return j},createCountTask:function(n){var l=this;var k=l.maxItemsPerTileCount;var m=this.createFlowForBounds(n.getBounds()).find().concept(this.concept).limit(k);var j=m.count().pipe(function(o){n.setMinItemCount(o);if(o===0){n.isLoaded=true}});return j},isCountingNeeded:function(j){return !(this.isTooManyGeoms(j)||j.isCountComplete())},isLoadingNeeded:function(j){var k=j.isLoaded||(j.isCountComplete()&&j.infMinItemCount===0)||this.isTooManyGeoms(j);return !k},isTooManyGeoms:function(j){return j.infMinItemCount>=this.maxItemsPerTileCount},createCountTasks:function(l){var k=this;var j=_(l).chain().map(function(m){return k.createCountTask(m)}).compact().value();return j},loadTaskAction:function(j,k){j.data.docs=k;j.isLoaded=true},createLoadTasks:function(l){var k=this;var j=[];_(l).each(function(o){var n=k.createFlowForBounds(o.getBounds()).find().concept(k.concept);var m=n.asList(true).pipe(function(p){k.loadTaskAction(o,p)});j.push(m)});return j},finalizeLoading:function(k){var l=[];h.each(k,function(p,s){if(s.parent){l.push(s.parent)}});l=_.uniq(l);var q=false;do{q=false;for(var n in l){var o=l[n];var m=o.children;var j=d.tryMergeNode(o);if(!j){continue}q=true;h.each(m,function(p,t){var s=_.indexOf(k,t);if(s>=0){k[s]=undefined}});k.push(o);if(o.parent){l.push(o.parent)}break}}while(q==true);_.compact(k)},postProcess:function(l){return;var k=this;var j=h.Deferred();var m=_.map(l,function(s){if(!s.data||!s.data.geomToFeatureCount){return}s.data.graph=h.rdf.databank();var p=_.keys(s.data.geomToFeatureCount);var o=_.map(p,function(u){return g.Node.uri(u)});var t=k.geomPosFetcher.fetch(o).pipe(function(u){s.data.geomToPoint=u});var n=s.data.graph;_.each(s.data.geomToFeatureCount,function(w,u){var v=g.Node.uri(u);var z=g.NodeFactory.createTypedLiteralFromString(w,c.xinteger.value);var x=""+v+" "+appvocab.featureCount+" "+z;var y=h.rdf.triple(x);n.add(y)});var q=h.when(t).then(function(){var x=s.data;var w=x.geomToLabel;var v=x.graph;_.each(w,function(y,A){var z=g.Node.uri(A);var D=g.NodeFactory.createPlainLiteral(y.value,y.language);var B=""+z+" "+rdfs.label+" "+D;var C=h.rdf.triple(B);v.add(C)});var u=x.geomToPoint;_.each(u,function(y,E){var D=g.Node.uri(E);var A=g.NodeFactory.createTypedLiteralFromString(y.x,c.xdouble.value);var z=g.NodeFactory.createTypedLiteralFromString(y.y,c.xdouble.value);var C=""+D+" "+geo.lon+" "+A;var B=""+D+" "+geo.lat+" "+z;v.add(C);v.add(B)})});return q});h.when.apply(window,m).then(function(){j.resolve()});return j.promise()}});d.tryMergeNode=function(k){return false;if(!k){return}var l=0;for(var j in k.children){var m=k.children[j];if(!m.isLoaded){return false}l+=m.itemCount}if(l>=self.maxItemsPerTileCount){return false}k.isLoaded=true;for(var j in k.children){var m=k.children[j];mergeMapsInPlace(k.idToPos,m.idToPos);mergeMapsInPlace(k.data.idToLabels,m.data.idToLabels);mergeMapsInPlace(k.data.idToTypes,m.data.idToTypes)}k.children=null;console.log("Merged a node");return true}})(jQuery);(function(){var b=Jassa.geo;b.ViewStateUtils={createStateHash:function(e,d,g){var i=e.getStateHash();var f=JSON.stringify(d);var h=""+g;var c=i+f+h;return c},diffObjects:function(c,g,e){var d=_(c).indexBy(e);var i=_(g).indexBy(e);var k=_(d).keys();var h=_(i).keys();var f=_(k).intersection(h);var j={retained:_(i).chain().pick(f).values().value(),added:_(d).chain().omit(h).values().value(),removed:_(i).chain().omit(k).values().value()};return j},diffViewStates:function(d,f){var h=d.getStateHash();var i=f?f.getStateHash():"";var e=d.getNodes();var j=f?f.getNodes():[];var c;if(h!=i){c={retained:[],added:e,removed:j}}else{var g=function(l){var k=l.getId();return k};c=this.diffObjects(e,j,g)}return c}};b.ViewState=Class.create({initialize:function(e,c,g,f,d){this.sparqlService=e;this.geoMap=c;this.concept=g;this.bounds=f;this.nodes=d},getStateHash:function(){return b.ViewStateUtils.createStateHash(this.sparqlService,this.geoMap,this.concept)},getSparqlService:function(){return this.sparqlService},getGeoMap:function(){return this.geoMap},getNodes:function(){return this.nodes},getBounds:function(){return this.bounds}});b.ViewStateFetcher=Class.create({initialize:function(){this.hashToCache={}},fetchViewState:function(d,g,e,c,i){i=i||{};_(i).defaults(b.ViewStateFetcher.defaultQuadTreeConfig);var l=g.createMapForGlobal();var f=b.ViewStateUtils.createStateHash(d,l,e);var k=this.hashToCache[f];if(!k){k=new b.QuadTreeCache(d,g,e,null,i);this.hashToCache[f]=k}var h=k.fetchData(c);var j=h.pipe(function(m){var n=new b.ViewState(d,l,e,c,m);return n});return j}});b.ViewStateFetcher.defaultQuadTreeConfig={maxItemsPerTileCount:1000,maxGlobalItemCount:5000}})();(function(){var b=Jassa.geo.openlayers;var c=Jassa.geo;b.MapUtils={getExtent:function(h){var f=h.getExtent();var g=f.transform(h.projection,h.displayProjection);var d=new c.Bounds(g.left,g.bottom,g.right,g.top);return d}}})();(function(){var c=jassa.geo;var d=jassa.sparql;var b=jassa.service;c.GeoDataSourceUtils={createGeoDataSourceLabels:function(g,j,i,m){if(m==null){m={}}var k=new b.ListServiceBbox(g,j,i);var e=sponate.LookupServiceUtils.createLookupServiceNodeLabels(g);e=new b.LookupServiceTransform(e,function(p,q){var o={shortLabel:p};return o});var h=new b.AugmenterLookup(e);k=new b.ListServiceAugmenter(k,h);var l=new b.LookupServiceConst(m);var f=new b.AugmenterLookup(l);k=new b.ListServiceAugmenter(k,f);var n=new b.DataServiceBboxCache(k,1500,500,2);return n}}})();(function(){var d=Jassa.rdf;var m=Jassa.sparql;var k=Jassa.sponate;var c=Jassa.facete;var g=Jassa.geo;var l=d.NodeFactory.createVar("s");var h=d.NodeFactory.createVar("x");var e=d.NodeFactory.createVar("y");var j=d.NodeFactory.createVar("w");g.GeoConcepts={conceptWgs84:new c.Concept(m.ElementString.create("?s <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?x ;  <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?y"),l),conceptGeoVocab:new c.Concept(m.ElementString.create("?s <http://www.opengis.net/ont/geosparql#asWKT> ?w"),l)};var i=new k.MapParser();g.GeoMapUtils={wgs84GeoView:i.parseMap({name:"lonlat",template:[{id:g.GeoConcepts.conceptWgs84.getVar(),lon:h,lat:e,wkt:function(o){var n=d.NodeFactory.createTypedLiteralFromString("POINT("+o.get(h).getLiteralValue()+" "+o.get(e).getLiteralValue()+")","http://www.opengis.net/ont/geosparql#wktLiteral");return n}}],from:g.GeoConcepts.conceptWgs84.getElement()}),ogcGeoView:i.parseMap({name:"lonlat",template:[{id:g.GeoConcepts.conceptGeoVocab.getVar(),wkt:j}],from:g.GeoConcepts.conceptGeoVocab.getElement()})};var f="bif:st_intersects";var b="bif:st_geomFromText";g.GeoMapFactoryUtils={wgs84MapFactory:new k.GeoMapFactory(g.GeoMapUtils.wgs84GeoView,new g.BBoxExprFactoryWgs84(h,e)),ogcVirtMapFactory:new k.GeoMapFactory(g.GeoMapUtils.ogcGeoView,new g.BBoxExprFactoryWkt(j,f,b)),createWktMapFactory:function(s,u,q){s=s||"http://www.opengis.net/ont/geosparql#asWKT";u=u||"bif:st_intersects";q=q||"bif:st_geomFromText";var p=d.NodeFactory.createUri(s);var t=new c.Concept(new m.ElementTriplesBlock([new d.Triple(l,p,j)]),l);var o=i.parseMap({name:"geoMap-"+s,template:[{id:t.getVar(),wkt:j}],from:t.getElement()});var n=new k.GeoMapFactory(o,new g.BBoxExprFactoryWkt(j,u,q));return n}}})();